# 摔倒检测机器学习 - 训练与部署完整指南

> **版本**: v1.0
> **创建日期**: 2025-10-03
> **适用对象**: 开发者、数据科学家

---

## 📋 目录

1. [系统概览](#系统概览)
2. [数据采集](#数据采集)
3. [模型训练](#模型训练)
4. [模型导出](#模型导出)
5. [模型部署](#模型部署)
6. [实时检测](#实时检测)
7. [常见问题](#常见问题)

---

## 系统概览

### 整体架构

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  小程序端    │────>│  后端API     │────>│  数据库     │
│ 数据采集     │     │  数据存储    │     │  MySQL      │
└─────────────┘     └─────────────┘     └─────────────┘
       │                                        │
       │                                        ↓
       │                                ┌─────────────┐
       │                                │  训练系统    │
       │                                │  train_model │
       │                                └─────────────┘
       │                                        │
       │                                        ↓
       │                                ┌─────────────┐
       │                                │  模型导出    │
       │                                │ export_model │
       │                                └─────────────┘
       │                                        │
       │                                        ↓
       ↓                                ┌─────────────┐
┌─────────────┐                         │  JSON模型   │
│  ML推理     │<────────────────────────│             │
│  mlModel.js │                         └─────────────┘
└─────────────┘
```

### 技术栈

- **前端**: uni-app (Vue 3)
- **后端**: FastAPI + MySQL
- **机器学习**: scikit-learn (Random Forest)
- **部署**: JavaScript推理引擎

---

## 数据采集

### 1. 启动后端服务

```bash
cd backend
./start.sh
```

服务将在 `http://localhost:8000` 启动。

### 2. 小程序数据采集

#### 模拟摔倒数据
1. 打开小程序"模拟摔倒"页面
2. 点击"开始采集"
3. 进行摔倒模拟动作（30秒）
4. 选择标签：摔倒/正常
5. 点击"上传数据"

#### 正常骑行数据
1. 打开小程序"骑行"页面
2. 点击右上角数据采集图标（确保已开启）
3. 开始骑行
4. 结束骑行后自动上传

### 3. 数据质量要求

| 指标 | 目标值 | 说明 |
|-----|--------|------|
| 摔倒样本 | 100+ | 模拟各种摔倒场景 |
| 正常样本 | 1000+ | 正常骑行数据 |
| 样本长度 | 1500点 (30s×50Hz) | 每个样本约30秒 |
| 数据完整性 | > 99% | 无缺失数据 |

### 4. 查看数据统计

```bash
curl -X GET "http://localhost:8000/api/data/stats" \
  -H "X-API-Key: dev-test-key-2024"
```

---

## 模型训练

### 1. 基础训练（无超参数调优）

```bash
cd backend
python train_model.py
```

**流程**：
1. 从数据库加载所有训练样本
2. 数据清洗（Z-score异常值检测）
3. 滑动窗口特征提取（64维特征）
4. 80/20划分训练集/测试集
5. 训练Random Forest模型
6. 模型评估和交叉验证
7. 保存模型到 `models/` 目录

### 2. 高级训练（超参数调优）

修改 `train_model.py` 中的 `train_pipeline` 函数：

```python
if __name__ == '__main__':
    from database import SessionLocal

    db = SessionLocal()
    try:
        # 启用超参数调优
        results = train_pipeline(db, enable_tuning=True)
        print(json.dumps(results, indent=2, default=str))
    finally:
        db.close()
```

**参数网格**：
- `n_estimators`: [50, 100, 200]
- `max_depth`: [5, 10, 15, None]
- `min_samples_split`: [2, 5, 10]
- `min_samples_leaf`: [1, 2, 4]

### 3. 训练输出示例

```json
{
  "metrics": {
    "accuracy": 0.92,
    "precision": 0.89,
    "recall": 0.95,
    "f1_score": 0.92
  },
  "cv_results": {
    "accuracy_mean": 0.91,
    "accuracy_std": 0.03,
    "f1_mean": 0.90,
    "f1_std": 0.04
  },
  "model_path": "models/fall_detection_model_v1.0_20251003_190000.pkl",
  "train_samples": 8000,
  "test_samples": 2000
}
```

### 4. 模型性能指标

| 指标 | 目标值 | 说明 |
|-----|--------|------|
| 准确率 (Accuracy) | > 90% | 总体预测正确率 |
| 精确率 (Precision) | > 85% | 摔倒预测的准确性 |
| 召回率 (Recall) | > 90% | 摔倒检测的覆盖率 |
| F1分数 | > 88% | 精确率和召回率的调和平均 |

---

## 模型导出

### 1. 导出轻量级模型（推荐）

```bash
cd backend
python export_model.py models/fall_detection_model_v1.0.pkl
```

**自动优化**：
- 目标大小：< 500KB
- 自动调整树的数量
- 保持预测性能

### 2. 导出完整模型

```bash
python export_model.py models/fall_detection_model_v1.0.pkl --full
```

### 3. 指定输出路径

```bash
python export_model.py \
  models/fall_detection_model_v1.0.pkl \
  static/models/fall_detection_model.json
```

### 4. 导出结果

```json
{
  "path": "models/fall_detection_model_20251003_190000.json",
  "size_mb": 0.45,
  "checksum": "a3f5e8d9c2b1f4a6",
  "n_trees": 85
}
```

### 5. 模型JSON结构

```json
{
  "model_type": "random_forest",
  "version": "1.0",
  "metadata": {
    "n_trees": 85,
    "n_features": 64,
    "n_classes": 2,
    "class_names": ["normal", "fall"]
  },
  "feature_config": {
    "window_size": 100,
    "overlap": 50,
    "sampling_rate": 50
  },
  "trees": [...]
}
```

---

## 模型部署

### 1. 复制模型文件

将导出的JSON模型文件复制到小程序静态资源目录：

```bash
cp models/fall_detection_model_*.json \
   ../static/models/fall_detection_model.json
```

### 2. 小程序端加载模型

模型会在骑行页面自动加载：

```javascript
// 在 pages/riding/riding.vue 中
onLoad(() => {
  // 初始化ML检测器
  initMLDetector().catch(err => {
    console.error('ML检测器初始化失败:', err);
  });
});
```

### 3. 验证模型加载

打开小程序控制台，查看日志：

```
ML模型加载成功: {n_trees: 85, n_features: 64, ...}
```

### 4. 性能指标

| 指标 | 目标值 | 实际值 |
|-----|--------|--------|
| 模型大小 | < 500KB | ~450KB |
| 加载时间 | < 2s | ~1s |
| 推理延迟 | < 100ms | ~50ms |

---

## 实时检测

### 1. ML检测流程

```
传感器数据采集 (50Hz)
        ↓
数据缓冲 (150000点)
        ↓
每50个点触发一次检测
        ↓
滑动窗口 (100点)
        ↓
特征提取 (64维)
        ↓
Random Forest推理
        ↓
摔倒预测 (class, confidence)
        ↓
置信度 > 0.7 → 触发警报
```

### 2. 双重检测机制

系统同时运行两种摔倒检测：

1. **传感器阈值检测**（实时）
   - 基于加速度阈值
   - 响应速度快（<100ms）
   - 可能有误报

2. **ML模型检测**（准实时）
   - 基于机器学习
   - 准确率高（>90%）
   - 延迟稍高（~500ms）

### 3. 警报触发

当检测到摔倒时：
1. 震动警告（`uni.vibrateLong()`）
2. 显示弹窗（30秒倒计时）
3. 用户可确认"我没事"或"需要帮助"
4. 记录检测日志

### 4. 检测参数调优

修改 `mlModel.js` 中的置信度阈值：

```javascript
// 当前阈值：0.7
if (prediction.class === 1 && prediction.confidence > 0.7) {
  console.warn('ML检测到摔倒！', prediction);
  handleMLFallDetected(prediction);
}

// 调整建议：
// - 提高阈值（0.8）：减少误报，可能漏检
// - 降低阈值（0.6）：提高检出率，可能误报
```

---

## 常见问题

### Q1: 训练时提示"数据库中没有训练样本"？

**解决方案**：
1. 确认后端服务正在运行
2. 使用小程序采集数据
3. 检查数据库连接：`mysql -u root -p fall_detection`
4. 查询样本数量：`SELECT COUNT(*) FROM training_samples;`

### Q2: 模型准确率低于90%怎么办？

**解决方案**：
1. **增加样本数量**：至少1000个样本
2. **平衡数据集**：摔倒/正常比例 ≈ 1:10
3. **启用超参数调优**：`enable_tuning=True`
4. **检查数据质量**：清除异常样本
5. **调整特征工程**：增加或减少特征

### Q3: 模型文件太大（>500KB）？

**解决方案**：
1. 使用轻量级导出（默认）
2. 减少树的数量：`max_trees=50`
3. 压缩模型JSON（去除空格）
4. 考虑使用模型压缩技术

### Q4: 小程序ML检测不工作？

**排查步骤**：
1. 检查模型文件是否存在：`static/models/fall_detection_model.json`
2. 查看控制台是否有加载错误
3. 确认数据采集已启用
4. 检查数据点是否足够（>100点）

### Q5: 推理速度太慢？

**优化方案**：
1. 减少树的数量（50-100棵）
2. 降低检测频率（每100个点检测一次）
3. 简化特征提取（只保留关键特征）
4. 使用Web Worker（如果支持）

### Q6: 如何更新模型？

**步骤**：
1. 采集更多数据
2. 重新训练模型
3. 导出新模型JSON
4. 替换小程序中的模型文件
5. 重新编译和发布小程序

### Q7: 如何评估模型性能？

**方法**：
1. **离线评估**：
   - 准确率、精确率、召回率、F1分数
   - 混淆矩阵分析
   - 交叉验证结果

2. **在线评估**：
   - 用户反馈统计
   - 误报率监控
   - 检出率跟踪

3. **A/B测试**：
   - 对比不同模型版本
   - 收集用户满意度

---

## 🚀 快速开始检查清单

- [ ] 后端服务已启动（`./start.sh`）
- [ ] 采集了足够数据（100+摔倒，1000+正常）
- [ ] 训练了模型（`python train_model.py`）
- [ ] 模型性能达标（准确率>90%）
- [ ] 导出了JSON模型（`python export_model.py`）
- [ ] 模型已部署到小程序（复制JSON文件）
- [ ] ML检测正常工作（查看控制台日志）
- [ ] 测试摔倒检测功能

---

## 📚 相关文档

- [train-construction-progress.md](./train-construction-progress.md) - 构建进度追踪
- [使用说明-数据采集.md](./使用说明-数据采集.md) - 数据采集指南
- [00-系统架构说明.md](./00-系统架构说明.md) - 系统架构设计
- [05-模型训练详解.md](./05-模型训练详解.md) - 模型训练详细说明

---

## 📞 技术支持

如有问题或建议，请联系：
- GitHub Issues: [项目地址]
- 邮箱: [联系邮箱]

---

**最后更新**: 2025-10-03
**文档版本**: v1.0

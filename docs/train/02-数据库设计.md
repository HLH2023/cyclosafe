# MySQL 数据库设计文档

## 数据库概述

**数据库名称:** `fall_detection_training`

**字符集:** `utf8mb4`

**排序规则:** `utf8mb4_unicode_ci`

**存储引擎:** InnoDB

---

## 表结构设计

### 1. training_samples（训练样本表）

**功能说明:** 存储每次上传的训练样本元数据

**表结构:**

```sql
CREATE TABLE training_samples (
    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '样本ID',
    user_id VARCHAR(64) NOT NULL COMMENT '用户ID（匿名）',
    label ENUM('fall', 'normal') NOT NULL COMMENT '标注：摔倒/正常',
    source ENUM('simulate', 'riding') NOT NULL COMMENT '数据来源：模拟/骑行',
    duration INT UNSIGNED NOT NULL COMMENT '采集时长（毫秒）',
    sample_count INT UNSIGNED NOT NULL COMMENT '数据点数量',
    uploaded_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '上传时间',
    processed BOOLEAN DEFAULT FALSE COMMENT '是否已处理（特征提取）',
    metadata JSON DEFAULT NULL COMMENT '元数据（设备信息等）',

    INDEX idx_label (label),
    INDEX idx_source (source),
    INDEX idx_uploaded (uploaded_at),
    INDEX idx_processed (processed),
    INDEX idx_user (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='训练样本元数据表';
```

**字段说明:**

| 字段 | 类型 | 空值 | 默认值 | 说明 |
|-----|------|------|--------|-----|
| id | INT UNSIGNED | NO | AUTO_INCREMENT | 主键，自增ID |
| user_id | VARCHAR(64) | NO | - | 匿名用户ID |
| label | ENUM | NO | - | 标注（fall/normal） |
| source | ENUM | NO | - | 数据来源（simulate/riding） |
| duration | INT UNSIGNED | NO | - | 采集时长（ms） |
| sample_count | INT UNSIGNED | NO | - | 传感器数据点数量 |
| uploaded_at | DATETIME | NO | CURRENT_TIMESTAMP | 上传时间 |
| processed | BOOLEAN | NO | FALSE | 是否已提取特征 |
| metadata | JSON | YES | NULL | 额外元数据（JSON格式） |

**索引说明:**
- `PRIMARY KEY (id)`: 主键索引
- `idx_label`: 按标注查询
- `idx_source`: 按来源查询
- `idx_uploaded`: 按时间范围查询
- `idx_processed`: 查询未处理的样本
- `idx_user`: 按用户查询

**示例数据:**
```sql
INSERT INTO training_samples (user_id, label, source, duration, sample_count, metadata) VALUES
('user_anonymous_123', 'fall', 'simulate', 30000, 1500, '{"device": "iPhone 12", "os": "iOS 15.0"}'),
('user_anonymous_456', 'normal', 'riding', 120000, 6000, '{"device": "Xiaomi 11", "os": "Android 12"}');
```

---

### 2. sensor_data（传感器数据表）

**功能说明:** 存储每个样本的详细传感器数据（时间序列）

**表结构:**

```sql
CREATE TABLE sensor_data (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '数据ID',
    sample_id INT UNSIGNED NOT NULL COMMENT '所属样本ID',
    timestamp BIGINT NOT NULL COMMENT 'Unix时间戳（毫秒）',
    acc_x FLOAT NOT NULL COMMENT 'X轴加速度（m/s²）',
    acc_y FLOAT NOT NULL COMMENT 'Y轴加速度（m/s²）',
    acc_z FLOAT NOT NULL COMMENT 'Z轴加速度（m/s²）',
    gyro_x FLOAT NOT NULL COMMENT 'X轴角速度（°/s）',
    gyro_y FLOAT NOT NULL COMMENT 'Y轴角速度（°/s）',
    gyro_z FLOAT NOT NULL COMMENT 'Z轴角速度（°/s）',

    FOREIGN KEY (sample_id) REFERENCES training_samples(id) ON DELETE CASCADE,
    INDEX idx_sample (sample_id),
    INDEX idx_timestamp (timestamp)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='传感器原始数据表';
```

**字段说明:**

| 字段 | 类型 | 空值 | 默认值 | 说明 |
|-----|------|------|--------|-----|
| id | BIGINT UNSIGNED | NO | AUTO_INCREMENT | 主键，自增ID |
| sample_id | INT UNSIGNED | NO | - | 外键，关联 training_samples.id |
| timestamp | BIGINT | NO | - | Unix时间戳（毫秒） |
| acc_x | FLOAT | NO | - | X轴加速度（m/s²） |
| acc_y | FLOAT | NO | - | Y轴加速度（m/s²） |
| acc_z | FLOAT | NO | - | Z轴加速度（m/s²） |
| gyro_x | FLOAT | NO | - | X轴角速度（°/s） |
| gyro_y | FLOAT | NO | - | Y轴角速度（°/s） |
| gyro_z | FLOAT | NO | - | Z轴角速度（°/s） |

**外键约束:**
- `sample_id` 关联 `training_samples(id)`
- `ON DELETE CASCADE`: 删除样本时级联删除所有传感器数据

**索引说明:**
- `PRIMARY KEY (id)`: 主键索引
- `idx_sample`: 按样本ID查询（关联查询优化）
- `idx_timestamp`: 按时间戳排序查询

**示例数据:**
```sql
INSERT INTO sensor_data (sample_id, timestamp, acc_x, acc_y, acc_z, gyro_x, gyro_y, gyro_z) VALUES
(1, 1696234567890, 0.52, 0.31, 9.75, 12.5, -6.2, 0.8),
(1, 1696234567910, 0.55, 0.28, 9.82, 11.8, -5.9, 0.7),
(1, 1696234567930, 0.48, 0.35, 9.68, 13.2, -6.5, 0.9);
```

**存储估算:**
- 每条记录约：8 + 4 + 8 + (4×6) = 44 字节
- 1000个样本，每样本1500条数据：1000 × 1500 × 44 ≈ 63 MB

---

### 3. training_jobs（训练任务表）

**功能说明:** 记录所有模型训练任务及其结果

**表结构:**

```sql
CREATE TABLE training_jobs (
    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '任务ID',
    status ENUM('pending', 'running', 'completed', 'failed') DEFAULT 'pending' COMMENT '任务状态',
    algorithm VARCHAR(64) NOT NULL COMMENT '算法名称（random_forest/xgboost/svm）',
    train_samples INT UNSIGNED DEFAULT NULL COMMENT '训练样本数',
    val_samples INT UNSIGNED DEFAULT NULL COMMENT '验证样本数',
    test_samples INT UNSIGNED DEFAULT NULL COMMENT '测试样本数',

    -- 评估指标
    accuracy FLOAT DEFAULT NULL COMMENT '准确率',
    precision_val FLOAT DEFAULT NULL COMMENT '精确率',
    recall_val FLOAT DEFAULT NULL COMMENT '召回率',
    f1_score FLOAT DEFAULT NULL COMMENT 'F1分数',
    auc_roc FLOAT DEFAULT NULL COMMENT 'AUC-ROC',

    -- 混淆矩阵
    true_positives INT UNSIGNED DEFAULT NULL COMMENT '真正例（TP）',
    true_negatives INT UNSIGNED DEFAULT NULL COMMENT '真负例（TN）',
    false_positives INT UNSIGNED DEFAULT NULL COMMENT '假正例（FP）',
    false_negatives INT UNSIGNED DEFAULT NULL COMMENT '假负例（FN）',

    -- 文件路径
    model_path VARCHAR(255) DEFAULT NULL COMMENT '模型文件路径',
    tfjs_model_path VARCHAR(255) DEFAULT NULL COMMENT 'TensorFlow.js模型路径',

    -- 配置和日志
    config JSON DEFAULT NULL COMMENT '训练配置（超参数等）',
    error_message TEXT DEFAULT NULL COMMENT '错误信息（失败时）',
    log_file VARCHAR(255) DEFAULT NULL COMMENT '日志文件路径',

    -- 时间戳
    started_at DATETIME DEFAULT NULL COMMENT '开始时间',
    completed_at DATETIME DEFAULT NULL COMMENT '完成时间',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',

    INDEX idx_status (status),
    INDEX idx_created (created_at),
    INDEX idx_algorithm (algorithm)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='训练任务记录表';
```

**字段说明:**

| 字段 | 类型 | 空值 | 默认值 | 说明 |
|-----|------|------|--------|-----|
| id | INT UNSIGNED | NO | AUTO_INCREMENT | 主键，任务ID |
| status | ENUM | NO | 'pending' | 任务状态 |
| algorithm | VARCHAR(64) | NO | - | 算法名称 |
| train_samples | INT UNSIGNED | YES | NULL | 训练样本数 |
| val_samples | INT UNSIGNED | YES | NULL | 验证样本数 |
| test_samples | INT UNSIGNED | YES | NULL | 测试样本数 |
| accuracy | FLOAT | YES | NULL | 准确率 (0-1) |
| precision_val | FLOAT | YES | NULL | 精确率 (0-1) |
| recall_val | FLOAT | YES | NULL | 召回率 (0-1) |
| f1_score | FLOAT | YES | NULL | F1分数 (0-1) |
| auc_roc | FLOAT | YES | NULL | AUC-ROC (0-1) |
| true_positives | INT UNSIGNED | YES | NULL | 真正例数量 |
| true_negatives | INT UNSIGNED | YES | NULL | 真负例数量 |
| false_positives | INT UNSIGNED | YES | NULL | 假正例数量 |
| false_negatives | INT UNSIGNED | YES | NULL | 假负例数量 |
| model_path | VARCHAR(255) | YES | NULL | 模型文件路径 |
| tfjs_model_path | VARCHAR(255) | YES | NULL | TensorFlow.js模型路径 |
| config | JSON | YES | NULL | 训练配置（JSON） |
| error_message | TEXT | YES | NULL | 错误信息 |
| log_file | VARCHAR(255) | YES | NULL | 日志文件路径 |
| started_at | DATETIME | YES | NULL | 开始时间 |
| completed_at | DATETIME | YES | NULL | 完成时间 |
| created_at | DATETIME | NO | CURRENT_TIMESTAMP | 创建时间 |

**索引说明:**
- `PRIMARY KEY (id)`: 主键索引
- `idx_status`: 按状态查询（查询进行中的任务）
- `idx_created`: 按创建时间排序
- `idx_algorithm`: 按算法分组统计

**示例数据:**
```sql
INSERT INTO training_jobs (
    status, algorithm, train_samples, val_samples, test_samples,
    accuracy, precision_val, recall_val, f1_score,
    true_positives, true_negatives, false_positives, false_negatives,
    model_path, config, started_at, completed_at
) VALUES (
    'completed',
    'random_forest',
    1050, 263, 263,
    0.923, 0.885, 0.912, 0.898,
    120, 155, 15, 10,
    '/models/fall_detection_v1.pkl',
    '{"n_estimators": 100, "max_depth": 20}',
    '2025-10-02 15:00:00',
    '2025-10-02 15:04:32'
);
```

---

### 4. model_versions（模型版本表）

**功能说明:** 记录所有发布的模型版本

**表结构:**

```sql
CREATE TABLE model_versions (
    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY COMMENT '版本ID',
    version VARCHAR(32) NOT NULL UNIQUE COMMENT '版本号（如v1.0.0）',
    job_id INT UNSIGNED NOT NULL COMMENT '关联的训练任务ID',
    algorithm VARCHAR(64) NOT NULL COMMENT '算法名称',

    -- 模型文件
    model_url VARCHAR(512) NOT NULL COMMENT 'TensorFlow.js模型URL',
    model_size_mb FLOAT NOT NULL COMMENT '模型大小（MB）',
    checksum VARCHAR(64) NOT NULL COMMENT 'SHA256校验和',

    -- 性能指标
    accuracy FLOAT NOT NULL COMMENT '准确率',
    f1_score FLOAT NOT NULL COMMENT 'F1分数',

    -- 状态
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否激活（当前使用版本）',
    download_count INT UNSIGNED DEFAULT 0 COMMENT '下载次数',

    -- 时间
    deployed_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '部署时间',

    FOREIGN KEY (job_id) REFERENCES training_jobs(id),
    INDEX idx_version (version),
    INDEX idx_active (is_active),
    INDEX idx_deployed (deployed_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='模型版本记录表';
```

**示例数据:**
```sql
INSERT INTO model_versions (
    version, job_id, algorithm, model_url, model_size_mb, checksum,
    accuracy, f1_score, is_active
) VALUES (
    'v1.0.0', 789, 'random_forest',
    'https://cdn.example.com/models/v1.0.0/model.json',
    1.8, 'sha256:abc123...',
    0.923, 0.898, TRUE
);
```

---

## 完整建表SQL

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS fall_detection_training
    DEFAULT CHARACTER SET utf8mb4
    COLLATE utf8mb4_unicode_ci;

USE fall_detection_training;

-- 1. 训练样本表
CREATE TABLE training_samples (
    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id VARCHAR(64) NOT NULL,
    label ENUM('fall', 'normal') NOT NULL,
    source ENUM('simulate', 'riding') NOT NULL,
    duration INT UNSIGNED NOT NULL,
    sample_count INT UNSIGNED NOT NULL,
    uploaded_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    processed BOOLEAN DEFAULT FALSE,
    metadata JSON DEFAULT NULL,
    INDEX idx_label (label),
    INDEX idx_source (source),
    INDEX idx_uploaded (uploaded_at),
    INDEX idx_processed (processed),
    INDEX idx_user (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 2. 传感器数据表
CREATE TABLE sensor_data (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    sample_id INT UNSIGNED NOT NULL,
    timestamp BIGINT NOT NULL,
    acc_x FLOAT NOT NULL,
    acc_y FLOAT NOT NULL,
    acc_z FLOAT NOT NULL,
    gyro_x FLOAT NOT NULL,
    gyro_y FLOAT NOT NULL,
    gyro_z FLOAT NOT NULL,
    FOREIGN KEY (sample_id) REFERENCES training_samples(id) ON DELETE CASCADE,
    INDEX idx_sample (sample_id),
    INDEX idx_timestamp (timestamp)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 3. 训练任务表
CREATE TABLE training_jobs (
    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    status ENUM('pending', 'running', 'completed', 'failed') DEFAULT 'pending',
    algorithm VARCHAR(64) NOT NULL,
    train_samples INT UNSIGNED DEFAULT NULL,
    val_samples INT UNSIGNED DEFAULT NULL,
    test_samples INT UNSIGNED DEFAULT NULL,
    accuracy FLOAT DEFAULT NULL,
    precision_val FLOAT DEFAULT NULL,
    recall_val FLOAT DEFAULT NULL,
    f1_score FLOAT DEFAULT NULL,
    auc_roc FLOAT DEFAULT NULL,
    true_positives INT UNSIGNED DEFAULT NULL,
    true_negatives INT UNSIGNED DEFAULT NULL,
    false_positives INT UNSIGNED DEFAULT NULL,
    false_negatives INT UNSIGNED DEFAULT NULL,
    model_path VARCHAR(255) DEFAULT NULL,
    tfjs_model_path VARCHAR(255) DEFAULT NULL,
    config JSON DEFAULT NULL,
    error_message TEXT DEFAULT NULL,
    log_file VARCHAR(255) DEFAULT NULL,
    started_at DATETIME DEFAULT NULL,
    completed_at DATETIME DEFAULT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_status (status),
    INDEX idx_created (created_at),
    INDEX idx_algorithm (algorithm)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 4. 模型版本表
CREATE TABLE model_versions (
    id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    version VARCHAR(32) NOT NULL UNIQUE,
    job_id INT UNSIGNED NOT NULL,
    algorithm VARCHAR(64) NOT NULL,
    model_url VARCHAR(512) NOT NULL,
    model_size_mb FLOAT NOT NULL,
    checksum VARCHAR(64) NOT NULL,
    accuracy FLOAT NOT NULL,
    f1_score FLOAT NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    download_count INT UNSIGNED DEFAULT 0,
    deployed_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (job_id) REFERENCES training_jobs(id),
    INDEX idx_version (version),
    INDEX idx_active (is_active),
    INDEX idx_deployed (deployed_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

## 常用查询SQL

### 统计查询

```sql
-- 1. 获取数据统计
SELECT
    COUNT(*) as total_samples,
    SUM(CASE WHEN label = 'fall' THEN 1 ELSE 0 END) as fall_samples,
    SUM(CASE WHEN label = 'normal' THEN 1 ELSE 0 END) as normal_samples,
    SUM(sample_count) as total_data_points
FROM training_samples;

-- 2. 按来源统计
SELECT
    source,
    COUNT(*) as count,
    SUM(sample_count) as total_points
FROM training_samples
GROUP BY source;

-- 3. 按日期统计
SELECT
    DATE(uploaded_at) as date,
    COUNT(*) as count
FROM training_samples
GROUP BY DATE(uploaded_at)
ORDER BY date DESC;
```

### 数据查询

```sql
-- 4. 查询最近10个样本
SELECT
    id, user_id, label, source, sample_count, uploaded_at
FROM training_samples
ORDER BY uploaded_at DESC
LIMIT 10;

-- 5. 查询特定样本的传感器数据
SELECT
    timestamp, acc_x, acc_y, acc_z, gyro_x, gyro_y, gyro_z
FROM sensor_data
WHERE sample_id = 12345
ORDER BY timestamp ASC;

-- 6. 查询未处理的样本
SELECT id, label, source, sample_count
FROM training_samples
WHERE processed = FALSE
ORDER BY uploaded_at ASC;
```

### 训练任务查询

```sql
-- 7. 获取最新完成的训练任务
SELECT
    id, algorithm, accuracy, f1_score, completed_at
FROM training_jobs
WHERE status = 'completed'
ORDER BY completed_at DESC
LIMIT 1;

-- 8. 训练任务统计
SELECT
    algorithm,
    COUNT(*) as total_jobs,
    AVG(accuracy) as avg_accuracy,
    MAX(accuracy) as best_accuracy
FROM training_jobs
WHERE status = 'completed'
GROUP BY algorithm;
```

---

## 数据维护

### 定期清理

```sql
-- 删除30天前的测试数据（可选）
DELETE FROM training_samples
WHERE source = 'simulate'
  AND uploaded_at < DATE_SUB(NOW(), INTERVAL 30 DAY);

-- 删除失败的训练任务（保留日志）
DELETE FROM training_jobs
WHERE status = 'failed'
  AND created_at < DATE_SUB(NOW(), INTERVAL 7 DAY);
```

### 数据备份

```bash
# 备份整个数据库
mysqldump -u root -p fall_detection_training > backup_$(date +%Y%m%d).sql

# 只备份表结构
mysqldump -u root -p --no-data fall_detection_training > schema_backup.sql

# 只备份数据
mysqldump -u root -p --no-create-info fall_detection_training > data_backup.sql
```

---

## 性能优化建议

### 索引优化
- ✅ 为常用查询字段建立索引
- ✅ 使用组合索引（如 `idx_label_source`）
- ✅ 定期分析和优化索引：`ANALYZE TABLE training_samples;`

### 查询优化
- ✅ 使用 `EXPLAIN` 分析查询计划
- ✅ 避免 `SELECT *`，只查询需要的字段
- ✅ 分页查询使用 `LIMIT offset, count`

### 分区表（可选）
```sql
-- 按月份分区 sensor_data 表
ALTER TABLE sensor_data
PARTITION BY RANGE (YEAR(FROM_UNIXTIME(timestamp/1000))) (
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p2026 VALUES LESS THAN (2027),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

---

## 监控指标

### 表大小监控
```sql
SELECT
    table_name,
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS size_mb
FROM information_schema.TABLES
WHERE table_schema = 'fall_detection_training'
ORDER BY (data_length + index_length) DESC;
```

### 慢查询监控
```sql
-- 开启慢查询日志
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 2; -- 超过2秒的查询
```

---

## 版本历史

### v1.0.0 (2025-10-02)
- ✅ 完成所有表结构设计
- ✅ 定义索引和外键
- ✅ 提供完整SQL脚本

---

## 相关文档

- [00-系统架构说明.md](./00-系统架构说明.md)
- [01-后端API设计.md](./01-后端API设计.md)
- [03-小程序数据采集.md](./03-小程序数据采集.md)

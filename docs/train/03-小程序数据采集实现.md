# 小程序数据采集实现文档

## 概述

本文档详细说明如何在微信小程序中实现数据采集功能，包括：
1. DataCollector（数据收集器）实现
2. 模拟摔倒页面实现
3. 骑行页面数据采集改进
4. 数据上传功能

---

## 1. DataCollector 数据收集器

### 1.1 功能说明

DataCollector 是一个独立的JavaScript类，负责：
- 实时采集加速度计和陀螺仪数据
- 维护数据缓冲区
- 数据标注和打包
- 上传数据到后端

### 1.2 完整代码

**文件路径:** `/utils/dataCollector.js`

> ⚠️ 提示：API 基础地址统一在 `utils/config.js` 中通过 `API_BASE_URL` 配置（按 `devConfig` / `prodConfig` 区分环境）。

```javascript
/**
 * 数据采集器 - 用于收集传感器数据并上传到训练服务器
 * 支持：加速度计、陀螺仪数据采集
 * 功能：滑动窗口缓冲、数据上传、匿名用户ID管理
 */

import config from './config.js';

const API_BASE_URL = config.API_BASE_URL;

class DataCollector {
  constructor() {
    // 数据缓冲区
    this.buffer = [];

    // 采集状态
    this.isCollecting = false;

    // 开始时间
    this.startTime = 0;

    // 最大缓冲区大小（30秒 × 50Hz = 1500）
    this.maxBufferSize = 1500;

    // 用户ID（匿名）
    this.userId = this.getUserId();
  }

  /**
   * 获取匿名用户ID
   */
  getUserId() {
    let userId = uni.getStorageSync('anonymous_user_id');
    if (!userId) {
      userId = 'user_' + this.generateRandomId();
      uni.setStorageSync('anonymous_user_id', userId);
    }
    return userId;
  }

  /**
   * 生成随机ID
   */
  generateRandomId() {
    return Date.now().toString(36) + Math.random().toString(36).substring(2);
  }

  /**
   * 开始采集
   */
  startCollection() {
    if (this.isCollecting) {
      console.warn('[DataCollector] 已在采集中');
      return;
    }

    console.log('[DataCollector] 开始采集数据');
    this.isCollecting = true;
    this.startTime = Date.now();
    this.buffer = [];

    // 启动传感器
    this.startSensors();
  }

  /**
   * 停止采集
   */
  stopCollection() {
    if (!this.isCollecting) {
      return;
    }

    console.log('[DataCollector] 停止采集数据');
    this.isCollecting = false;

    // 停止传感器
    this.stopSensors();

    return {
      duration: Date.now() - this.startTime,
      sampleCount: this.buffer.length
    };
  }

  /**
   * 启动传感器监听
   */
  startSensors() {
    // 启动加速度计
    uni.startAccelerometer({
      interval: 'game', // 20ms/次
      success: () => {
        console.log('[DataCollector] 加速度计已启动');

        uni.onAccelerometerChange((res) => {
          if (this.isCollecting) {
            this.currentAcc = {
              x: res.x,
              y: res.y,
              z: res.z
            };
            this.tryAddSample();
          }
        });
      },
      fail: (err) => {
        console.error('[DataCollector] 加速度计启动失败', err);
      }
    });

    // 启动陀螺仪
    uni.startGyroscope({
      interval: 'game',
      success: () => {
        console.log('[DataCollector] 陀螺仪已启动');

        uni.onGyroscopeChange((res) => {
          if (this.isCollecting) {
            this.currentGyro = {
              x: res.x,
              y: res.y,
              z: res.z
            };
            this.tryAddSample();
          }
        });
      },
      fail: (err) => {
        console.error('[DataCollector] 陀螺仪启动失败', err);
      }
    });
  }

  /**
   * 停止传感器监听
   */
  stopSensors() {
    uni.stopAccelerometer();
    uni.stopGyroscope();
    this.currentAcc = null;
    this.currentGyro = null;
  }

  /**
   * 尝试添加样本（需要加速度计和陀螺仪数据都准备好）
   */
  tryAddSample() {
    if (!this.currentAcc || !this.currentGyro) {
      return; // 数据未就绪
    }

    const sample = {
      timestamp: Date.now(),
      acc: { ...this.currentAcc },
      gyro: { ...this.currentGyro }
    };

    this.buffer.push(sample);

    // 限制缓冲区大小
    if (this.buffer.length > this.maxBufferSize) {
      this.buffer.shift();
    }
  }

  /**
   * 获取收集的数据
   */
  getData(label, source) {
    const duration = Date.now() - this.startTime;

    return {
      user_id: this.userId,
      label: label, // 'fall' 或 'normal'
      source: source, // 'simulate' 或 'riding'
      duration: duration,
      samples: this.buffer,
      metadata: {
        device: this.getDeviceInfo(),
        app_version: '1.0.0'
      }
    };
  }

  /**
   * 获取设备信息
   */
  getDeviceInfo() {
    try {
      const systemInfo = uni.getSystemInfoSync();
      return `${systemInfo.brand} ${systemInfo.model}`;
    } catch (e) {
      return 'Unknown';
    }
  }

  /**
   * 上传数据到后端
   */
  async uploadData(label, source) {
    const data = this.getData(label, source);

    console.log('[DataCollector] 准备上传数据:', {
      label,
      source,
      sampleCount: data.samples.length
    });

    try {
      const response = await uni.request({
        url: `${API_BASE_URL}/upload/training-data`,
        method: 'POST',
        data: data,
        header: {
          'Content-Type': 'application/json'
        },
        timeout: 30000 // 30秒超时
      });

      if (response.statusCode === 200 && response.data.success) {
        console.log('[DataCollector] 上传成功', response.data);
        return {
          success: true,
          sampleId: response.data.data.sample_id
        };
      } else {
        console.error('[DataCollector] 上传失败', response);
        return {
          success: false,
          error: response.data.message || '上传失败'
        };
      }
    } catch (err) {
      console.error('[DataCollector] 上传异常', err);
      return {
        success: false,
        error: err.errMsg || '网络异常'
      };
    }
  }

  /**
   * 清空缓冲区
   */
  clear() {
    this.buffer = [];
    this.startTime = 0;
  }

  /**
   * 获取当前状态
   */
  getStatus() {
    return {
      isCollecting: this.isCollecting,
      sampleCount: this.buffer.length,
      duration: this.isCollecting ? Date.now() - this.startTime : 0
    };
  }
}

// 导出单例
const dataCollector = new DataCollector();

export default dataCollector;

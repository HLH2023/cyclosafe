# 摔倒检测机器学习训练系统架构

## 系统概述

本系统是一个完整的端到端机器学习训练平台，用于收集骑行数据、训练摔倒检测模型，并将模型部署到微信小程序中。

---

## 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      微信小程序端                             │
│  ┌──────────────────┐        ┌──────────────────┐          │
│  │  模拟摔倒页面      │        │   骑行页面        │          │
│  │  - 30秒数据采集    │        │  - 后台数据采集   │          │
│  │  - 手动标注        │        │  - 结束询问上传   │          │
│  │  - 上传训练数据    │        │  - 默认正常标注   │          │
│  └──────────────────┘        └──────────────────┘          │
│           ↓                            ↓                     │
│  ┌──────────────────────────────────────────────┐          │
│  │         DataCollector (数据收集器)             │          │
│  │  - 实时采集加速度计/陀螺仪数据                  │          │
│  │  - 缓存数据（滑动窗口）                        │          │
│  │  - 数据标注和打包                              │          │
│  └──────────────────────────────────────────────┘          │
└─────────────────────────────────────────────────────────────┘
                          ↓ HTTP POST
┌─────────────────────────────────────────────────────────────┐
│                    FastAPI 后端服务器                         │
│  ┌──────────────────────────────────────────────┐          │
│  │            API 接口层 (main.py)               │          │
│  │  - POST /api/upload/training-data            │          │
│  │  - GET  /api/data/stats                      │          │
│  │  - POST /api/training/start                  │          │
│  │  - GET  /api/model/download                  │          │
│  └──────────────────────────────────────────────┘          │
│                          ↓                                   │
│  ┌──────────────────────────────────────────────┐          │
│  │         业务逻辑层 (api/upload.py)             │          │
│  │  - 数据验证                                    │          │
│  │  - 数据预处理                                  │          │
│  │  - 数据存储                                    │          │
│  └──────────────────────────────────────────────┘          │
│                          ↓                                   │
│  ┌──────────────────────────────────────────────┐          │
│  │      数据库层 (models.py + SQLAlchemy)        │          │
│  │  - training_samples 表                        │          │
│  │  - sensor_data 表                             │          │
│  │  - training_jobs 表                           │          │
│  └──────────────────────────────────────────────┘          │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│                     MySQL 数据库                              │
│  - 存储原始传感器数据                                         │
│  - 存储标注信息                                               │
│  - 存储训练任务元数据                                         │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│                  Python 训练模块                              │
│  ┌──────────────────────────────────────────────┐          │
│  │   1. 数据加载 (training/data_loader.py)       │          │
│  │      - 从MySQL读取数据                         │          │
│  │      - 数据清洗和过滤                          │          │
│  └──────────────────────────────────────────────┘          │
│                          ↓                                   │
│  ┌──────────────────────────────────────────────┐          │
│  │   2. 特征工程 (training/feature_extraction.py)│          │
│  │      - 滑动窗口切分                            │          │
│  │      - 时域/频域特征提取                       │          │
│  │      - 特征选择和降维                          │          │
│  └──────────────────────────────────────────────┘          │
│                          ↓                                   │
│  ┌──────────────────────────────────────────────┐          │
│  │   3. 模型训练 (training/train_model.py)       │          │
│  │      - Random Forest / XGBoost                │          │
│  │      - 交叉验证                                │          │
│  │      - 超参数调优                              │          │
│  │      - 模型评估                                │          │
│  └──────────────────────────────────────────────┘          │
│                          ↓                                   │
│  ┌──────────────────────────────────────────────┐          │
│  │   4. 模型导出 (training/export_tfjs.py)       │          │
│  │      - 转换为TensorFlow.js格式                 │          │
│  │      - 模型量化                                │          │
│  │      - 上传到云存储                            │          │
│  └──────────────────────────────────────────────┘          │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│                  TensorFlow.js 模型                           │
│  - model.json (模型结构)                                      │
│  - weights.bin (模型权重)                                     │
│  - 部署到小程序端                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 核心组件说明

### 1. 微信小程序端

#### 1.1 数据收集器 (DataCollector)
**功能：**
- 实时采集加速度计和陀螺仪数据
- 维护滑动窗口缓存（2秒数据）
- 数据标注和打包上传

**采样频率：** 50Hz（20ms/次）

**数据格式：**
```javascript
{
  samples: [
    {
      timestamp: 1696234567890,
      acc: { x: 0.5, y: 0.2, z: 9.8 },
      gyro: { x: 10.5, y: -5.2, z: 0.3 }
    },
    // ... 更多样本
  ],
  label: 'fall' | 'normal',
  source: 'simulate' | 'riding',
  userId: 'user123',
  duration: 30000, // ms
  sampleCount: 1500
}
```

#### 1.2 模拟摔倒页面
**路径：** `/pages/simulate/simulate.vue`

**功能：**
- 点击"开始采集"按钮，采集30秒数据
- 实时显示采集进度和数据量
- 用户可进行模拟摔倒动作
- 结束后询问"是否为摔倒"
- 上传标注数据到后端

**使用场景：** 专门用于收集摔倒样本

#### 1.3 骑行页面（改进）
**路径：** `/pages/riding/riding.vue`

**新增功能：**
- 骑行全程后台采集数据（节流：每3秒保存一次）
- 结束骑行时询问"是否上传数据用于改进"
- 默认标注为"正常"（normal）
- 上传到后端

**使用场景：** 收集正常骑行数据（负样本）

---

### 2. FastAPI 后端

#### 2.1 技术栈
- **框架：** FastAPI 0.104+
- **ORM：** SQLAlchemy 2.0+
- **数据库：** MySQL 8.0+
- **异步支持：** asyncio + aiomysql
- **数据验证：** Pydantic

#### 2.2 核心API

| 方法 | 路径 | 功能 | 权限 |
|-----|-----|-----|-----|
| POST | `/api/upload/training-data` | 上传训练数据 | 公开 |
| GET  | `/api/data/stats` | 获取数据统计 | 管理员 |
| GET  | `/api/data/list` | 查询数据列表 | 管理员 |
| POST | `/api/training/start` | 启动训练任务 | 管理员 |
| GET  | `/api/training/status/{job_id}` | 查询训练状态 | 管理员 |
| GET  | `/api/model/download` | 下载最新模型 | 公开 |
| GET  | `/api/model/list` | 模型版本列表 | 管理员 |

详细接口文档见：`01-后端API设计.md`

#### 2.3 目录结构
```
backend/
├── main.py                 # FastAPI应用入口
├── config.py               # 配置文件（数据库连接等）
├── models.py               # SQLAlchemy数据模型
├── database.py             # 数据库连接和会话
├── api/
│   ├── __init__.py
│   ├── upload.py          # 数据上传接口
│   ├── training.py        # 训练管理接口
│   └── data.py            # 数据查询接口
├── training/
│   ├── __init__.py
│   ├── data_loader.py     # 数据加载
│   ├── feature_extraction.py  # 特征工程
│   ├── train_model.py     # 模型训练
│   └── export_tfjs.py     # 模型导出
├── utils/
│   ├── __init__.py
│   └── validators.py      # 数据验证工具
├── requirements.txt       # Python依赖
└── .env                   # 环境变量（密钥等）
```

---

### 3. MySQL 数据库

#### 3.1 表设计

**training_samples（训练样本表）**
```sql
CREATE TABLE training_samples (
  id INT PRIMARY KEY AUTO_INCREMENT,
  user_id VARCHAR(64) NOT NULL,
  label ENUM('fall', 'normal') NOT NULL,
  source ENUM('simulate', 'riding') NOT NULL,
  duration INT NOT NULL COMMENT '采集时长(ms)',
  sample_count INT NOT NULL COMMENT '样本数量',
  uploaded_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  processed BOOLEAN DEFAULT FALSE,
  metadata JSON COMMENT '额外元数据',
  INDEX idx_label (label),
  INDEX idx_source (source),
  INDEX idx_uploaded (uploaded_at)
);
```

**sensor_data（传感器数据表）**
```sql
CREATE TABLE sensor_data (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  sample_id INT NOT NULL,
  timestamp BIGINT NOT NULL COMMENT 'Unix时间戳(ms)',
  acc_x FLOAT NOT NULL,
  acc_y FLOAT NOT NULL,
  acc_z FLOAT NOT NULL,
  gyro_x FLOAT NOT NULL,
  gyro_y FLOAT NOT NULL,
  gyro_z FLOAT NOT NULL,
  FOREIGN KEY (sample_id) REFERENCES training_samples(id) ON DELETE CASCADE,
  INDEX idx_sample (sample_id),
  INDEX idx_timestamp (timestamp)
);
```

**training_jobs（训练任务表）**
```sql
CREATE TABLE training_jobs (
  id INT PRIMARY KEY AUTO_INCREMENT,
  status ENUM('pending', 'running', 'completed', 'failed') DEFAULT 'pending',
  algorithm VARCHAR(64) NOT NULL COMMENT '算法名称',
  train_samples INT COMMENT '训练样本数',
  val_samples INT COMMENT '验证样本数',
  accuracy FLOAT COMMENT '准确率',
  precision_val FLOAT COMMENT '精确率',
  recall_val FLOAT COMMENT '召回率',
  f1_score FLOAT COMMENT 'F1分数',
  model_path VARCHAR(255) COMMENT '模型文件路径',
  config JSON COMMENT '训练配置',
  started_at DATETIME,
  completed_at DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

详细数据库设计见：`02-数据库设计.md`

---

### 4. Python 训练模块

#### 4.1 训练流程

```python
# 1. 数据加载
data_loader = DataLoader(db_connection)
samples = data_loader.load_all_samples()

# 2. 特征提取
feature_extractor = FeatureExtractor(window_size=100, overlap=50)
features, labels = feature_extractor.extract(samples)

# 3. 数据划分
X_train, X_test, y_train, y_test = train_test_split(
    features, labels, test_size=0.2, stratify=labels
)

# 4. 模型训练
model = RandomForestClassifier(n_estimators=100)
model.fit(X_train, y_train)

# 5. 模型评估
y_pred = model.predict(X_test)
accuracy = accuracy_score(y_test, y_pred)

# 6. 模型保存
joblib.dump(model, 'fall_detection_model.pkl')
```

#### 4.2 特征工程

**滑动窗口：** 2秒（100个数据点，50Hz）
**重叠率：** 50%

**提取特征（每窗口）：**
- 时域统计特征：均值、标准差、最大值、最小值（24维）
- 时域信号特征：RMS、偏度、峰度（18维）
- 频域特征：FFT能量、主频率（12维）
- 合成特征：总加速度、总角速度（6维）

**总计：60维特征**

详细特征工程见：`04-特征工程.md`

#### 4.3 模型选择

**方案1：Random Forest（推荐）**
- 准确率：~90%
- 训练时间：快
- 模型大小：小
- 可解释性：高

**方案2：XGBoost（备选）**
- 准确率：~92%
- 训练时间：中等
- 模型大小：小
- 可解释性：中等

**方案3：深度学习（未来）**
- CNN-LSTM
- 准确率：~95%
- 需要大量数据（10000+样本）

详细训练流程见：`05-模型训练.md`

---

## 数据流转

### 上传流程

```
小程序采集数据
    ↓
打包为JSON
    ↓
POST /api/upload/training-data
    ↓
FastAPI接收验证
    ↓
解析JSON数据
    ↓
插入 training_samples 表（元数据）
    ↓
批量插入 sensor_data 表（传感器数据）
    ↓
返回 sample_id
```

### 训练流程

```
管理员触发训练
    ↓
POST /api/training/start
    ↓
创建 training_job 记录（status=pending）
    ↓
异步任务启动
    ↓
从数据库加载数据
    ↓
特征提取
    ↓
模型训练
    ↓
模型评估
    ↓
保存模型文件
    ↓
更新 training_job（status=completed）
```

### 部署流程

```
训练完成
    ↓
模型转换为TensorFlow.js
    ↓
上传到云存储
    ↓
更新模型版本记录
    ↓
小程序端拉取最新模型
    ↓
加载模型进行推理
```

---

## 环境要求

### 后端服务器

**硬件：**
- CPU: 2核+
- 内存: 4GB+
- 磁盘: 20GB+

**软件：**
- Python 3.10+
- MySQL 8.0+
- pip 23.0+

### 开发环境

**必需工具：**
- Python 3.10+
- Node.js 16+ (用于TensorFlow.js转换)
- MySQL 8.0+
- Git

**Python依赖（requirements.txt）：**
```
fastapi==0.104.1
uvicorn[standard]==0.24.0
sqlalchemy==2.0.23
aiomysql==0.2.0
pydantic==2.5.0
python-multipart==0.0.6
pandas==2.1.3
numpy==1.26.2
scikit-learn==1.3.2
joblib==1.3.2
tensorflowjs==4.13.0
```

---

## 安全考虑

### 1. 数据安全
- ✅ 用户ID匿名化（不存储真实用户信息）
- ✅ 数据传输加密（HTTPS）
- ✅ 数据库访问权限控制

### 2. API安全
- ✅ 频率限制（每IP每小时最多100次请求）
- ✅ 数据大小限制（单次上传最多10MB）
- ✅ 管理员接口需要API Key认证

### 3. 隐私保护
- ✅ 数据仅用于模型训练，不用于其他用途
- ✅ 用户可随时删除自己的数据
- ✅ 符合GDPR和中国个人信息保护法

---

## 性能指标

### 目标指标

| 指标 | 目标值 |
|-----|-------|
| 数据上传响应时间 | < 2秒 |
| 训练1000样本耗时 | < 5分钟 |
| 模型准确率 | > 90% |
| 模型大小 | < 2MB |
| 推理延迟（小程序端） | < 100ms |

---

## 扩展性设计

### 水平扩展
- FastAPI支持多进程/多实例部署
- MySQL支持主从复制
- 训练任务可分布式执行

### 功能扩展
- 支持更多传感器数据（GPS、气压计等）
- 支持多分类（摔倒类型细分）
- 支持在线学习（增量训练）

---

## 监控和日志

### 系统监控
- API请求量和响应时间
- 数据库连接数和查询性能
- 训练任务执行状态

### 日志记录
- 访问日志（所有API请求）
- 错误日志（异常和错误）
- 训练日志（训练过程记录）

---

## 下一步

1. 阅读详细文档：
   - `01-后端API设计.md` - API接口规范
   - `02-数据库设计.md` - 数据库表结构
   - `03-小程序数据采集.md` - 小程序端实现

2. 环境搭建：
   - 安装Python依赖
   - 配置MySQL数据库
   - 运行FastAPI服务

3. 开始开发：
   - 实现后端API
   - 实现小程序数据收集器
   - 收集训练数据

---

## 常见问题

**Q1: 需要收集多少数据才能开始训练？**
A: 建议至少收集：
- 摔倒样本：100+
- 正常样本：1000+
- 样本比例：1:10

**Q2: 训练需要多长时间？**
A: 使用Random Forest，1000样本约需3-5分钟（CPU i5+）。

**Q3: 如何提高模型准确率？**
A:
1. 收集更多样本
2. 改进特征工程
3. 尝试更复杂的模型（XGBoost、深度学习）

**Q4: 数据存储多大？**
A: 每个30秒样本约：
- 1500个数据点 × 6个值 × 4字节 ≈ 36KB
- 1000个样本 ≈ 36MB

---

## 版本历史

### v1.0.0 (2025-10-02)
- ✅ 完成系统架构设计
- ✅ 定义数据流转流程
- ✅ 设计API接口
- ✅ 设计数据库表结构

---

## 参考资料

- FastAPI官方文档: https://fastapi.tiangolo.com/
- SQLAlchemy文档: https://docs.sqlalchemy.org/
- scikit-learn文档: https://scikit-learn.org/
- TensorFlow.js文档: https://www.tensorflow.org/js

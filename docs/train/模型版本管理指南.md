# 模型版本管理与自动更新指南

> **版本**: v1.0
> **创建日期**: 2025-10-03
> **功能**: 模型版本管理、自动更新

---

## 📋 目录

1. [功能概述](#功能概述)
2. [配置说明](#配置说明)
3. [启用自动更新](#启用自动更新)
4. [手动更新模型](#手动更新模型)
5. [上传新模型版本](#上传新模型版本)
6. [常见问题](#常见问题)

---

## 功能概述

### 核心功能

模型版本管理系统提供以下功能：

1. **版本检查** - 从服务器获取最新模型版本信息
2. **自动更新** - 定时检查并自动下载新版本模型
3. **手动更新** - 用户手动触发更新检查
4. **版本管理** - 后端管理多个模型版本

### 系统架构

```
小程序端                     后端API                   数据库
┌─────────────┐           ┌─────────────┐          ┌─────────────┐
│ MLDetector  │<--------->│ /model/     │<-------->│ model_      │
│  自动更新    │  HTTP     │  version    │  SQL     │  versions   │
│  版本检查    │           │  upload     │          │             │
└─────────────┘           └─────────────┘          └─────────────┘
```

### 默认配置

⚠️ **重要**: 模型自动更新功能**默认关闭**，需手动开启。

---

## 配置说明

### 配置文件位置

`utils/config.js`

### 配置项说明

```javascript
MODEL_AUTO_UPDATE: {
  // 是否启用模型自动更新（默认关闭）
  enabled: false,

  // 版本检查间隔（毫秒）
  // 默认: 1小时 = 60 * 60 * 1000
  checkInterval: 60 * 60 * 1000,

  // 是否在小程序启动时检查更新
  checkOnStartup: false,

  // 本地模型文件路径
  localModelPath: '/static/models/fall_detection_model.json',

  // 模型版本API路径（会自动拼接API_BASE_URL）
  versionApiPath: '/model/version'
}
```

### 配置示例

#### 开发环境配置
```javascript
// utils/config.js - devConfig
MODEL_AUTO_UPDATE: {
  enabled: false,           // 开发时建议关闭
  checkInterval: 3600000,   // 1小时
  checkOnStartup: false
}
```

#### 生产环境配置
```javascript
// utils/config.js - prodConfig
MODEL_AUTO_UPDATE: {
  enabled: true,            // 生产环境可开启
  checkInterval: 3600000,   // 1小时检查一次
  checkOnStartup: true      // 启动时检查更新
}
```

---

## 启用自动更新

### 方式一：修改配置文件（推荐）

1. 打开 `utils/config.js`

2. 修改配置：

```javascript
const devConfig = {
  // ...其他配置

  MODEL_AUTO_UPDATE: {
    enabled: true,           // 改为 true
    checkInterval: 3600000,  // 1小时检查一次
    checkOnStartup: true,    // 启动时检查
    localModelPath: '/static/models/fall_detection_model.json',
    versionApiPath: '/model/version'
  }
};
```

3. 保存并重新编译小程序

### 方式二：运行时动态启用

在骑行页面或其他页面中：

```javascript
import config from '@/utils/config.js';
import { getMLDetector } from '@/utils/mlModel.js';

// 临时开启自动更新
config.MODEL_AUTO_UPDATE.enabled = true;

const mlDetector = getMLDetector();
mlDetector.initAutoUpdate(config);
```

### 验证自动更新已启用

查看小程序控制台日志：

```
[Debug] ML模型 初始化模型自动更新
[Debug] ML模型 自动更新检查间隔: 60 分钟
```

如果看到 `模型自动更新已禁用`，说明配置未开启。

---

## 手动更新模型

### 在小程序代码中调用

```javascript
import config from '@/utils/config.js';
import { getMLDetector } from '@/utils/mlModel.js';

const mlDetector = getMLDetector();

// 手动检查并更新模型
const updated = await mlDetector.manualCheckUpdate(config);

if (updated) {
  console.log('模型已更新');
} else {
  console.log('无需更新或更新失败');
}
```

### 用户交互流程

1. **检查更新**
   - 调用 `manualCheckUpdate(config)`

2. **发现新版本**
   - 弹窗询问用户："发现新模型版本 v1.1，是否立即更新？"
   - 用户选择"更新"或"取消"

3. **自动下载**
   - 显示加载提示："更新模型中..."
   - 下载新模型JSON文件
   - 加载新模型

4. **更新完成**
   - 显示成功提示："模型已更新至 v1.1"
   - 保存版本信息到本地存储

---

## 上传新模型版本

### 1. 训练并导出模型

```bash
cd backend

# 训练模型
python train_model.py

# 导出JSON模型
python export_model.py models/fall_detection_model_v1.1.pkl \
  static/models/fall_detection_model_v1.1.json
```

### 2. 上传模型到服务器

#### 方法一：使用API上传

```bash
curl -X POST "http://localhost:8000/api/model/upload" \
  -H "X-API-Key: dev-test-key-2024" \
  -H "Content-Type: application/json" \
  -d '{
    "version": "v1.1",
    "algorithm": "random_forest",
    "accuracy": 0.93,
    "f1_score": 0.92,
    "model_size_mb": 0.45,
    "checksum": "abc123def456",
    "model_url": "http://your-server.com/models/fall_detection_model_v1.1.json"
  }'
```

#### 方法二：直接插入数据库

```sql
INSERT INTO model_versions (
  version,
  algorithm,
  accuracy,
  f1_score,
  model_size_mb,
  checksum,
  model_url,
  is_active
) VALUES (
  'v1.1',
  'random_forest',
  0.93,
  0.92,
  0.45,
  'abc123def456',
  'http://your-server.com/models/fall_detection_model_v1.1.json',
  TRUE
);
```

### 3. 验证版本已上传

```bash
# 查看所有版本
curl -X GET "http://localhost:8000/api/model/versions" \
  -H "X-API-Key: dev-test-key-2024"

# 查看最新版本
curl -X GET "http://localhost:8000/api/model/version"
```

---

## 常见问题

### Q1: 如何知道当前使用的模型版本？

**方法一：查看控制台日志**
```
[Debug] ML模型 ML模型加载成功: {version: "v1.0", ...}
```

**方法二：代码查询**
```javascript
const mlDetector = getMLDetector();
const modelInfo = mlDetector.getModelInfo();
console.log('当前模型版本:', modelInfo.version);
```

### Q2: 自动更新会消耗多少流量？

- **版本检查**: ~1KB（仅返回版本信息）
- **模型下载**: ~450KB（轻量级模型）

建议在WiFi环境下更新，或提示用户确认。

### Q3: 更新失败怎么办？

**常见原因**：
1. 网络连接问题
2. 服务器模型文件不存在
3. 模型文件格式错误

**解决方案**：
```javascript
try {
  const updated = await mlDetector.autoUpdateModel(updateInfo, config);
  if (!updated) {
    // 更新失败，继续使用旧版本
    console.log('更新失败，使用当前版本');
  }
} catch (error) {
  console.error('更新异常:', error);
}
```

### Q4: 如何禁用自动更新？

**临时禁用**（当前会话）：
```javascript
config.MODEL_AUTO_UPDATE.enabled = false;
```

**永久禁用**：
修改 `utils/config.js`，设置 `enabled: false`

### Q5: 自动更新会影响性能吗？

不会。自动更新仅在以下时机执行：
- 小程序启动时（如果 `checkOnStartup: true`）
- 定时检查（默认1小时一次）

检查过程为异步操作，不阻塞主线程。

### Q6: 如何回退到旧版本？

**方法一：手动替换模型文件**
```bash
# 复制旧版本模型
cp backup/fall_detection_model_v1.0.json \
   static/models/fall_detection_model.json
```

**方法二：上传旧版本到服务器**
```bash
curl -X POST "http://localhost:8000/api/model/upload" \
  -H "X-API-Key: dev-test-key-2024" \
  -d '{
    "version": "v1.0",
    ...
  }'
```

### Q7: 开发环境和生产环境使用不同配置？

使用环境变量区分：

```javascript
// utils/config.js
const config = process.env.NODE_ENV === 'production'
  ? prodConfig
  : devConfig;

// 开发环境：自动更新关闭
// 生产环境：自动更新开启
```

---

## 🔧 高级用法

### 自定义更新逻辑

```javascript
// 自定义版本比较逻辑
class CustomMLDetector extends MLFallDetector {
  async checkForUpdates(config) {
    const result = await super.checkForUpdates(config);

    // 添加自定义逻辑
    if (result.hasUpdate) {
      const localVersion = this.parseVersion(result.localVersion);
      const serverVersion = this.parseVersion(result.serverVersion);

      // 只更新主版本号变化的版本
      if (serverVersion.major > localVersion.major) {
        return result;
      } else {
        return { hasUpdate: false };
      }
    }

    return result;
  }

  parseVersion(versionStr) {
    // v1.2.3 -> {major: 1, minor: 2, patch: 3}
    const parts = versionStr.replace('v', '').split('.');
    return {
      major: parseInt(parts[0]),
      minor: parseInt(parts[1] || 0),
      patch: parseInt(parts[2] || 0)
    };
  }
}
```

### 监听更新事件

```javascript
// 在模型更新成功后执行自定义操作
const originalAutoUpdate = mlDetector.autoUpdateModel;
mlDetector.autoUpdateModel = async function(updateInfo, config) {
  const result = await originalAutoUpdate.call(this, updateInfo, config);

  if (result) {
    // 更新成功后的自定义操作
    console.log('模型已更新，重新初始化检测器');
    // 发送统计数据
    // 刷新UI
  }

  return result;
};
```

---

## 📚 API参考

### MLFallDetector类方法

| 方法 | 说明 | 参数 | 返回值 |
|------|------|------|--------|
| `checkForUpdates(config)` | 检查模型更新 | config对象 | Promise<UpdateResult> |
| `autoUpdateModel(updateInfo, config)` | 自动下载并更新 | 更新信息, config | Promise<boolean> |
| `initAutoUpdate(config)` | 初始化自动更新 | config对象 | void |
| `manualCheckUpdate(config)` | 手动检查更新 | config对象 | Promise<boolean> |

### 后端API

| 接口 | 方法 | 说明 | 认证 |
|------|------|------|------|
| `/api/model/version` | GET | 获取最新版本 | 无 |
| `/api/model/upload` | POST | 上传新版本 | API Key |
| `/api/model/versions` | GET | 列出所有版本 | API Key |

---

## 📞 技术支持

如有问题，请参考：
- [模型训练部署指南](./模型训练部署指南.md)
- [构建进度文档](./train-construction-progress.md)

---

**最后更新**: 2025-10-03
**文档版本**: v1.0

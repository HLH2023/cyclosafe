# 摔倒检测数据采集使用说明

> **版本**: v1.0
> **创建日期**: 2025-10-03
> **适用范围**: Phase 3 小程序数据采集

---

## 📱 功能概述

本系统提供了一个完整的数据采集界面，用于收集摔倒检测训练数据。主要功能包括：

1. **模拟摔倒数据采集** - 在安全环境下模拟摔倒动作
2. **数据自动上传** - 采集完成后自动上传到训练服务器
3. **数据标注** - 手动标注数据为"摔倒"或"正常"
4. **统计查看** - 查看已上传的数据统计

---

## 🚀 快速开始

### 1. 启动后端服务

```bash
cd /home/hlh/dev/school-homework/mobileHomework/backend
./start.sh
```

确保看到以下输出：
```
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
```

### 2. 配置小程序

打开 `utils/config.js`，确认配置正确：

```javascript
const devConfig = {
  API_BASE_URL: 'http://localhost:8000/api',  // 本地开发环境
  API_KEY: 'dev-test-key-2024',               // API密钥
  SAMPLE_RATE: 50,                            // 采样率 50Hz
  BUFFER_SIZE: 1500,                          // 缓冲区大小（30秒）
  DEBUG: true                                 // 调试模式
};
```

**重要提示**：
- 在真机上测试时，需要将 `localhost` 改为电脑的局域网IP地址
- 例如：`http://192.168.1.100:8000/api`

### 3. 运行小程序

使用 HBuilderX 或其他 uni-app 开发工具：

1. 打开项目
2. 运行到微信开发者工具或真机
3. 导航到"模拟摔倒"页面（`/pages/simulate/simulate`）

---

## 📖 使用模拟摔倒页面

### 页面路径

在小程序中导航到模拟摔倒页面，或直接访问：
```
pages/simulate/simulate
```

### 采集流程

#### 步骤 1: 准备

1. 打开"模拟摔倒"页面
2. 阅读页面上的安全提示
3. 确保在安全的环境下进行（建议在草地、垫子上）

#### 步骤 2: 开始采集

1. 点击"开始采集 (30秒)"按钮
2. 系统会显示 **3秒倒计时**，用于准备
3. 倒计时结束后，自动开始采集数据

#### 步骤 3: 执行动作

在30秒采集期间：

**摔倒数据采集**：
- 保持手机在手中或固定在身上
- 执行模拟摔倒动作（例如：侧倒、前倾摔倒等）
- 可以多次重复摔倒动作

**正常数据采集**：
- 保持手机在手中
- 执行正常的骑行动作（走路、转身、坐下等）
- 避免剧烈摇晃

#### 步骤 4: 实时监控

采集期间可以看到：
- **采集状态**: "准备中" → "采集中"
- **数据点数**: 实时显示已采集的数据点（目标1500点）
- **采集进度**: 进度条显示百分比
- **剩余时间**: 倒计时显示（30秒）

#### 步骤 5: 数据标注

采集完成后，系统会自动停止并显示标注界面：

1. **选择标签**：
   - 🚴 **摔倒数据** - 如果刚才执行了摔倒动作
   - ✅ **正常数据** - 如果刚才是正常活动

2. **确认上传**：
   - 点击对应按钮后，数据会自动上传到服务器
   - 上传成功后会显示提示信息

3. **丢弃数据**（可选）：
   - 如果采集过程中出现问题，可以点击"丢弃数据"
   - 系统会确认后删除本次采集的数据

#### 步骤 6: 查看统计

页面底部显示已上传的数据统计：
- **总样本数**
- **摔倒样本数**
- **正常样本数**

点击"刷新统计"可以更新数据。

---

## 🎯 数据采集目标

根据项目计划，需要采集以下数据：

| 数据类型 | 目标数量 | 说明 |
|---------|---------|------|
| 摔倒样本 | 100+ | 各种摔倒姿势和场景 |
| 正常样本 | 1000+ | 日常骑行、行走等活动 |

### 采集建议

#### 摔倒数据采集技巧

1. **多样性**：
   - 前倒、后倒、侧倒
   - 慢速摔倒、快速摔倒
   - 不同高度的摔倒

2. **安全第一**：
   - 在软垫或草地上进行
   - 避免真实的剧烈摔倒
   - 可以模拟摔倒动作

3. **数据质量**：
   - 保持手机固定在身上或手中
   - 确保传感器正常工作
   - 每次采集完成后检查数据点数

#### 正常数据采集技巧

1. **日常活动**：
   - 步行、跑步
   - 上下楼梯
   - 转身、弯腰

2. **骑行场景**：
   - 平稳骑行
   - 转弯、刹车
   - 颠簸路面

3. **持续时间**：
   - 每次30秒
   - 尽量包含多种动作
   - 保持自然状态

---

## 🔧 技术细节

### 数据采集参数

- **采样率**: 50 Hz（每秒50个数据点）
- **采集时长**: 30秒
- **数据点数**: 约1500个数据点
- **传感器**: 加速度计 + 陀螺仪
- **数据维度**: 6轴（ax, ay, az, gx, gy, gz）

### 数据格式

每个数据点包含：
```javascript
{
  timestamp: 1234567890,    // 时间戳（毫秒）
  elapsed: 1234,            // 相对时间（毫秒）
  ax: 0.12,                 // 加速度 X轴 (g)
  ay: -0.98,                // 加速度 Y轴 (g)
  az: 0.05,                 // 加速度 Z轴 (g)
  gx: 0.01,                 // 角速度 X轴 (rad/s)
  gy: -0.02,                // 角速度 Y轴 (rad/s)
  gz: 0.00                  // 角速度 Z轴 (rad/s)
}
```

### 上传数据结构

```javascript
{
  user_id: "uuid-xxxx-xxxx",        // 匿名用户ID
  label: "fall" | "normal",         // 数据标签
  sensor_data: [...],               // 传感器数据数组
  sample_metadata: {                // 元数据
    sample_rate: 50,
    duration_seconds: 30,
    data_points: 1500,
    collected_at: "2025-10-03T15:30:00Z",
    collection_method: "simulate_page",
    device_info: {...}
  }
}
```

---

## ❓ 常见问题

### Q1: 传感器启动失败怎么办？

**A**:
- 确保在真机上测试（微信开发者工具可能不支持传感器）
- 检查小程序权限设置
- 在微信中重新授权传感器权限

### Q2: 数据上传失败怎么办？

**A**:
1. 检查后端服务是否运行：
   ```bash
   curl http://localhost:8000/api/health
   ```
2. 检查API配置是否正确（`utils/config.js`）
3. 确保网络连接正常
4. 查看小程序控制台的错误信息

### Q3: 数据点数不足1500怎么办？

**A**:
- 可能是采集时间不够30秒
- 传感器频率可能低于预期
- 可以继续采集，系统会自动处理

### Q4: 如何查看已上传的数据？

**A**:
1. 在模拟摔倒页面查看统计信息
2. 或访问后端API：
   ```bash
   curl -H "X-API-Key: dev-test-key-2024" \
        http://localhost:8000/api/data/stats
   ```

### Q5: 真机测试时如何连接后端？

**A**:
1. 获取电脑的局域网IP地址：
   ```bash
   # Linux/Mac
   ifconfig | grep "inet "

   # Windows
   ipconfig
   ```
2. 修改 `utils/config.js` 中的 `API_BASE_URL`：
   ```javascript
   API_BASE_URL: 'http://192.168.1.100:8000/api'
   ```
3. 确保手机和电脑在同一局域网内

---

## 📊 数据管理

### 查看数据统计

```bash
curl -H "X-API-Key: dev-test-key-2024" \
     http://localhost:8000/api/data/stats
```

### 查看数据列表

```bash
curl -H "X-API-Key: dev-test-key-2024" \
     "http://localhost:8000/api/data/list?limit=10&offset=0"
```

### 数据库直接查询

```bash
mysql -u root -p fall_detection_train

USE fall_detection_train;

-- 查看样本统计
SELECT
  label,
  COUNT(*) as count,
  AVG(sample_metadata->>'$.data_points') as avg_points
FROM training_samples
GROUP BY label;

-- 查看最近上传的数据
SELECT
  id,
  user_id,
  label,
  created_at
FROM training_samples
ORDER BY created_at DESC
LIMIT 10;
```

---

## 🚀 下一步

1. **开始数据采集**：
   - 使用模拟摔倒页面采集至少 100 个摔倒样本
   - 采集至少 1000 个正常样本

2. **数据质量检查**：
   - 确保数据标注正确
   - 检查数据完整性

3. **模型训练**：
   - 当数据量足够后，启动模型训练
   - 详见 [05-模型训练详解.md](./05-模型训练详解.md)

---

## 📞 支持

如遇到问题，请检查：
1. [构建进度文档](./train-construction-progress.md)
2. [后端API设计](./01-后端API设计.md)
3. [小程序数据采集实现](./03-小程序数据采集实现.md)

**祝数据采集顺利！** 🎉

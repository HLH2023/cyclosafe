# CycloSafe 系统总览

## 项目简介

**CycloSafe** 是一款基于微信小程序的智能骑行安全码表系统，集成了专业码表功能与智能安全检测能力。通过手机传感器（GPS、加速度计、陀螺仪、指南针）实现骑行数据监测和危险事件检测，为骑行者提供全方位的安全保障。

**核心特性**：
- 实时骑行数据监测（速度、距离、海拔、时长）
- 智能安全检测（摔倒检测、急刹车检测，基于机器学习模型）
- GPS轨迹追踪和记录
- 数据可视化分析
- 本地数据存储（wx.setStorage）
- GPX轨迹导出
- 紧急联系人和一键求助
- 机器学习模型云端训练和自动更新

---

## 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         CycloSafe System                         │
├─────────────────────────────────┬───────────────────────────────┤
│      微信小程序前端 (uni-app)      │     Python后端 (FastAPI)       │
├─────────────────────────────────┼───────────────────────────────┤
│                                 │                               │
│  ┌─────────────────────────┐   │   ┌─────────────────────────┐ │
│  │   UI Layer (pages/)     │   │   │   API Layer             │ │
│  │  - index (主页)          │   │   │  - 数据上传接口          │ │
│  │  - riding (骑行页)       │   │   │  - 模型下载接口          │ │
│  │  - analysis (分析页)     │   │   │  - 训练管理接口          │ │
│  │  - history (历史)        │   │   └──────────┬──────────────┘ │
│  │  - settings (设置)       │   │              │                │
│  │  - danger-points (危险点)│   │   ┌──────────▼──────────────┐ │
│  │  - emergency-contacts   │   │   │  Training Engine        │ │
│  │  - simulate (模拟测试)   │   │   │  - DataCleaner          │ │
│  └──────────┬──────────────┘   │   │  - FeatureExtractor     │ │
│             │                   │   │  - ModelTrainer         │ │
│  ┌──────────▼──────────────┐   │   │  - RandomForest/SVM     │ │
│  │  Business Logic Layer   │   │   └──────────┬──────────────┘ │
│  │  services/              │   │              │                │
│  │  - sensorService.js     │   │   ┌──────────▼──────────────┐ │
│  │    • FallDetector       │◄──┼───│  Database (MySQL)       │ │
│  │    • MovingAvgFilter    │   │   │  - training_samples     │ │
│  │  - dataCollector.js     │   │   │  - sensor_data          │ │
│  │                         │───┼──►│  - training_jobs        │ │
│  └──────────┬──────────────┘   │   │  - model_versions       │ │
│             │                   │   └─────────────────────────┘ │
│  ┌──────────▼──────────────┐   │                               │
│  │   Data Layer            │   │                               │
│  │  db/                    │   └───────────────────────────────┤
│  │  - database.js          │                                   │
│  │  - repositories/        │   ┌───────────────────────────────┤
│  │    • RidingRecord       │   │  硬件接口层                     │
│  │    • DangerPoint        │   ├───────────────────────────────┤
│  │    • Settings           │   │  - GPS (高德/腾讯地图)          │
│  └──────────┬──────────────┘   │  - 加速度计 (50Hz采样)          │
│             │                   │  - 陀螺仪 (50Hz采样)            │
│  ┌──────────▼──────────────┐   │  - 指南针                       │
│  │  Storage Engine         │   │  - 震动马达                     │
│  │  - wx.setStorage        │   │  - 微信通话/导航                │
│  │  - 10MB存储限制          │   └───────────────────────────────┘
│  └─────────────────────────┘   │
│                                 │
└─────────────────────────────────┘
```

### 技术栈

#### 前端（微信小程序）

| 分类 | 技术 | 版本 | 用途 |
|------|------|------|------|
| **框架** | uni-app | latest | 跨平台小程序开发框架 |
| **UI框架** | @dcloudio/uni-ui | ^1.5.11 | 官方UI组件库 |
| **状态管理** | Pinia | ^3.0.3 | Vue 3状态管理 |
| **图表** | @qiun/ucharts | ^2.5.0 | 轻量级图表库 |
| | echarts | ^5.4.3 | 专业数据可视化 |
| **工具库** | dayjs | ^1.11.18 | 日期时间处理 |
| **地图** | 腾讯位置服务 | - | GPS定位和地图展示 |
| **存储** | wx.setStorage | - | 微信本地存储API |

#### 后端（Python API）

| 分类 | 技术 | 用途 |
|------|------|------|
| **Web框架** | FastAPI | RESTful API服务 |
| **数据库** | MySQL + SQLAlchemy | 关系型数据库ORM |
| **机器学习** | scikit-learn | 随机森林、SVM分类器 |
| **数据处理** | pandas, numpy | 数据清洗和特征提取 |
| **信号处理** | scipy | FFT频域分析、滤波 |
| **模型序列化** | joblib | 模型保存和加载 |
| **异步任务** | asyncio | 异步训练任务 |

---

## 核心功能概览

### 1. 骑行数据监测

**实时数据采集**：
- GPS定位（GCJ-02坐标系）
- 实时速度计算（基于Haversine公式）
- 累计距离统计
- 海拔变化（爬升/下降）
- 骑行时长
- 平均速度/最高速度

**数据记录**：
- 轨迹点智能过滤（最小距离5m，最小间隔3s，最大误差50m）
- 数据压缩存储
- 支持暂停/恢复
- 后台持续追踪

**实现位置**：
- `pages/riding/riding.vue` - 骑行页面
- `utils/gpsCalculator.js` - GPS计算工具

### 2. 智能安全检测

**摔倒检测**：
- 多传感器融合（加速度计 + 陀螺仪 + GPS速度）
- 三级灵敏度（低/中/高）
- 移动平均滤波降噪
- 碰撞特征识别
- 速度骤降检测
- 5秒防抖冷却

**急刹车检测**：
- 减速度阈值检测
- 低旋转特征过滤（排除摔倒）
- GPS速度验证
- 碰撞特征验证

**检测阈值（中等灵敏度）**：
```javascript
摔倒：
- 加速度 > 18 m/s²
- 陀螺仪 > 200°/s
- 碰撞特征 + 速度下降

急刹车：
- 加速度 > 12 m/s²
- 陀螺仪 < 100°/s
- 速度下降 > 8 km/h
- 减速度 < -1.5 m/s²
```

**实现位置**：
- `services/sensorService.js` - 核心检测逻辑
- `utils/mlModel.js` - 机器学习模型（可选）

### 3. 紧急响应

**一键求助**：
- 振动反馈
- 自动拨打紧急联系人
- 发送位置短信（即将支持）
- 导航到当前位置

**紧急联系人管理**：
- 最多3个联系人
- 姓名、电话、关系
- 本地加密存储

**实现位置**：
- `pages/emergency-contacts/emergency-contacts.vue`
- `utils/emergencyHelper.js`
- `utils/vibrationHelper.js`

### 4. 数据分析与可视化

**历史记录**：
- 骑行记录列表
- 时间/距离排序
- 分页加载
- 记录删除

**轨迹回放**：
- 地图轨迹展示
- 速度分段着色（绿色<15km/h，蓝色<25km/h，红色≥25km/h）
- 危险点标注（摔倒/急刹车）
- 详细统计数据

**数据分析**：
- 总骑行距离
- 总骑行时长
- 平均速度
- 周/月趋势图
- 时间分布图

**实现位置**：
- `pages/history/history.vue` - 历史记录
- `pages/analysis/analysis.vue` - 数据分析
- `pages/danger-points/danger-points.vue` - 危险点管理
- `components/line-chart/` - 图表组件

### 5. 机器学习训练系统

**数据收集**：
- 模拟页面标注数据（simulate.vue）
- 真实骑行数据
- 上传至后端训练

**模型训练**：
- 数据清洗（Z-score异常值检测）
- 特征提取（时域+频域共30+特征）
- 随机森林分类器
- 交叉验证
- 超参数调优

**模型管理**：
- 版本控制
- 自动更新检查
- 增量下载
- 校验和验证

**实现位置**：
- 前端：`pages/simulate/simulate.vue`, `utils/dataCollector.js`
- 后端：`backend/train_model.py`, `backend/main.py`

---

## 数据流架构

### 骑行数据流

```
┌──────────────┐
│  GPS硬件      │
│  加速度计     │
│  陀螺仪       │
└──────┬───────┘
       │
       ▼
┌──────────────────────┐
│  riding.vue          │
│  - startRiding()     │
│  - onLocationChange()│
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│  gpsCalculator.js    │
│  - calculateDistance │
│  - shouldRecordPoint │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│  RidingRecordRepo    │
│  - create()          │
│  - addTrackPoint()   │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│  wx.setStorage       │
│  - riding_records    │
│  - track_points      │
└──────────────────────┘
```

### 安全检测数据流

```
┌──────────────┐
│  加速度计     │ 50Hz采样
│  陀螺仪       │ 20ms间隔
└──────┬───────┘
       │
       ▼
┌──────────────────────┐
│  sensorService.js    │
│  - MovingAvgFilter   │ 滤波降噪
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│  FallDetector        │
│  - detect()          │ 多特征融合
│  - detectImpact()    │
│  - detectHardBrake() │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│  事件回调            │
│  - onFallDetected    │ 触发告警
│  - onHardBrake       │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│  DangerPointRepo     │ 保存记录
│  - create()          │
└──────────────────────┘
```

### 机器学习数据流

```
┌──────────────────┐
│  小程序数据采集   │
│  - 模拟页面       │
│  - 真实骑行       │
└────────┬─────────┘
         │ HTTP POST
         ▼
┌──────────────────────┐
│  FastAPI Backend     │
│  POST /api/upload/   │
│  training-data       │
└────────┬─────────────┘
         │
         ▼
┌──────────────────────┐
│  MySQL Database      │
│  - training_samples  │
│  - sensor_data       │
└────────┬─────────────┘
         │
         ▼
┌──────────────────────┐
│  train_model.py      │
│  - 数据清洗           │
│  - 特征提取           │
│  - 模型训练           │
└────────┬─────────────┘
         │
         ▼
┌──────────────────────┐
│  model_versions      │ 版本记录
│  models/*.pkl        │ 模型文件
└────────┬─────────────┘
         │ HTTP GET
         ▼
┌──────────────────────┐
│  小程序下载模型       │
│  - 版本检查           │
│  - 增量更新           │
└──────────────────────┘
```

---

## 目录结构

### 小程序目录结构

```
mobileHomework/
├── pages/                      # 页面
│   ├── index/                 # 主页（数据概览）
│   ├── riding/                # 骑行页（核心功能）
│   ├── analysis/              # 数据分析页
│   ├── history/               # 历史记录页
│   ├── settings/              # 设置页
│   ├── danger-points/         # 危险点管理
│   ├── emergency-contacts/    # 紧急联系人
│   └── simulate/              # 模拟测试（数据标注）
│
├── components/                # 组件
│   ├── glass-card/           # 玻璃态卡片
│   ├── line-chart/           # 折线图
│   ├── m-icon/               # 图标组件
│   ├── ride-card/            # 骑行卡片
│   ├── stat-card/            # 统计卡片
│   └── tab-bar/              # 底部导航
│
├── services/                  # 业务逻辑层
│   └── sensorService.js      # 传感器服务（核心）
│
├── db/                       # 数据访问层
│   ├── database.js           # 数据库初始化
│   └── repositories/         # 数据仓库
│       ├── RidingRecordRepository.js
│       ├── DangerPointRepository.js
│       └── SettingsRepository.js
│
├── utils/                    # 工具库
│   ├── gpsCalculator.js     # GPS计算（Haversine）
│   ├── storage-engine.js    # 存储引擎
│   ├── mlModel.js           # ML模型
│   ├── dataCollector.js     # 数据收集
│   ├── formatter.js         # 格式化工具
│   ├── emergencyHelper.js   # 紧急求助
│   ├── vibrationHelper.js   # 震动控制
│   └── constants.js         # 常量定义
│
├── store/                    # 状态管理
│   └── theme.js             # 主题管理
│
├── config/                   # 配置
│   └── map.config.js        # 地图API Key
│
├── static/                   # 静态资源
│   ├── images/
│   └── icons/
│
├── docs/                     # 文档
│   ├── all/                 # 全量文档（本目录）
│   └── ...                  # 其他文档
│
├── App.vue                   # 应用入口
├── main.js                   # 主配置
├── pages.json                # 页面配置
├── manifest.json             # 应用清单
├── uni.scss                  # 全局样式
└── package.json              # 依赖管理
```

### 后端目录结构

```
backend/
├── main.py                   # FastAPI应用入口
├── config.py                 # 配置文件
├── models.py                 # 数据库模型（SQLAlchemy）
├── database.py               # 数据库连接
├── requirements.txt          # Python依赖
├── .env                      # 环境变量
├── init_database.sql         # 数据库初始化SQL
├── start.sh                  # 启动脚本
│
├── train_model.py            # 模型训练主脚本
├── export_model.py           # 模型导出工具
├── test_data_upload.py       # 测试脚本
│
├── training/                 # 训练模块
│   ├── feature_extraction.py # 特征提取
│   └── train_model.py        # 训练逻辑
│
├── models/                   # 模型存储目录
├── logs/                     # 日志存储
└── venv/                     # Python虚拟环境
```

---

## 核心设计理念

### 1. 隐私优先

- **本地优先存储**：所有骑行数据默认存储在本地（wx.setStorage）
- **可选云端训练**：用户主动选择上传数据用于模型训练
- **无后端依赖**：小程序可独立运行，无需后端服务
- **数据控制权**：用户可随时删除本地数据

### 2. 离线可用

- **纯客户端架构**：核心功能无需网络
- **本地模型推理**：摔倒检测完全本地化
- **GPS离线追踪**：GPS定位不依赖网络
- **数据本地存储**：10MB存储空间（约100-200条记录）

### 3. 性能优化

- **传感器采样优化**：
  - 加速度计：50Hz（game模式）
  - 移动平均滤波：窗口大小5
  - GPS过滤：最小5m，最小3s间隔

- **电池优化**：
  - 仅骑行时启用高频采样
  - 静止自动暂停
  - 后台低功耗定位

- **存储优化**：
  - 轨迹点智能过滤
  - 定期清理旧数据
  - 索引优化查询

### 4. 可扩展性

- **模块化设计**：清晰的分层架构
- **Repository模式**：数据访问层抽象
- **服务化封装**：传感器服务独立模块
- **配置化管理**：可调节的检测阈值
- **ML模型热更新**：支持云端模型下载

---

## 关键技术实现

### GPS定位与轨迹追踪

**坐标系**：GCJ-02（中国标准）

**距离计算**：Haversine公式
```javascript
const R = 6371; // 地球半径（公里）
const dLat = (lat2 - lat1) * Math.PI / 180;
const dLon = (lon2 - lon1) * Math.PI / 180;
const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
          Math.sin(dLon/2) * Math.sin(dLon/2);
const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
const distance = R * c; // km
```

**轨迹过滤**：
- 精度过滤：accuracy < 50m
- 距离过滤：与上一点距离 > 5m
- 时间过滤：与上一点间隔 > 3s

**速度计算**：
```javascript
speed = distance / time_interval // km/h
```

### 传感器融合检测

**多传感器融合**：
- 加速度计：检测碰撞冲击
- 陀螺仪：检测旋转角速度
- GPS速度：验证速度变化

**移动平均滤波**：
```javascript
class MovingAverageFilter {
  constructor(windowSize = 5) {
    this.buffer = [];
    this.windowSize = windowSize;
  }

  filter(value) {
    this.buffer.push(value);
    if (this.buffer.length > this.windowSize) {
      this.buffer.shift();
    }
    return this.buffer.reduce((a, b) => a + b) / this.buffer.length;
  }
}
```

**摔倒检测逻辑**：
```javascript
detect(acc, gyro, speed) {
  // 1. 计算加速度模
  const accMag = Math.sqrt(acc.x² + acc.y² + acc.z²);

  // 2. 计算角速度模
  const gyroMag = Math.sqrt(gyro.x² + gyro.y² + gyro.z²);

  // 3. 滤波
  const filteredAcc = this.accFilter.filter(accMag);
  const filteredGyro = this.gyroFilter.filter(gyroMag);

  // 4. 多条件判断
  if (filteredAcc > threshold.acceleration &&
      filteredGyro > threshold.gyroscope &&
      this.detectImpact() &&
      this.detectSpeedDrop()) {
    return 'fall';
  }
}
```

### 本地存储架构

**存储引擎**：wx.setStorage（同步/异步）

**数据模型**：
```javascript
// 骑行记录
riding_records: {
  id: string,
  start_time: number,
  end_time: number,
  duration: number,
  distance: number,
  avg_speed: number,
  max_speed: number,
  elevation_gain: number,
  elevation_loss: number
}

// 轨迹点
track_points: {
  id: string,
  record_id: string,
  timestamp: number,
  latitude: number,
  longitude: number,
  altitude: number,
  speed: number,
  accuracy: number
}

// 危险点
danger_points: {
  id: string,
  type: 'fall' | 'hard_brake',
  timestamp: number,
  latitude: number,
  longitude: number,
  sensor_data: object,
  record_id: string
}
```

**索引优化**：
- 时间索引：按日期快速查询
- 关联索引：record_id关联查询

---

## 性能指标

### 小程序性能

| 指标 | 数值 |
|------|------|
| 启动时间 | < 2s |
| 页面切换 | < 300ms |
| GPS首次定位 | 3-10s（室外） |
| 传感器采样率 | 50Hz |
| 轨迹点记录频率 | 每3-5s |
| 内存占用 | < 100MB |
| 电池消耗 | ~15%/小时（骑行中） |

### 检测准确率

| 检测类型 | 准确率 | 误报率 |
|---------|--------|--------|
| 摔倒检测 | > 85% | < 10% |
| 急刹车检测 | > 80% | < 15% |

*注：准确率基于模拟测试，实际效果依赖传感器质量和骑行环境*

### 后端性能

| 指标 | 数值 |
|------|------|
| API响应时间 | < 100ms |
| 数据上传速度 | ~1000 samples/s |
| 模型训练时间 | 5-30分钟（取决于数据量） |
| 模型大小 | < 5MB |
| 并发支持 | 100+ 用户 |

---

## 安全性

### 数据安全

- **本地加密**：敏感数据（紧急联系人）加密存储
- **HTTPS传输**：后端通信强制HTTPS
- **API认证**：管理接口需要API Key
- **SQL注入防护**：SQLAlchemy ORM参数化查询
- **XSS防护**：前端输入验证和转义

### 隐私保护

- **最小权限原则**：仅申请必要权限（定位）
- **用户授权**：GPS、通讯录等需用户明确授权
- **匿名上传**：训练数据可匿名化上传
- **数据删除**：支持一键清除所有数据

---

## 未来规划

### 短期计划（v1.1）

- [ ] 短信求助功能（发送位置链接）
- [ ] 骑行计划和提醒
- [ ] 好友排行榜
- [ ] 导出PDF骑行报告

### 中期计划（v1.2）

- [ ] 社交功能（骑行轨迹分享）
- [ ] 云端数据同步（可选）
- [ ] 多设备数据迁移
- [ ] 天气预报集成

### 长期计划（v2.0）

- [ ] 骑行路线推荐（基于历史数据）
- [ ] 危险路段预警（众包数据）
- [ ] 团队骑行功能
- [ ] AR导航

---

## 相关文档

- [01-小程序实现.md](./01-小程序实现.md) - 小程序详细实现
- [02-后端实现.md](./02-后端实现.md) - 后端详细实现
- [03-数据流和通信.md](./03-数据流和通信.md) - 前后端通信
- [04-部署指南.md](./04-部署指南.md) - 部署说明
- [05-开发指南.md](./05-开发指南.md) - 开发者指南

---

## 版本信息

- **当前版本**：v0.1.0
- **最后更新**：2025-10-04
- **文档维护**：Claude Code

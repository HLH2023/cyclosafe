# CycloSafe 开发指南

本文档为开发者提供 CycloSafe 项目的开发指南，包括开发环境搭建、代码规范、调试技巧和功能扩展指南。

---

## 目录

- [开发环境搭建](#开发环境搭建)
- [代码规范](#代码规范)
- [开发流程](#开发流程)
- [调试技巧](#调试技巧)
- [功能扩展](#功能扩展)
- [常见问题](#常见问题)

---

## 开发环境搭建

### 小程序开发环境

#### 1. 安装必要工具

**HBuilderX**（必需）：
```
下载地址：https://www.dcloud.io/hbuilderx.html
推荐版本：3.0+
```

**微信开发者工具**（必需）：
```
下载地址：https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html
推荐版本：最新稳定版
```

**Node.js**（可选，用于依赖管理）：
```
下载地址：https://nodejs.org
推荐版本：14.0+ LTS
```

#### 2. 克隆项目

```bash
# 克隆仓库
git clone https://github.com/your-repo/cyclosafe.git
cd cyclosafe

# 安装依赖（可选）
npm install
```

#### 3. 配置项目

**配置 AppID**（`manifest.json`）：
```json
{
  "mp-weixin": {
    "appid": "wxYOUR_TEST_APPID"
  }
}
```

**配置地图 Key**（`config/map.config.js`）：
```javascript
export default {
  key: 'YOUR_TENCENT_MAP_KEY',
  // ...
};
```

#### 4. 运行项目

1. 用 HBuilderX 打开项目
2. 运行 → 运行到小程序模拟器 → 微信开发者工具
3. 在微信开发者工具中查看效果

---

### 后端开发环境

#### 1. 环境准备

**Python 3.8+**：
```bash
# Ubuntu/Debian
sudo apt install python3.8 python3.8-venv python3.8-dev

# macOS (Homebrew)
brew install python@3.8
```

**MySQL 8.0+**：
```bash
# Ubuntu/Debian
sudo apt install mysql-server

# macOS (Homebrew)
brew install mysql
```

#### 2. 克隆项目

```bash
cd backend
```

#### 3. 创建虚拟环境

```bash
# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
# Linux/macOS
source venv/bin/activate

# Windows
venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt
```

#### 4. 配置环境变量

创建 `.env` 文件：

```bash
DATABASE_URL=mysql+pymysql://root:password@localhost:3306/fall_detection_training
ADMIN_API_KEY=dev-api-key-123
MODEL_STORAGE_PATH=./models
LOG_STORAGE_PATH=./logs
API_HOST=0.0.0.0
API_PORT=8000
```

#### 5. 初始化数据库

```bash
# 登录 MySQL
mysql -u root -p

# 执行初始化脚本
mysql> source init_database.sql
mysql> exit
```

#### 6. 运行开发服务器

```bash
# 激活虚拟环境
source venv/bin/activate

# 运行开发服务器（自动重载）
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

访问：
- API 文档：http://localhost:8000/docs
- 健康检查：http://localhost:8000/api/health

---

## 代码规范

### 小程序代码规范

#### 1. 文件命名

- **页面**：小写字母，连字符分隔，如 `riding.vue`、`emergency-contacts.vue`
- **组件**：小写字母，连字符分隔，如 `glass-card.vue`、`line-chart.vue`
- **工具**：驼峰命名，如 `gpsCalculator.js`、`emergencyHelper.js`

#### 2. Vue 组件规范

**Composition API**：

```vue
<template>
  <view class="component-name">
    <!-- 内容 -->
  </view>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue';

// Props
const props = defineProps({
  title: String,
  data: Object
});

// Emits
const emit = defineEmits(['update', 'delete']);

// State
const count = ref(0);
const doubleCount = computed(() => count.value * 2);

// Methods
function increment() {
  count.value++;
  emit('update', count.value);
}

// Lifecycle
onMounted(() => {
  console.log('Component mounted');
});
</script>

<style lang="scss" scoped>
.component-name {
  /* 样式 */
}
</style>
```

#### 3. JavaScript 规范

**ES6+ 语法**：

```javascript
// ✅ 使用 const/let
const maxSpeed = 100;
let currentSpeed = 0;

// ✅ 箭头函数
const calculate = (a, b) => a + b;

// ✅ 解构赋值
const { latitude, longitude } = location;

// ✅ 模板字符串
const message = `速度: ${speed} km/h`;

// ✅ 可选链
const userName = user?.profile?.name;

// ✅ 空值合并
const distance = data.distance ?? 0;
```

**函数注释**：

```javascript
/**
 * 计算两点间距离
 * @param {number} lat1 - 纬度1
 * @param {number} lon1 - 经度1
 * @param {number} lat2 - 纬度2
 * @param {number} lon2 - 经度2
 * @returns {number} 距离（公里）
 */
export function calculateDistance(lat1, lon1, lat2, lon2) {
  // 实现
}
```

#### 4. SCSS 规范

```scss
// 使用 BEM 命名法
.riding-page {
  &__header {
    display: flex;
    align-items: center;
  }

  &__title {
    font-size: 18px;
    font-weight: bold;
  }

  &--active {
    background-color: #007AFF;
  }
}

// 使用变量
$primary-color: #007AFF;
$text-color: #333;

.button {
  background-color: $primary-color;
  color: white;
}
```

---

### 后端代码规范

#### 1. Python 规范（PEP 8）

```python
# ✅ 命名规范
class ModelTrainer:  # 类名：大驼峰
    def __init__(self):
        self.model_name = 'random_forest'  # 变量：蛇形命名

    def train_model(self):  # 方法：蛇形命名
        pass

# ✅ 导入顺序
import os
import sys

import numpy as np
import pandas as pd

from config import DATABASE_URL
from models import TrainingSample

# ✅ 文档字符串
def extract_features(data):
    """
    从传感器数据中提取特征

    Args:
        data: DataFrame，包含传感器数据

    Returns:
        dict: 特征字典
    """
    pass

# ✅ 类型提示
from typing import List, Dict, Optional

def process_samples(samples: List[Dict]) -> Optional[pd.DataFrame]:
    """处理样本数据"""
    pass
```

#### 2. FastAPI 规范

```python
from fastapi import APIRouter, HTTPException, Depends
from pydantic import BaseModel

router = APIRouter()

# ✅ 使用 Pydantic 模型
class UploadRequest(BaseModel):
    user_id: str
    label: str
    samples: List[Dict]

# ✅ 路由装饰器
@router.post("/api/upload/training-data")
async def upload_training_data(
    request: UploadRequest,
    db: Session = Depends(get_db)
):
    """上传训练数据"""
    try:
        # 处理逻辑
        return {"success": True}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

---

## 开发流程

### Git 工作流

#### 1. 分支管理

```
main           # 主分支（生产环境）
  ├─ develop   # 开发分支
  │   ├─ feature/xxx  # 功能分支
  │   ├─ bugfix/xxx   # Bug修复分支
  │   └─ hotfix/xxx   # 紧急修复分支
```

**创建功能分支**：

```bash
# 从 develop 创建功能分支
git checkout develop
git pull origin develop
git checkout -b feature/add-export-gpx

# 开发完成后合并回 develop
git checkout develop
git merge feature/add-export-gpx
git push origin develop
```

#### 2. 提交规范

**Commit 消息格式**：

```
<type>(<scope>): <subject>

<body>

<footer>
```

**类型（type）**：
- `feat`：新功能
- `fix`：Bug 修复
- `docs`：文档更新
- `style`：代码格式
- `refactor`：重构
- `test`：测试
- `chore`：构建/工具

**示例**：

```bash
git commit -m "feat(riding): 添加 GPX 导出功能"
git commit -m "fix(sensor): 修复摔倒检测误报问题"
git commit -m "docs(readme): 更新安装说明"
```

---

### 代码审查

#### Pull Request 规范

**PR 标题**：
```
[Feature] 添加 GPX 导出功能
[Bugfix] 修复摔倒检测误报
[Docs] 更新部署文档
```

**PR 描述模板**：

```markdown
## 变更类型
- [ ] 新功能
- [ ] Bug 修复
- [ ] 文档更新
- [ ] 性能优化
- [ ] 重构

## 变更说明
简要描述本次变更的内容和原因。

## 测试情况
- [ ] 单元测试通过
- [ ] 真机测试通过
- [ ] 代码审查通过

## 截图（如适用）
![screenshot](url)

## 相关 Issue
Closes #123
```

---

## 调试技巧

### 小程序调试

#### 1. 控制台调试

```javascript
// 基础日志
console.log('普通日志');
console.warn('警告');
console.error('错误');

// 对象日志
console.log('传感器数据:', { acc, gyro });

// 表格日志
console.table(trackPoints);
```

#### 2. 真机调试

**启用真机调试**：
1. 微信开发者工具 → 工具 → 真机调试
2. 扫码在手机上打开
3. 查看控制台输出

**调试 GPS**：
```javascript
uni.getLocation({
  type: 'gcj02',
  success: (res) => {
    console.log('GPS 定位成功:', res);
  },
  fail: (err) => {
    console.error('GPS 定位失败:', err);
  }
});
```

**调试传感器**：
```javascript
uni.startAccelerometer({
  interval: 'game',
  success: () => {
    console.log('加速度计启动成功');
  }
});

uni.onAccelerometerChange((res) => {
  console.log('加速度:', res.x, res.y, res.z);
});
```

#### 3. 性能分析

**使用性能面板**：
- 微信开发者工具 → 调试器 → Performance
- 记录性能数据
- 分析渲染性能、内存使用

**查看网络请求**：
- 调试器 → Network
- 查看请求时间、响应大小
- 检查失败的请求

---

### 后端调试

#### 1. 日志调试

```python
import logging

logger = logging.getLogger(__name__)

# 不同级别的日志
logger.debug('调试信息')
logger.info('普通信息')
logger.warning('警告')
logger.error('错误')
logger.critical('严重错误')
```

#### 2. FastAPI 交互式文档

访问 `http://localhost:8000/docs`：
- 查看所有 API 接口
- 测试接口调用
- 查看请求/响应格式

#### 3. Python 调试器

**使用 pdb**：

```python
import pdb

def train_model(data):
    # 设置断点
    pdb.set_trace()

    # 代码会在这里暂停
    features = extract_features(data)

    return features
```

**VS Code 调试**：

创建 `.vscode/launch.json`：

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "FastAPI",
      "type": "python",
      "request": "launch",
      "module": "uvicorn",
      "args": [
        "main:app",
        "--reload"
      ],
      "jinja": true
    }
  ]
}
```

---

## 功能扩展

### 添加新页面

#### 1. 创建页面文件

```bash
# 创建页面目录
mkdir -p pages/new-feature

# 创建页面文件
touch pages/new-feature/new-feature.vue
```

#### 2. 编写页面代码

```vue
<template>
  <view class="new-feature-page">
    <text>新功能页面</text>
  </view>
</template>

<script setup>
import { ref, onMounted } from 'vue';

const data = ref([]);

onMounted(() => {
  loadData();
});

function loadData() {
  // 加载数据
}
</script>

<style lang="scss" scoped>
.new-feature-page {
  padding: 20rpx;
}
</style>
```

#### 3. 注册页面路由

编辑 `pages.json`：

```json
{
  "pages": [
    {
      "path": "pages/new-feature/new-feature",
      "style": {
        "navigationBarTitleText": "新功能"
      }
    }
  ]
}
```

---

### 添加新组件

#### 1. 创建组件

```bash
mkdir -p components/my-component
touch components/my-component/my-component.vue
```

#### 2. 编写组件

```vue
<template>
  <view class="my-component">
    <text>{{ title }}</text>
    <button @click="handleClick">点击</button>
  </view>
</template>

<script setup>
import { defineProps, defineEmits } from 'vue';

const props = defineProps({
  title: String
});

const emit = defineEmits(['click']);

function handleClick() {
  emit('click');
}
</script>

<style lang="scss" scoped>
.my-component {
  /* 样式 */
}
</style>
```

#### 3. 使用组件

```vue
<template>
  <my-component
    title="标题"
    @click="handleComponentClick"
  />
</template>

<script setup>
function handleComponentClick() {
  console.log('组件被点击');
}
</script>
```

---

### 添加后端 API

#### 1. 定义数据模型

```python
# models.py
from pydantic import BaseModel

class NewFeatureRequest(BaseModel):
    name: str
    value: int
```

#### 2. 创建 API 路由

```python
# main.py
@app.post("/api/new-feature")
async def create_new_feature(
    request: NewFeatureRequest,
    db: Session = Depends(get_db)
):
    """新功能 API"""
    try:
        # 处理逻辑
        return {
            "success": True,
            "data": {
                "id": 123
            }
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

#### 3. 小程序调用

```javascript
async function callNewFeatureAPI() {
  try {
    const response = await uni.request({
      url: 'https://api.cyclosafe.com/api/new-feature',
      method: 'POST',
      data: {
        name: 'test',
        value: 100
      }
    });

    console.log('API 响应:', response.data);
  } catch (error) {
    console.error('API 调用失败:', error);
  }
}
```

---

## 常见问题

### 小程序常见问题

#### 1. GPS 定位不准确

**解决方案**：
```javascript
// 增加定位超时时间
uni.getLocation({
  type: 'gcj02',
  timeout: 10000,  // 10秒超时
  success: (res) => {
    if (res.accuracy < 50) {  // 精度过滤
      // 使用位置
    }
  }
});
```

#### 2. 传感器数据噪声大

**解决方案**：
```javascript
// 使用移动平均滤波
class MovingAverageFilter {
  constructor(windowSize = 5) {
    this.buffer = [];
    this.windowSize = windowSize;
  }

  filter(value) {
    this.buffer.push(value);
    if (this.buffer.length > this.windowSize) {
      this.buffer.shift();
    }
    return this.buffer.reduce((a, b) => a + b) / this.buffer.length;
  }
}
```

#### 3. 页面卡顿

**解决方案**：
- 使用虚拟列表渲染大量数据
- 减少页面层级
- 避免频繁的 setData
- 使用节流/防抖

```javascript
// 节流
function throttle(fn, delay) {
  let timer = null;
  return function(...args) {
    if (!timer) {
      timer = setTimeout(() => {
        fn.apply(this, args);
        timer = null;
      }, delay);
    }
  };
}

// 使用
const throttledUpdate = throttle(updateLocation, 1000);
```

---

### 后端常见问题

#### 1. 数据库连接池耗尽

**解决方案**：

```python
# database.py
engine = create_engine(
    DATABASE_URL,
    pool_size=10,           # 连接池大小
    max_overflow=20,        # 最大溢出连接
    pool_timeout=30,        # 超时时间
    pool_recycle=3600       # 连接回收时间
)
```

#### 2. API 性能慢

**解决方案**：

```python
# 使用异步处理
import asyncio

@app.post("/api/heavy-task")
async def heavy_task():
    # 异步执行耗时任务
    result = await asyncio.create_task(run_heavy_task())
    return {"result": result}

# 添加缓存
from functools import lru_cache

@lru_cache(maxsize=128)
def get_model_version():
    # 缓存结果
    pass
```

#### 3. 模型训练内存溢出

**解决方案**：

```python
# 分批处理数据
def load_data_in_batches(batch_size=1000):
    for i in range(0, total_samples, batch_size):
        batch = load_batch(i, batch_size)
        yield batch

# 使用
for batch in load_data_in_batches():
    process_batch(batch)
```

---

## 测试

### 单元测试

**小程序测试**（使用 Jest）：

```javascript
// gpsCalculator.test.js
import { calculateDistance } from '@/utils/gpsCalculator.js';

describe('GPS Calculator', () => {
  test('计算距离', () => {
    const distance = calculateDistance(0, 0, 1, 1);
    expect(distance).toBeGreaterThan(0);
  });
});
```

**后端测试**（使用 pytest）：

```python
# test_api.py
import pytest
from fastapi.testclient import TestClient
from main import app

client = TestClient(app)

def test_health_check():
    response = client.get("/api/health")
    assert response.status_code == 200
    assert response.json()["status"] == "healthy"

def test_upload_data():
    data = {
        "user_id": "test_user",
        "label": "fall",
        "source": "simulate",
        "duration": 1000,
        "samples": [
            {
                "timestamp": 123456,
                "acc": {"x": 0, "y": 0, "z": 9.8},
                "gyro": {"x": 0, "y": 0, "z": 0}
            }
        ]
    }

    response = client.post("/api/upload/training-data", json=data)
    assert response.status_code == 200
    assert response.json()["success"] == True
```

---

## 总结

本文档为开发者提供了完整的开发指南：

**开发环境**：
- 小程序：HBuilderX + 微信开发者工具
- 后端：Python 3.8+ + MySQL 8.0+

**代码规范**：
- JavaScript：ES6+、Vue 3 Composition API
- Python：PEP 8、FastAPI 最佳实践

**开发流程**：
- Git 工作流
- Commit 规范
- PR 流程

**调试技巧**：
- 控制台调试
- 真机调试
- 性能分析

**功能扩展**：
- 添加新页面
- 添加新组件
- 添加新 API

---

## 相关文档

- [00-系统总览.md](./00-系统总览.md) - 系统架构
- [01-小程序实现.md](./01-小程序实现.md) - 小程序详解
- [02-后端实现.md](./02-后端实现.md) - 后端详解
- [03-数据流和通信.md](./03-数据流和通信.md) - 数据交互
- [04-部署指南.md](./04-部署指南.md) - 部署说明

---

**版本**：v1.0.0
**最后更新**：2025-10-04

# CycloSafe 数据流和通信

本文档详细介绍 CycloSafe 前后端之间的数据交互、通信协议和数据格式。

---

## 目录

- [通信架构](#通信架构)
- [数据上传流程](#数据上传流程)
- [模型下载流程](#模型下载流程)
- [API 调用示例](#api-调用示例)
- [数据格式规范](#数据格式规范)
- [错误处理](#错误处理)

---

## 通信架构

### 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                     CycloSafe System                        │
├─────────────────────────────┬───────────────────────────────┤
│   微信小程序（客户端）         │   Python 后端（服务器）        │
├─────────────────────────────┼───────────────────────────────┤
│                             │                               │
│  ┌─────────────────────┐   │   ┌─────────────────────┐    │
│  │  数据收集模块         │   │   │  数据接收 API       │    │
│  │  - simulate.vue     │───┼──▶│  POST /api/upload/  │    │
│  │  - dataCollector.js │   │   │  training-data      │    │
│  └─────────────────────┘   │   └──────────┬──────────┘    │
│                             │              │                │
│                             │   ┌──────────▼──────────┐    │
│                             │   │  MySQL Database     │    │
│                             │   │  - training_samples │    │
│                             │   │  - sensor_data      │    │
│                             │   └─────────────────────┘    │
│                             │                               │
│  ┌─────────────────────┐   │   ┌─────────────────────┐    │
│  │  模型更新模块         │   │   │  模型服务 API       │    │
│  │  - mlModel.js       │◄──┼───│  GET /api/model/    │    │
│  │  - 版本检查          │   │   │  version            │    │
│  │  - 增量下载          │   │   │  download           │    │
│  └─────────────────────┘   │   └─────────────────────┘    │
│                             │                               │
└─────────────────────────────┴───────────────────────────────┘

         HTTP/HTTPS              JSON over HTTP
```

### 通信协议

- **协议**：HTTP/HTTPS
- **数据格式**：JSON
- **字符编码**：UTF-8
- **内容类型**：`application/json`

---

## 数据上传流程

### 流程图

```
小程序端                                      后端
┌──────┐                                   ┌──────┐
│ User │                                   │ API  │
└──┬───┘                                   └──┬───┘
   │                                          │
   │ 1. 模拟测试/真实骑行                      │
   ├─────────────────────────────────────────┤
   │ 收集传感器数据                            │
   │ (acc, gyro, timestamp)                  │
   │                                          │
   │ 2. 标注数据                               │
   │ (label: fall/normal)                    │
   │                                          │
   │ 3. 打包数据                               │
   │ {user_id, label, source, samples}       │
   │                                          │
   │ 4. HTTP POST                             │
   │ /api/upload/training-data               │
   ├────────────────────────────────────────▶│
   │                                          │
   │                                          │ 5. 验证数据
   │                                          │    - label in [fall, normal]
   │                                          │    - source in [simulate, riding]
   │                                          │    - samples not empty
   │                                          │
   │                                          │ 6. 保存到 MySQL
   │                                          │    - training_samples
   │                                          │    - sensor_data
   │                                          │
   │ 7. 返回结果                               │
   │◀────────────────────────────────────────┤
   │ {success, sample_id, created_at}        │
   │                                          │
```

### 数据格式

**请求（Request）**：

```json
{
  "user_id": "user_12345",
  "label": "fall",
  "source": "simulate",
  "duration": 30000,
  "samples": [
    {
      "timestamp": 1696234567890,
      "acc": { "x": 0.52, "y": 0.31, "z": 9.75 },
      "gyro": { "x": 12.5, "y": -6.2, "z": 0.8 }
    },
    {
      "timestamp": 1696234567910,
      "acc": { "x": 0.48, "y": 0.29, "z": 9.81 },
      "gyro": { "x": 11.2, "y": -5.8, "z": 0.6 }
    }
  ],
  "metadata": {
    "device": "iPhone 12",
    "os": "iOS 16.0"
  }
}
```

**响应（Response）**：

```json
{
  "success": true,
  "message": "数据上传成功",
  "data": {
    "sample_id": 123,
    "sample_count": 500,
    "created_at": "2025-10-04T12:00:00"
  }
}
```

### 小程序实现

```javascript
// dataCollector.js
class DataCollector {
  async uploadToServer(metadata) {
    const url = 'https://api.cyclosafe.com/api/upload/training-data';

    try {
      const response = await uni.request({
        url: url,
        method: 'POST',
        header: {
          'Content-Type': 'application/json'
        },
        data: {
          user_id: metadata.user_id,
          label: metadata.label,      // 'fall' or 'normal'
          source: metadata.source,    // 'simulate' or 'riding'
          duration: metadata.duration,
          samples: this.data.map(d => ({
            timestamp: d.timestamp,
            acc: d.acc,
            gyro: d.gyro
          })),
          metadata: {
            device: uni.getSystemInfoSync().model,
            os: uni.getSystemInfoSync().system
          }
        }
      });

      if (response.statusCode === 200) {
        console.log('上传成功:', response.data);
        return response.data;
      } else {
        throw new Error(`上传失败: ${response.statusCode}`);
      }
    } catch (error) {
      console.error('上传失败:', error);
      throw error;
    }
  }
}
```

---

## 模型下载流程

### 流程图

```
小程序端                                      后端
┌──────┐                                   ┌──────┐
│ App  │                                   │ API  │
└──┬───┘                                   └──┬───┘
   │                                          │
   │ 1. 应用启动                               │
   │                                          │
   │ 2. 检查本地模型版本                        │
   │ localStorage: model_version = "1.0.0"   │
   │                                          │
   │ 3. 请求最新版本                           │
   │ GET /api/model/version                  │
   ├────────────────────────────────────────▶│
   │                                          │
   │                                          │ 4. 查询最新模型
   │                                          │    - model_versions
   │                                          │    - is_active = true
   │                                          │    - order by deployed_at
   │                                          │
   │ 5. 返回版本信息                           │
   │◀────────────────────────────────────────┤
   │ {version, checksum, model_url, size}    │
   │                                          │
   │ 6. 比较版本                               │
   │ if server_version > local_version:      │
   │                                          │
   │ 7. 下载新模型                             │
   │ GET /api/model/download                 │
   ├────────────────────────────────────────▶│
   │                                          │
   │                                          │ 8. 返回模型数据
   │                                          │    - 增加 download_count
   │                                          │
   │◀────────────────────────────────────────┤
   │ model_data                              │
   │                                          │
   │ 9. 校验 checksum                         │
   │ if checksum_valid:                      │
   │    save to localStorage                 │
   │    update local_version                 │
   │                                          │
```

### 版本检查 API

**请求**：

```http
GET /api/model/version
```

**响应**：

```json
{
  "success": true,
  "data": {
    "version": "1.2.0",
    "checksum": "abc123def456...",
    "model_url": "https://cdn.cyclosafe.com/models/v1.2.0.pkl",
    "model_size_mb": 4.5,
    "deployed_at": "2025-10-01T10:00:00",
    "algorithm": "random_forest",
    "accuracy": 0.92,
    "f1_score": 0.89
  }
}
```

### 模型下载 API

**请求**：

```http
GET /api/model/download
```

**响应**：

```json
{
  "success": true,
  "data": {
    "version": "1.2.0",
    "algorithm": "random_forest",
    "model_url": "https://cdn.cyclosafe.com/models/v1.2.0.pkl",
    "model_size_mb": 4.5,
    "checksum": "abc123def456...",
    "accuracy": 0.92,
    "f1_score": 0.89,
    "deployed_at": "2025-10-01T10:00:00",
    "download_count": 156
  }
}
```

### 小程序实现

```javascript
// mlModel.js
class MLModelManager {
  async checkForUpdates() {
    const url = 'https://api.cyclosafe.com/api/model/version';

    try {
      const response = await uni.request({
        url: url,
        method: 'GET'
      });

      if (response.statusCode === 200) {
        const serverVersion = response.data.data.version;
        const localVersion = uni.getStorageSync('model_version') || '0.0.0';

        if (this.compareVersions(serverVersion, localVersion) > 0) {
          console.log('发现新版本:', serverVersion);
          return {
            hasUpdate: true,
            newVersion: serverVersion,
            modelInfo: response.data.data
          };
        }
      }

      return { hasUpdate: false };
    } catch (error) {
      console.error('检查更新失败:', error);
      return { hasUpdate: false };
    }
  }

  async downloadModel() {
    const url = 'https://api.cyclosafe.com/api/model/download';

    try {
      const response = await uni.request({
        url: url,
        method: 'GET',
        responseType: 'arraybuffer'
      });

      if (response.statusCode === 200) {
        const modelData = response.data.data;

        // 校验 checksum
        const calculatedChecksum = this.calculateChecksum(response.data);
        if (calculatedChecksum !== modelData.checksum) {
          throw new Error('模型文件校验失败');
        }

        // 保存模型
        uni.setStorageSync('ml_model', response.data);
        uni.setStorageSync('model_version', modelData.version);

        console.log('模型下载成功:', modelData.version);
        return true;
      }

      return false;
    } catch (error) {
      console.error('下载模型失败:', error);
      return false;
    }
  }

  compareVersions(v1, v2) {
    const parts1 = v1.split('.').map(Number);
    const parts2 = v2.split('.').map(Number);

    for (let i = 0; i < 3; i++) {
      if (parts1[i] > parts2[i]) return 1;
      if (parts1[i] < parts2[i]) return -1;
    }

    return 0;
  }
}
```

---

## API 调用示例

### 1. 上传训练数据

```javascript
// 使用示例（小程序端）
const dataCollector = new DataCollector();

// 收集数据
dataCollector.startCollecting();

// ... 收集过程 ...

// 上传
const result = await dataCollector.uploadToServer({
  user_id: 'user_' + Date.now(),
  label: 'fall',           // 'fall' or 'normal'
  source: 'simulate',      // 'simulate' or 'riding'
  duration: 30000
});

if (result.success) {
  uni.showToast({ title: '上传成功', icon: 'success' });
}
```

### 2. 获取数据统计（管理接口）

```bash
curl -X GET "https://api.cyclosafe.com/api/data/stats" \
  -H "X-API-Key: your-secret-api-key"
```

**响应**：

```json
{
  "success": true,
  "data": {
    "total_samples": 500,
    "fall_samples": 100,
    "normal_samples": 400,
    "by_source": {
      "simulate": 50,
      "riding": 450
    }
  }
}
```

### 3. 启动训练任务（管理接口）

```bash
curl -X POST "https://api.cyclosafe.com/api/training/start" \
  -H "X-API-Key: your-secret-api-key"
```

**响应**：

```json
{
  "success": true,
  "message": "训练任务已创建",
  "data": {
    "job_id": 42,
    "status": "pending"
  }
}
```

### 4. 查询训练状态

```bash
curl -X GET "https://api.cyclosafe.com/api/training/status/42" \
  -H "X-API-Key: your-secret-api-key"
```

**响应**：

```json
{
  "success": true,
  "data": {
    "job_id": 42,
    "status": "completed",
    "algorithm": "random_forest",
    "accuracy": 0.92,
    "f1_score": 0.89,
    "started_at": "2025-10-04T10:00:00",
    "completed_at": "2025-10-04T10:25:00",
    "error_message": null
  }
}
```

---

## 数据格式规范

### 传感器数据格式

```typescript
interface SensorDataPoint {
  timestamp: number;      // 毫秒时间戳
  acc: {                  // 加速度（m/s²）
    x: number;
    y: number;
    z: number;
  };
  gyro: {                 // 角速度（°/s）
    x: number;
    y: number;
    z: number;
  };
}
```

### 训练样本格式

```typescript
interface TrainingSample {
  user_id: string;              // 用户ID
  label: 'fall' | 'normal';     // 标签
  source: 'simulate' | 'riding'; // 来源
  duration: number;             // 持续时间（毫秒）
  samples: SensorDataPoint[];   // 传感器数据数组
  metadata?: {                  // 元数据（可选）
    device?: string;
    os?: string;
    [key: string]: any;
  };
}
```

### 模型版本格式

```typescript
interface ModelVersion {
  version: string;        // 版本号（如 "1.2.0"）
  algorithm: string;      // 算法（random_forest/svm）
  model_url: string;      // 模型下载URL
  model_size_mb: number;  // 模型大小（MB）
  checksum: string;       // SHA-256 校验和
  accuracy: number;       // 准确率（0-1）
  f1_score: number;       // F1 分数（0-1）
  deployed_at: string;    // 部署时间（ISO 8601）
  download_count: number; // 下载次数
}
```

---

## 错误处理

### HTTP 状态码

| 状态码 | 含义 | 场景 |
|--------|------|------|
| 200 | 成功 | 请求成功 |
| 400 | 请求错误 | 数据格式错误、参数缺失 |
| 401 | 未授权 | API Key 无效 |
| 404 | 未找到 | 资源不存在 |
| 409 | 冲突 | 资源已存在、任务冲突 |
| 500 | 服务器错误 | 内部错误 |

### 错误响应格式

```json
{
  "success": false,
  "error": {
    "code": "INVALID_LABEL",
    "message": "label must be 'fall' or 'normal'",
    "details": {
      "field": "label",
      "value": "invalid_value"
    }
  }
}
```

### 小程序错误处理

```javascript
async function uploadData(data) {
  try {
    const response = await uni.request({
      url: API_URL,
      method: 'POST',
      data: data
    });

    if (response.statusCode === 200) {
      if (response.data.success) {
        return response.data;
      } else {
        throw new Error(response.data.error.message);
      }
    } else if (response.statusCode === 400) {
      uni.showToast({ title: '数据格式错误', icon: 'none' });
    } else if (response.statusCode === 401) {
      uni.showToast({ title: 'API认证失败', icon: 'none' });
    } else if (response.statusCode === 500) {
      uni.showToast({ title: '服务器错误', icon: 'none' });
    }

    throw new Error(`HTTP ${response.statusCode}`);
  } catch (error) {
    console.error('上传失败:', error);
    throw error;
  }
}
```

---

## 网络优化

### 1. 请求重试

```javascript
async function requestWithRetry(url, options, maxRetries = 3) {
  let lastError;

  for (let i = 0; i < maxRetries; i++) {
    try {
      const response = await uni.request({ url, ...options });

      if (response.statusCode === 200) {
        return response;
      }

      lastError = new Error(`HTTP ${response.statusCode}`);
    } catch (error) {
      lastError = error;
      console.warn(`请求失败，重试 ${i + 1}/${maxRetries}:`, error);

      // 等待后重试
      await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
    }
  }

  throw lastError;
}
```

### 2. 数据压缩

```javascript
// 压缩传感器数据（减少传输量）
function compressSensorData(samples) {
  // 1. 采样率降低（50Hz -> 10Hz）
  const compressed = [];
  for (let i = 0; i < samples.length; i += 5) {
    compressed.push(samples[i]);
  }

  // 2. 精度降低（保留2位小数）
  return compressed.map(s => ({
    timestamp: s.timestamp,
    acc: {
      x: parseFloat(s.acc.x.toFixed(2)),
      y: parseFloat(s.acc.y.toFixed(2)),
      z: parseFloat(s.acc.z.toFixed(2))
    },
    gyro: {
      x: parseFloat(s.gyro.x.toFixed(2)),
      y: parseFloat(s.gyro.y.toFixed(2)),
      z: parseFloat(s.gyro.z.toFixed(2))
    }
  }));
}
```

### 3. 批量上传

```javascript
class BatchUploader {
  constructor() {
    this.queue = [];
    this.batchSize = 10;
    this.uploadInterval = 60000; // 1分钟
  }

  addSample(sample) {
    this.queue.push(sample);

    if (this.queue.length >= this.batchSize) {
      this.flush();
    }
  }

  async flush() {
    if (this.queue.length === 0) return;

    const batch = this.queue.splice(0, this.batchSize);

    try {
      await this.uploadBatch(batch);
    } catch (error) {
      console.error('批量上传失败:', error);
      // 重新加入队列
      this.queue.unshift(...batch);
    }
  }

  async uploadBatch(samples) {
    // 批量上传逻辑
  }
}
```

---

## 总结

本文档详细介绍了 CycloSafe 前后端的数据交互：

- **通信协议**：HTTP/HTTPS + JSON
- **数据上传**：训练数据上传流程和格式
- **模型下载**：版本检查和增量更新机制
- **API 示例**：完整的调用示例
- **数据规范**：TypeScript 类型定义
- **错误处理**：统一的错误响应格式
- **网络优化**：重试、压缩、批量上传

**关键特性**：
- RESTful API 设计
- 版本化的模型管理
- 完善的错误处理
- 网络优化策略

**下一步**：
- [04-部署指南.md](./04-部署指南.md) - 完整部署说明
- [05-开发指南.md](./05-开发指南.md) - 开发者指南

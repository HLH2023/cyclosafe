# CycloSafe 部署指南

本文档提供 CycloSafe 系统的完整部署指南，包括小程序部署和后端服务器部署。

---

## 目录

- [系统要求](#系统要求)
- [小程序部署](#小程序部署)
- [后端部署](#后端部署)
- [配置说明](#配置说明)
- [域名和HTTPS](#域名和https)
- [监控和日志](#监控和日志)

---

## 系统要求

### 小程序端

| 项目 | 要求 |
|------|------|
| 开发工具 | HBuilderX 3.0+ |
| 微信开发者工具 | 最新稳定版 |
| Node.js | 14.0+ （可选，用于依赖管理） |
| 操作系统 | Windows / macOS / Linux |

### 后端服务器

| 项目 | 要求 |
|------|------|
| 操作系统 | Ubuntu 20.04+ / CentOS 7+ |
| Python | 3.8+ |
| MySQL | 8.0+ |
| 内存 | 2GB+ |
| 硬盘 | 20GB+ |
| CPU | 2核+ |

---

## 小程序部署

### 1. 环境准备

**安装 HBuilderX**：

1. 下载：https://www.dcloud.io/hbuilderx.html
2. 解压并运行
3. 安装 uni-app 编译器插件

**安装微信开发者工具**：

1. 下载：https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html
2. 安装并登录微信账号

---

### 2. 项目配置

#### 2.1 修改 AppID

编辑 `manifest.json`：

```json
{
  "mp-weixin": {
    "appid": "wxYOUR_APPID_HERE",
    "setting": {
      "urlCheck": false
    }
  }
}
```

**获取 AppID**：
1. 登录微信公众平台：https://mp.weixin.qq.com
2. 开发 → 开发管理 → 开发设置 → AppID

#### 2.2 配置地图 API Key（可选）

复制 `config/map.config.example.js` 为 `config/map.config.js`：

```javascript
export default {
  key: 'YOUR_TENCENT_MAP_KEY',
  defaultCenter: {
    longitude: 120.123456,
    latitude: 30.123456
  },
  defaultScale: 16
};
```

**获取腾讯地图 Key**：
1. 注册：https://lbs.qq.com/console/mykey.html
2. 创建应用 → 添加 Key → 选择"微信小程序"

#### 2.3 配置后端 API 地址（如需使用后端）

编辑 `utils/config.js`：

```javascript
export default {
  apiBaseUrl: 'https://api.cyclosafe.com',  // 后端 API 地址
  uploadEnabled: true                        // 是否启用数据上传
};
```

---

### 3. 编译和运行

#### 3.1 HBuilderX 编译

1. 打开 HBuilderX
2. 文件 → 打开目录 → 选择项目根目录
3. 运行 → 运行到小程序模拟器 → 微信开发者工具

**首次运行**：
- HBuilderX 会自动编译项目
- 微信开发者工具会自动打开
- 在微信开发者工具中登录并选择项目路径

#### 3.2 真机调试

1. 在微信开发者工具中点击"预览"
2. 用手机扫描二维码
3. 在手机上打开小程序

**注意**：
- GPS 定位需要在真机上测试
- 传感器功能（摔倒检测）只能在真机上使用

---

### 4. 发布上线

#### 4.1 上传代码

1. 在微信开发者工具中点击"上传"
2. 填写版本号和项目备注
3. 点击"上传"

#### 4.2 提交审核

1. 登录微信公众平台
2. 版本管理 → 开发版本 → 提交审核
3. 填写审核信息：
   - 功能页面：选择主要功能页面
   - 测试账号：提供测试账号（如需要）
   - 补充说明：详细描述功能和使用场景

**审核时长**：通常 1-7 个工作日

#### 4.3 发布

审核通过后：
1. 版本管理 → 审核通过版本 → 发布
2. 发布后用户即可搜索并使用

---

### 5. 版本管理

**版本号规范**：`主版本.次版本.修订号`

- **主版本**（1.x.x）：重大功能更新
- **次版本**（x.1.x）：新增功能
- **修订号**（x.x.1）：Bug 修复

**更新流程**：
1. 修改 `manifest.json` 中的 `versionName` 和 `versionCode`
2. 编译上传
3. 提交审核
4. 发布

**体验版**：用于内部测试
1. 上传代码后自动生成体验版
2. 开发者工具 → 预览 → 生成体验版二维码
3. 团队成员扫码即可使用

---

## 后端部署

### 1. 服务器准备

#### 1.1 购买服务器

推荐：
- 阿里云 ECS
- 腾讯云 CVM
- AWS EC2

配置建议：
- CPU：2核
- 内存：4GB
- 硬盘：40GB
- 带宽：3Mbps
- 操作系统：Ubuntu 20.04 LTS

#### 1.2 连接服务器

```bash
# SSH 连接
ssh root@YOUR_SERVER_IP

# 更新系统
sudo apt update
sudo apt upgrade -y
```

---

### 2. 安装依赖

#### 2.1 安装 Python 3.8+

```bash
# 检查 Python 版本
python3 --version

# 如果版本过低，安装 Python 3.8
sudo apt install python3.8 python3.8-venv python3.8-dev
```

#### 2.2 安装 MySQL

```bash
# 安装 MySQL
sudo apt install mysql-server

# 启动 MySQL
sudo systemctl start mysql
sudo systemctl enable mysql

# 安全配置
sudo mysql_secure_installation
```

**MySQL 配置**：
1. 设置 root 密码
2. 移除匿名用户
3. 禁止 root 远程登录
4. 删除测试数据库

#### 2.3 安装其他依赖

```bash
# 安装 Git
sudo apt install git

# 安装 Nginx（用于反向代理）
sudo apt install nginx

# 安装 Supervisor（进程管理）
sudo apt install supervisor
```

---

### 3. 部署后端代码

#### 3.1 克隆代码

```bash
# 创建应用目录
sudo mkdir -p /var/www/cyclosafe
cd /var/www/cyclosafe

# 克隆代码（或上传压缩包）
git clone https://github.com/your-repo/cyclosafe-backend.git .

# 设置权限
sudo chown -R www-data:www-data /var/www/cyclosafe
```

#### 3.2 创建虚拟环境

```bash
# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt
```

#### 3.3 配置环境变量

创建 `.env` 文件：

```bash
# .env
DATABASE_URL=mysql+pymysql://root:YOUR_PASSWORD@localhost:3306/fall_detection_training
ADMIN_API_KEY=YOUR_SECRET_API_KEY_HERE
MODEL_STORAGE_PATH=./models
LOG_STORAGE_PATH=./logs
API_HOST=0.0.0.0
API_PORT=8000
```

**注意**：
- 修改 `YOUR_PASSWORD` 为实际的 MySQL 密码
- 生成强密码作为 `ADMIN_API_KEY`

#### 3.4 初始化数据库

```bash
# 登录 MySQL
mysql -u root -p

# 执行初始化脚本
mysql> source /var/www/cyclosafe/backend/init_database.sql

# 退出
mysql> exit
```

**验证**：

```bash
mysql -u root -p
mysql> USE fall_detection_training;
mysql> SHOW TABLES;
# 应该看到 4 张表
```

---

### 4. 配置 Nginx 反向代理

#### 4.1 创建 Nginx 配置

```bash
sudo nano /etc/nginx/sites-available/cyclosafe
```

**配置内容**：

```nginx
server {
    listen 80;
    server_name api.cyclosafe.com;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 静态文件（模型）
    location /static/ {
        alias /var/www/cyclosafe/backend/models/;
    }
}
```

#### 4.2 启用配置

```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/cyclosafe /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
```

---

### 5. 配置 Supervisor（进程管理）

#### 5.1 创建 Supervisor 配置

```bash
sudo nano /etc/supervisor/conf.d/cyclosafe.conf
```

**配置内容**：

```ini
[program:cyclosafe]
command=/var/www/cyclosafe/backend/venv/bin/python /var/www/cyclosafe/backend/main.py
directory=/var/www/cyclosafe/backend
user=www-data
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/supervisor/cyclosafe.log
```

#### 5.2 启动服务

```bash
# 重新加载 Supervisor 配置
sudo supervisorctl reread
sudo supervisorctl update

# 启动应用
sudo supervisorctl start cyclosafe

# 检查状态
sudo supervisorctl status cyclosafe
```

**常用命令**：

```bash
# 停止
sudo supervisorctl stop cyclosafe

# 重启
sudo supervisorctl restart cyclosafe

# 查看日志
sudo tail -f /var/log/supervisor/cyclosafe.log
```

---

### 6. 配置 HTTPS（Let's Encrypt）

#### 6.1 安装 Certbot

```bash
sudo apt install certbot python3-certbot-nginx
```

#### 6.2 申请证书

```bash
# 申请证书（会自动修改 Nginx 配置）
sudo certbot --nginx -d api.cyclosafe.com

# 按提示输入邮箱并同意条款
```

#### 6.3 自动续期

```bash
# 测试续期
sudo certbot renew --dry-run

# Certbot 会自动配置定时任务
# 证书有效期 90 天，会在到期前自动续期
```

**验证 HTTPS**：

```bash
curl https://api.cyclosafe.com/api/health
```

---

## 配置说明

### 小程序配置

#### pages.json（页面路由）

```json
{
  "pages": [
    {
      "path": "pages/index/index",
      "style": {
        "navigationBarTitleText": "CycloSafe"
      }
    },
    {
      "path": "pages/riding/riding",
      "style": {
        "navigationBarTitleText": "骑行中"
      }
    }
  ],
  "tabBar": {
    "list": [
      {
        "pagePath": "pages/index/index",
        "text": "主页",
        "iconPath": "static/icons/home.png",
        "selectedIconPath": "static/icons/home-active.png"
      }
    ]
  }
}
```

#### manifest.json（应用配置）

```json
{
  "name": "CycloSafe",
  "appid": "__UNI__XXXXXXX",
  "versionName": "1.0.0",
  "versionCode": 100,
  "mp-weixin": {
    "appid": "wxYOUR_APPID",
    "setting": {
      "urlCheck": false,
      "es6": true,
      "postcss": true,
      "minified": true
    },
    "permission": {
      "scope.userLocation": {
        "desc": "用于记录骑行轨迹"
      }
    }
  }
}
```

---

### 后端配置

#### config.py（后端配置）

```python
import os
from dotenv import load_dotenv

load_dotenv()

# 数据库配置
DATABASE_URL = os.getenv(
    'DATABASE_URL',
    'mysql+pymysql://root:password@localhost:3306/fall_detection_training'
)

# API 配置
ADMIN_API_KEY = os.getenv('ADMIN_API_KEY', 'your-secret-api-key')

# 文件存储
MODEL_STORAGE_PATH = os.getenv('MODEL_STORAGE_PATH', './models')
LOG_STORAGE_PATH = os.getenv('LOG_STORAGE_PATH', './logs')

# 服务器配置
API_HOST = os.getenv('API_HOST', '0.0.0.0')
API_PORT = int(os.getenv('API_PORT', '8000'))

# 训练配置
MAX_UPLOAD_SIZE_MB = 10
SAMPLES_PER_BATCH = 1000

# 确保目录存在
os.makedirs(MODEL_STORAGE_PATH, exist_ok=True)
os.makedirs(LOG_STORAGE_PATH, exist_ok=True)
```

---

## 域名和HTTPS

### 1. 域名配置

#### 1.1 购买域名

推荐：
- 阿里云：https://wanwang.aliyun.com
- 腾讯云：https://dnspod.cloud.tencent.com
- GoDaddy：https://www.godaddy.com

#### 1.2 DNS 解析

添加 A 记录：

| 主机记录 | 记录类型 | 记录值 |
|---------|---------|--------|
| api | A | YOUR_SERVER_IP |
| @ | A | YOUR_SERVER_IP |

**等待生效**：通常 10 分钟 - 24 小时

**验证**：

```bash
ping api.cyclosafe.com
```

---

### 2. HTTPS 配置

#### 2.1 Let's Encrypt（免费）

已在前文介绍，使用 Certbot 自动配置。

#### 2.2 购买证书（可选）

如需商业证书：
- 阿里云 SSL 证书
- 腾讯云 SSL 证书
- DigiCert / Comodo

**配置步骤**：
1. 购买证书
2. 验证域名所有权
3. 下载证书文件
4. 配置 Nginx

**Nginx 配置示例**：

```nginx
server {
    listen 443 ssl;
    server_name api.cyclosafe.com;

    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;

    # ... 其他配置 ...
}

server {
    listen 80;
    server_name api.cyclosafe.com;
    return 301 https://$server_name$request_uri;
}
```

---

## 监控和日志

### 1. 应用日志

#### 后端日志

```bash
# Supervisor 日志
sudo tail -f /var/log/supervisor/cyclosafe.log

# 应用日志
tail -f /var/www/cyclosafe/backend/logs/app.log

# Nginx 日志
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

#### 日志轮转

创建 `/etc/logrotate.d/cyclosafe`：

```
/var/www/cyclosafe/backend/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 0640 www-data www-data
    sharedscripts
}
```

---

### 2. 系统监控

#### 2.1 服务器资源

```bash
# CPU 和内存
htop

# 磁盘使用
df -h

# 网络流量
iftop
```

#### 2.2 应用状态

```bash
# 检查应用状态
sudo supervisorctl status

# 检查 Nginx 状态
sudo systemctl status nginx

# 检查 MySQL 状态
sudo systemctl status mysql
```

#### 2.3 数据库监控

```bash
# 登录 MySQL
mysql -u root -p

# 查看连接数
mysql> SHOW STATUS LIKE 'Threads_connected';

# 查看慢查询
mysql> SHOW VARIABLES LIKE 'slow_query_log';
```

---

### 3. 性能优化

#### 3.1 数据库优化

```sql
-- 添加索引
CREATE INDEX idx_uploaded_at ON training_samples(uploaded_at);
CREATE INDEX idx_sample_id ON sensor_data(sample_id);

-- 优化查询
OPTIMIZE TABLE training_samples;
OPTIMIZE TABLE sensor_data;
```

#### 3.2 Nginx 优化

编辑 `/etc/nginx/nginx.conf`：

```nginx
http {
    # 启用 gzip 压缩
    gzip on;
    gzip_types text/plain application/json;

    # 连接超时
    keepalive_timeout 65;

    # 缓存
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m;
}
```

---

## 备份和恢复

### 1. 数据库备份

#### 自动备份脚本

创建 `/usr/local/bin/backup_db.sh`：

```bash
#!/bin/bash
BACKUP_DIR=/var/backups/mysql
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME=fall_detection_training

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -u root -p$MYSQL_PASSWORD $DB_NAME | gzip > $BACKUP_DIR/${DB_NAME}_${DATE}.sql.gz

# 删除 7 天前的备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +7 -delete
```

**设置定时任务**：

```bash
# 编辑 crontab
crontab -e

# 添加每天凌晨 2 点备份
0 2 * * * /usr/local/bin/backup_db.sh
```

### 2. 恢复数据库

```bash
# 解压备份
gunzip /var/backups/mysql/fall_detection_training_20251004.sql.gz

# 恢复
mysql -u root -p fall_detection_training < /var/backups/mysql/fall_detection_training_20251004.sql
```

---

## 故障排查

### 常见问题

#### 1. 小程序无法连接后端

**检查**：
- 域名是否正确解析
- 服务器防火墙是否开放端口
- HTTPS 证书是否有效
- 后端服务是否运行

```bash
# 检查端口
sudo netstat -tulpn | grep 8000

# 检查防火墙
sudo ufw status

# 测试 API
curl https://api.cyclosafe.com/api/health
```

#### 2. 数据库连接失败

**检查**：
- MySQL 是否运行
- 数据库是否创建
- 连接字符串是否正确

```bash
# 检查 MySQL
sudo systemctl status mysql

# 测试连接
mysql -u root -p -h localhost
```

#### 3. 上传数据失败

**检查**：
- API Key 是否正确
- 数据格式是否符合要求
- 服务器磁盘是否已满

```bash
# 查看日志
sudo tail -f /var/log/supervisor/cyclosafe.log

# 检查磁盘
df -h
```

---

## 总结

本文档提供了 CycloSafe 系统的完整部署指南：

**小程序部署**：
- HBuilderX 编译
- 微信开发者工具调试
- 提交审核和发布

**后端部署**：
- 服务器环境配置
- MySQL 数据库安装
- Nginx + Supervisor 部署
- HTTPS 配置
- 监控和日志

**下一步**：
- [05-开发指南.md](./05-开发指南.md) - 开发者指南
- [00-系统总览.md](./00-系统总览.md) - 返回系统总览

# 第三方依赖文档

## 概述

本项目为**纯客户端应用**，不依赖后端服务器。所有第三方依赖均为客户端SDK、工具库和API服务。本文档详细列出所有第三方套件、安装方法、配置说明和使用示例。

---

## 一、核心依赖

### 1.1 uniapp 框架

#### 基本信息
- **名称**：uni-app
- **版本要求**：>= 3.0.0
- **官网**：https://uniapp.dcloud.net.cn/
- **用途**：跨平台开发框架，支持编译为微信小程序

#### 安装方式

**方式1：HBuilderX创建项目**（推荐）
1. 打开 HBuilderX
2. 文件 -> 新建 -> 项目
3. 选择 uni-app 项目
4. 选择模板：默认模板
5. 输入项目名称：CycloSafe

**方式2：Vue CLI创建**
```bash
# 全局安装 vue-cli
npm install -g @vue/cli

# 创建 uni-app 项目
vue create -p dcloudio/uni-preset-vue cyclosafe

# 进入项目目录
cd cyclosafe

# 安装依赖
npm install
```

#### 项目配置

**package.json**
```json
{
  "name": "cyclosafe",
  "version": "1.0.0",
  "description": "骑行安全码表小程序",
  "scripts": {
    "dev:mp-weixin": "cross-env NODE_ENV=development UNI_PLATFORM=mp-weixin vue-cli-service uni-build --watch",
    "build:mp-weixin": "cross-env NODE_ENV=production UNI_PLATFORM=mp-weixin vue-cli-service uni-build"
  },
  "dependencies": {
    "@dcloudio/uni-app": "^3.0.0",
    "@dcloudio/uni-mp-weixin": "^3.0.0",
    "vue": "^3.2.0"
  },
  "devDependencies": {
    "@dcloudio/vite-plugin-uni": "^3.0.0",
    "vite": "^4.0.0"
  }
}
```

---

## 二、地图服务

### 2.1 腾讯位置服务（推荐）

#### 基本信息
- **名称**：腾讯位置服务（Tencent Location Service）
- **官网**：https://lbs.qq.com/
- **类型**：地图SDK + 定位API
- **费用**：免费额度10万次/日
- **用途**：地图显示、GPS定位、地址解析

#### 申请步骤

1. **注册账号**
   - 访问：https://lbs.qq.com/
   - 注册/登录腾讯位置服务

2. **创建应用**
   - 进入控制台
   - 点击"创建应用"
   - 应用名称：CycloSafe
   - 应用类型：微信小程序

3. **添加Key**
   - 进入应用详情
   - 点击"添加Key"
   - Key名称：CycloSafe-Key
   - 平台：微信小程序
   - 填写小程序AppID（从微信公众平台获取）

4. **获取Key**
   - 复制生成的Key：`XXXXX-XXXXX-XXXXX-XXXXX-XXXXX-XXXXX`

#### 配置方式

**manifest.json**
```json
{
  "mp-weixin": {
    "appid": "你的小程序AppID",
    "setting": {
      "urlCheck": false
    },
    "permission": {
      "scope.userLocation": {
        "desc": "用于记录骑行轨迹和提供实时位置服务"
      }
    },
    "requiredPrivateInfos": [
      "getLocation",
      "onLocationChange",
      "startLocationUpdate"
    ]
  }
}
```

**pages.json**（地图页面配置）
```json
{
  "pages": [
    {
      "path": "pages/riding/riding",
      "style": {
        "navigationBarTitleText": "骑行中",
        "enablePullDownRefresh": false
      }
    }
  ],
  "permission": {
    "scope.userLocation": {
      "desc": "用于记录骑行轨迹"
    }
  }
}
```

#### 使用示例

**基础地图**
```vue
<template>
  <map
    id="riding-map"
    :longitude="location.longitude"
    :latitude="location.latitude"
    :scale="15"
    :markers="markers"
    :polyline="polyline"
    :show-location="true"
    :enable-traffic="false"
    :enable-poi="false"
    style="width: 100%; height: 100%;"
  />
</template>

<script>
export default {
  data() {
    return {
      location: {
        longitude: 116.404,
        latitude: 39.915
      },
      markers: [],
      polyline: []
    };
  },
  onLoad() {
    this.getCurrentLocation();
  },
  methods: {
    getCurrentLocation() {
      uni.getLocation({
        type: 'gcj02',
        success: (res) => {
          this.location = {
            longitude: res.longitude,
            latitude: res.latitude
          };
        }
      });
    }
  }
};
</script>
```

**地址解析（可选功能）**
```javascript
// 使用腾讯地图API（需要引入SDK）
import QQMapWX from '@/utils/qqmap-wx-jssdk.js';

const qqmapsdk = new QQMapWX({
  key: 'XXXXX-XXXXX-XXXXX-XXXXX-XXXXX-XXXXX'
});

// 逆地址解析（坐标转地址）
qqmapsdk.reverseGeocoder({
  location: {
    latitude: 39.984154,
    longitude: 116.307490
  },
  success: (res) => {
    const address = res.result.address;
    console.log('地址:', address);
  }
});
```

#### 下载SDK（可选）
如需使用高级功能（如地址解析），需下载SDK：
- 下载地址：https://lbs.qq.com/miniProgram/jsSdk/jsSdkGuide/jsSdkOverview
- 文件：`qqmap-wx-jssdk.js`
- 放置位置：`/utils/qqmap-wx-jssdk.js`

#### 费用说明
- 免费额度：10万次/日
- 超出后：按量计费
- 本项目预计用量：< 1000次/日（远低于免费额度）

---

### 2.2 高德地图（备选方案）

#### 基本信息
- **名称**：高德地图开放平台
- **官网**：https://lbs.amap.com/
- **类型**：地图API
- **费用**：免费额度30万次/日
- **备注**：可作为腾讯地图的备选方案

#### 使用方式
与腾讯位置服务类似，微信小程序原生地图组件通用。

---

## 三、数据可视化

### 3.1 uCharts（推荐）

#### 基本信息
- **名称**：uCharts
- **版本**：>= 2.0.0
- **官网**：https://www.ucharts.cn/
- **GitHub**：https://github.com/qiun/uCharts
- **类型**：图表库
- **用途**：速度曲线图、海拔图、统计图表
- **特点**：
  - 专为 uni-app 优化
  - 体积小（约50KB）
  - 性能好
  - 支持多种图表类型

#### 安装方式

**npm 安装**
```bash
npm install @qiun/ucharts
```

**或手动下载**
1. 下载地址：https://github.com/qiun/uCharts/releases
2. 解压后将 `ucharts` 文件夹放入 `/components/` 目录

#### 配置方式

**在页面中引入组件**
```vue
<template>
  <view class="chart-container">
    <qiun-ucharts
      type="line"
      :opts="opts"
      :chartData="chartData"
      :canvas2d="true"
    />
  </view>
</template>

<script>
export default {
  data() {
    return {
      chartData: {},
      opts: {
        color: ["#1890FF", "#91CB74", "#FAC858"],
        padding: [15, 15, 0, 15],
        enableScroll: false,
        legend: {},
        xAxis: {
          disableGrid: true
        },
        yAxis: {
          data: [{ min: 0 }]
        },
        extra: {
          line: {
            type: "curve",
            width: 2
          }
        }
      }
    };
  },
  onLoad() {
    this.loadChartData();
  },
  methods: {
    loadChartData() {
      // 模拟数据
      this.chartData = {
        categories: ["0", "3", "6", "9", "12", "15"],
        series: [{
          name: "速度",
          data: [0, 15, 25, 30, 28, 20]
        }]
      };
    }
  }
};
</script>

<style>
.chart-container {
  width: 100%;
  height: 300px;
}
</style>
```

#### 图表类型

**1. 折线图（速度曲线）**
```javascript
{
  type: 'line',
  chartData: {
    categories: ['0', '3', '6', '9', '12'],
    series: [{
      name: '速度',
      data: [0, 15, 25, 30, 20]
    }]
  },
  opts: {
    extra: {
      line: {
        type: 'curve',  // 曲线
        width: 2
      }
    }
  }
}
```

**2. 区域图（海拔图）**
```javascript
{
  type: 'area',
  chartData: {
    categories: ['0', '2', '4', '6', '8'],
    series: [{
      name: '海拔',
      data: [50, 80, 120, 95, 70]
    }]
  },
  opts: {
    extra: {
      area: {
        type: 'curve',
        opacity: 0.3,
        gradient: true
      }
    }
  }
}
```

**3. 柱状图（月度统计）**
```javascript
{
  type: 'column',
  chartData: {
    categories: ['1月', '2月', '3月', '4月', '5月'],
    series: [{
      name: '距离',
      data: [120, 150, 180, 200, 170]
    }]
  }
}
```

**4. 环形图（速度分布）**
```javascript
{
  type: 'ring',
  chartData: {
    series: [{
      name: '低速',
      data: 30
    }, {
      name: '中速',
      data: 50
    }, {
      name: '高速',
      data: 20
    }]
  }
}
```

#### 优点
- ✅ 轻量级（50KB）
- ✅ 性能好
- ✅ 专为 uni-app 优化
- ✅ 文档完善

---

### 3.2 ECharts（备选方案）

#### 基本信息
- **名称**：Apache ECharts
- **版本**：>= 5.0.0
- **官网**：https://echarts.apache.org/
- **类型**：数据可视化库
- **体积**：较大（约300KB）
- **备注**：功能更强大，但体积较大，不推荐小程序使用

---

## 四、工具库

### 4.1 Day.js

#### 基本信息
- **名称**：Day.js
- **版本**：>= 1.11.0
- **官网**：https://day.js.org/
- **类型**：日期时间处理库
- **体积**：仅2KB（超轻量）
- **用途**：时间格式化、时长计算

#### 安装方式

```bash
npm install dayjs
```

#### 使用示例

```javascript
import dayjs from 'dayjs';
import duration from 'dayjs/plugin/duration';
import relativeTime from 'dayjs/plugin/relativeTime';
import 'dayjs/locale/zh-cn';

dayjs.extend(duration);
dayjs.extend(relativeTime);
dayjs.locale('zh-cn');

// 1. 格式化时间
const formatTime = (timestamp) => {
  return dayjs(timestamp).format('YYYY-MM-DD HH:mm:ss');
};

// 2. 计算时长
const formatDuration = (seconds) => {
  const dur = dayjs.duration(seconds, 'seconds');
  const hours = Math.floor(dur.asHours());
  const mins = dur.minutes();
  const secs = dur.seconds();

  return `${hours}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
};

// 3. 相对时间
const relativeTimeText = (timestamp) => {
  return dayjs(timestamp).fromNow(); // "3小时前"
};

// 使用示例
console.log(formatTime(Date.now()));           // "2025-10-02 14:32:45"
console.log(formatDuration(3665));             // "1:01:05"
console.log(relativeTimeText(Date.now() - 3600000)); // "1小时前"
```

#### 优点
- ✅ 极轻量（2KB）
- ✅ API简洁
- ✅ 支持插件扩展
- ✅ 中文友好

---

### 4.2 UUID生成（内置实现）

#### 功能说明
为骑行记录生成唯一ID。

#### 实现方式

```javascript
// utils/uuid.js
export function generateUUID() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {
    const r = (Math.random() * 16) | 0;
    const v = c === 'x' ? r : (r & 0x3) | 0x8;
    return v.toString(16);
  });
}

// 使用示例
import { generateUUID } from '@/utils/uuid.js';

const recordId = generateUUID(); // "a1b2c3d4-e5f6-4789-a012-b3c4d5e6f7g8"
```

---

### 4.3 GPX生成器（内置实现）

#### 功能说明
导出骑行轨迹为GPX格式。

#### 实现方式

```javascript
// utils/gpxExporter.js
export class GPXExporter {
  static export(record) {
    const gpxContent = this.generateGPX(record);
    return gpxContent;
  }

  static generateGPX(record) {
    const { trackPoints, startTime } = record;

    let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="CycloSafe" xmlns="http://www.topografix.com/GPX/1/1">
  <metadata>
    <name>骑行记录 ${this.formatDate(startTime)}</name>
    <time>${new Date(startTime).toISOString()}</time>
  </metadata>
  <trk>
    <name>CycloSafe Riding</name>
    <trkseg>`;

    trackPoints.forEach(point => {
      gpx += `
      <trkpt lat="${point.latitude}" lon="${point.longitude}">
        <ele>${point.altitude}</ele>
        <time>${new Date(point.timestamp).toISOString()}</time>
        <extensions>
          <speed>${point.speed}</speed>
        </extensions>
      </trkpt>`;
    });

    gpx += `
    </trkseg>
  </trk>
</gpx>`;

    return gpx;
  }

  static formatDate(timestamp) {
    const date = new Date(timestamp);
    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
  }

  // 保存为文件（小程序需要转base64）
  static saveAsFile(gpxContent, filename) {
    // 小程序环境：分享或复制到剪贴板
    uni.setClipboardData({
      data: gpxContent,
      success: () => {
        uni.showToast({
          title: 'GPX已复制到剪贴板',
          icon: 'success'
        });
      }
    });
  }
}

// 使用示例
import { GPXExporter } from '@/utils/gpxExporter.js';

const gpx = GPXExporter.export(ridingRecord);
GPXExporter.saveAsFile(gpx, 'cycling_2025-10-02.gpx');
```

---

## 五、UI组件库（可选）

### 5.1 uni-ui

#### 基本信息
- **名称**：uni-ui
- **官网**：https://uniapp.dcloud.net.cn/component/uniui/uni-ui.html
- **类型**：官方UI组件库
- **用途**：标准化UI组件
- **特点**：
  - uniapp官方维护
  - 跨平台兼容
  - 按需引入

#### 安装方式

```bash
npm install @dcloudio/uni-ui
```

#### 常用组件

**1. uni-card（卡片）**
```vue
<uni-card title="骑行记录" sub-title="2025-10-02">
  <text>距离：12.3 km</text>
</uni-card>
```

**2. uni-list（列表）**
```vue
<uni-list>
  <uni-list-item title="总距离" :right-text="totalDistance + ' km'" />
  <uni-list-item title="总时长" :right-text="totalTime" />
</uni-list>
```

**3. uni-icons（图标）**
```vue
<uni-icons type="location" size="30" color="#999" />
```

---

## 六、开发工具

### 6.1 HBuilderX

#### 基本信息
- **名称**：HBuilderX
- **版本**：>= 3.0.0
- **官网**：https://www.dcloud.io/hbuilderx.html
- **类型**：IDE
- **用途**：uni-app 开发工具

#### 下载安装
1. 访问：https://www.dcloud.io/hbuilderx.html
2. 下载标准版（免费）
3. 安装并打开

#### 配置微信开发者工具
1. HBuilderX -> 工具 -> 设置
2. 运行配置 -> 微信开发者工具路径
3. 选择微信开发者工具安装目录

---

### 6.2 微信开发者工具

#### 基本信息
- **名称**：微信开发者工具
- **版本**：>= 1.06.0
- **官网**：https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html
- **用途**：小程序调试、预览、上传

#### 下载安装
1. 访问官网下载
2. 安装并登录
3. 创建小程序项目（使用AppID）

#### 真机调试
1. 点击"预览"或"真机调试"
2. 扫描二维码
3. 在手机上测试GPS、传感器功能

---

## 七、依赖清单总结

### 7.1 必需依赖

| 名称 | 版本 | 类型 | 用途 | 费用 |
|------|------|------|------|------|
| uni-app | >= 3.0 | 框架 | 跨平台开发 | 免费 |
| 腾讯位置服务 | - | 地图API | 地图+定位 | 免费额度 |
| uCharts | >= 2.0 | 图表库 | 数据可视化 | 免费开源 |

### 7.2 可选依赖

| 名称 | 版本 | 类型 | 用途 | 费用 |
|------|------|------|------|------|
| Day.js | >= 1.11 | 工具库 | 时间处理 | 免费开源 |
| uni-ui | latest | UI库 | 标准组件 | 免费开源 |

### 7.3 开发工具

| 名称 | 版本 | 类型 | 用途 | 费用 |
|------|------|------|------|------|
| HBuilderX | >= 3.0 | IDE | 开发工具 | 免费 |
| 微信开发者工具 | >= 1.06 | 调试工具 | 小程序调试 | 免费 |

---

## 八、安装流程

### 8.1 初始化项目

```bash
# 1. 创建项目（使用HBuilderX或CLI）
# 如使用CLI：
vue create -p dcloudio/uni-preset-vue cyclosafe

# 2. 进入项目目录
cd cyclosafe

# 3. 安装依赖
npm install

# 4. 安装图表库
npm install @qiun/ucharts

# 5. 安装日期库
npm install dayjs

# 6. 安装UI组件库（可选）
npm install @dcloudio/uni-ui
```

### 8.2 配置文件

**manifest.json**
```json
{
  "name": "CycloSafe",
  "appid": "",
  "description": "骑行安全码表小程序",
  "versionName": "1.0.0",
  "versionCode": "100",
  "transformPx": false,
  "mp-weixin": {
    "appid": "你的小程序AppID",
    "setting": {
      "urlCheck": false,
      "es6": true,
      "minified": true
    },
    "permission": {
      "scope.userLocation": {
        "desc": "用于记录骑行轨迹和提供实时位置服务"
      }
    },
    "requiredPrivateInfos": [
      "getLocation",
      "onLocationChange",
      "startLocationUpdate"
    ]
  }
}
```

### 8.3 运行项目

**HBuilderX**
1. 打开项目
2. 运行 -> 运行到小程序模拟器 -> 微信开发者工具

**命令行**
```bash
npm run dev:mp-weixin
```

---

## 九、费用预估

### 9.1 腾讯位置服务

**免费额度**：10万次/日

**本项目用量估算**：
- 单次骑行：约200次定位调用
- 预计每日活跃：50人
- 每日总调用：50 × 200 = 10,000次
- **结论**：完全在免费额度内

### 9.2 其他依赖

全部开源免费，无需付费。

### 9.3 总费用

**开发阶段**：0元
**运营阶段**：0元（在免费额度内）

---

## 十、更新维护

### 10.1 依赖更新

```bash
# 检查可更新的依赖
npm outdated

# 更新依赖
npm update

# 更新指定依赖
npm update @qiun/ucharts
```

### 10.2 版本锁定

**package-lock.json**
- 锁定依赖版本
- 确保团队环境一致
- 提交到版本控制

---

## 十一、常见问题

### 11.1 地图不显示

**原因**：
- 未配置位置权限
- 未获取腾讯地图Key
- AppID配置错误

**解决**：
- 检查manifest.json配置
- 确认已授权位置权限
- 验证地图Key是否正确

### 11.2 图表不显示

**原因**：
- 组件未正确引入
- 数据格式错误
- canvas2d模式问题

**解决**：
```vue
<!-- 确保开启canvas2d -->
<qiun-ucharts :canvas2d="true" />
```

### 11.3 npm安装失败

**解决**：
```bash
# 清除缓存
npm cache clean --force

# 使用淘宝镜像
npm install --registry=https://registry.npmmirror.com

# 或使用cnpm
npm install -g cnpm
cnpm install
```

---

## 十二、参考资料

- [uni-app 官方文档](https://uniapp.dcloud.net.cn/)
- [腾讯位置服务文档](https://lbs.qq.com/miniProgram/jsSdk/jsSdkGuide/jsSdkOverview)
- [uCharts 官方文档](https://www.ucharts.cn/v2/)
- [Day.js 官方文档](https://day.js.org/)
- [微信小程序官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)

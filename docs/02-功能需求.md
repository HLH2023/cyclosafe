# 功能需求文档

## 功能概述

本项目包含三大核心功能模块：
1. **骑行码表功能** - 实时数据监测与显示
2. **安全检测功能** - 基于传感器的智能预警
3. **数据分析功能** - 历史记录与可视化

---

## 一、骑行码表功能

### 1.1 实时数据监测

#### 1.1.1 当前速度
- **功能描述**：实时显示当前骑行速度
- **数据来源**：GPS位置变化计算
- **显示单位**：km/h（可切换 mph）
- **更新频率**：1秒/次
- **UI要求**：大号字体，醒目显示

#### 1.1.2 累计距离
- **功能描述**：统计当前骑行的总距离
- **数据来源**：GPS轨迹点累加计算
- **显示单位**：km（小于1km时显示米）
- **精度要求**：小数点后2位
- **计算方式**：Haversine公式计算两点距离

#### 1.1.3 骑行时长
- **功能描述**：记录骑行总时长
- **显示格式**：HH:MM:SS
- **暂停功能**：支持暂停计时（停下休息时）
- **自动暂停**：速度为0超过30秒自动暂停

#### 1.1.4 平均速度
- **功能描述**：计算平均骑行速度
- **计算方式**：总距离 ÷ 总时长
- **显示单位**：km/h
- **排除静止**：暂停时段不计入平均速度

#### 1.1.5 最高速度
- **功能描述**：记录本次骑行最高速度
- **显示单位**：km/h
- **更新时机**：实时对比并更新

#### 1.1.6 当前海拔
- **功能描述**：显示当前海拔高度
- **数据来源**：GPS海拔数据
- **显示单位**：m（米）
- **精度要求**：整数显示

#### 1.1.7 累计爬升/下降
- **功能描述**：统计爬升和下降的总高度
- **数据来源**：海拔变化累计
- **显示单位**：m（米）
- **计算方式**：
  - 爬升：海拔上升部分累加
  - 下降：海拔下降部分累加

### 1.2 骑行控制

#### 1.2.1 开始骑行
- **功能**：开始新的骑行记录
- **操作**：点击"开始"按钮
- **系统行为**：
  - 初始化所有数据为0
  - 开始GPS定位
  - 启动传感器监听
  - 开始计时

#### 1.2.2 暂停骑行
- **功能**：临时暂停记录（休息时）
- **操作**：点击"暂停"按钮
- **系统行为**：
  - 暂停计时
  - 停止GPS更新
  - 保持当前数据
  - 可恢复

#### 1.2.3 继续骑行
- **功能**：从暂停状态恢复
- **操作**：点击"继续"按钮
- **系统行为**：
  - 继续计时
  - 恢复GPS更新
  - 继续记录轨迹

#### 1.2.4 结束骑行
- **功能**：结束本次骑行，保存数据
- **操作**：点击"结束"按钮
- **确认提示**：弹窗确认是否结束
- **系统行为**：
  - 停止所有监听
  - 保存骑行数据到本地
  - 跳转到数据分析页
  - 重置所有数据

---

## 二、地图与轨迹功能

### 2.1 实时地图显示

#### 2.1.1 地图组件
- **功能**：嵌入式地图显示
- **地图SDK**：腾讯位置服务 / 高德地图
- **默认视图**：当前位置为中心
- **缩放级别**：14-16级（适合骑行）

#### 2.1.2 当前位置标记
- **功能**：在地图上标记当前位置
- **标记样式**：蓝色圆点 + 方向箭头
- **更新频率**：1秒/次
- **跟随模式**：地图自动跟随当前位置

### 2.2 轨迹绘制

#### 2.2.1 实时轨迹
- **功能**：在地图上绘制骑行轨迹
- **显示样式**：彩色折线（渐变色）
- **颜色规则**：根据速度显示不同颜色
  - 绿色：慢速（0-15 km/h）
  - 蓝色：中速（15-25 km/h）
  - 红色：快速（>25 km/h）
- **轨迹点间隔**：5米或3秒（取较小值）

#### 2.2.2 轨迹回放
- **功能**：查看历史骑行轨迹
- **播放控制**：播放/暂停/快进
- **播放速度**：1x、2x、4x、8x
- **当前位置**：动态标记在轨迹上移动

### 2.3 轨迹数据

#### 2.3.1 轨迹点记录
- **数据结构**：
  ```javascript
  {
    latitude: number,    // 纬度
    longitude: number,   // 经度
    altitude: number,    // 海拔
    speed: number,       // 速度
    timestamp: number,   // 时间戳
    accuracy: number     // 精度
  }
  ```
- **记录频率**：1秒/次或每5米
- **存储位置**：本地storage

#### 2.3.2 轨迹导出
- **导出格式**：GPX（标准格式）
- **文件命名**：CycloSafe_YYYYMMDD_HHMMSS.gpx
- **导出方式**：
  - 保存到相册（转图片）
  - 分享到微信/文件助手
- **GPX内容**：轨迹点、海拔、时间、速度等元数据

---

## 三、安全检测功能

### 3.1 传感器数据监测

#### 3.1.1 加速度监测
- **功能**：实时监听加速度变化
- **采样频率**：20Hz（50ms/次）
- **数据处理**：平滑滤波（移动平均）
- **用途**：急刹车检测、摔倒检测

#### 3.1.2 陀螺仪监测
- **功能**：监测设备角速度变化
- **采样频率**：20Hz
- **数据处理**：姿态解算
- **用途**：摔倒检测、姿态异常

### 3.2 危险行为检测

#### 3.2.1 急刹车检测
- **触发条件**：
  - 加速度突变 > 6 m/s²
  - 速度快速下降 > 15 km/h/s
- **检测延迟**：< 200ms
- **反馈方式**：震动 + 提示音 + Toast提示
- **记录内容**：时间、位置、速度变化

#### 3.2.2 摔倒检测
- **触发条件**：
  - 加速度峰值 > 15 m/s²
  - 陀螺仪角速度 > 200°/s
  - 设备姿态剧烈变化
- **检测延迟**：< 500ms
- **反馈方式**：
  - 强震动（长震动）
  - 警告音
  - 全屏提示："检测到摔倒，是否需要帮助？"
- **自动求助**：30秒内无响应，发送位置信息

#### 3.2.3 速度预警
- **触发条件**：
  - 速度超过预设阈值（默认40 km/h）
  - 可在设置中自定义阈值
- **反馈方式**：震动 + Toast提示
- **提示内容**："当前速度过快，注意安全"

### 3.3 危险路段标记

#### 3.3.1 自动标记
- **功能**：记录发生急刹车/摔倒的位置
- **标记内容**：
  - 位置坐标
  - 时间
  - 事件类型（急刹车/摔倒）
  - 当时速度
- **地图显示**：在地图上标记危险点（红色标记）

#### 3.3.2 危险提醒
- **功能**：接近历史危险点时提醒
- **触发距离**：100米范围内
- **提示方式**：震动 + Toast
- **提示内容**：显示危险类型和距离

### 3.4 紧急功能

#### 3.4.1 紧急联系人设置
- **功能**：设置紧急联系人手机号
- **最多设置**：3个联系人
- **存储位置**：本地storage

#### 3.4.2 位置分享
- **触发方式**：
  - 检测到摔倒且无响应
  - 手动触发（紧急按钮）
- **分享内容**：
  - 当前位置（经纬度+地址）
  - 时间
  - 当前状态（摔倒检测）
- **分享方式**：复制到剪贴板 + 跳转微信

---

## 四、数据分析功能

### 4.1 单次骑行报告

#### 4.1.1 基础数据
- 骑行日期和时间
- 总距离
- 骑行时长
- 平均速度
- 最高速度
- 累计爬升/下降
- 消耗卡路里（估算）

#### 4.1.2 轨迹地图
- 完整轨迹展示
- 起点/终点标记
- 轨迹颜色编码（速度）

#### 4.1.3 数据图表
- **速度-时间曲线图**
  - X轴：时间
  - Y轴：速度（km/h）
  - 显示平均线和最高点

- **海拔-距离曲线图**
  - X轴：距离（km）
  - Y轴：海拔（m）
  - 标注爬升/下降区域

### 4.2 历史记录

#### 4.2.1 记录列表
- **显示内容**：
  - 日期时间
  - 距离
  - 时长
  - 平均速度
  - 缩略地图（轨迹预览）
- **排序方式**：按时间倒序
- **搜索功能**：按日期范围筛选
- **删除功能**：长按删除记录

#### 4.2.2 记录详情
- 点击列表项查看完整骑行报告
- 包含所有单次骑行数据
- 支持轨迹回放

### 4.3 统计数据

#### 4.3.1 总体统计
- **累计数据**：
  - 总骑行次数
  - 总距离
  - 总时长
  - 平均骑行距离
  - 最长单次距离
  - 最快速度记录

#### 4.3.2 统计图表
- **月度距离趋势图**（柱状图）
- **骑行频率统计**（日历热力图）
- **速度分布图**（饼图）

### 4.4 数据导出

#### 4.4.1 单次导出
- 导出单次骑行GPX文件
- 生成骑行报告图片（海报）

#### 4.4.2 批量导出
- 导出所有历史记录（JSON格式）
- 用于数据备份

---

## 五、设置功能

### 5.1 单位设置
- **距离单位**：公里(km) / 英里(mi)
- **速度单位**：km/h / mph
- **海拔单位**：米(m) / 英尺(ft)

### 5.2 安全设置
- **速度预警阈值**：可调节（20-60 km/h）
- **摔倒检测灵敏度**：低/中/高
- **紧急联系人管理**：添加/编辑/删除

### 5.3 地图设置
- **地图类型**：标准/卫星
- **轨迹颜色方案**：单色/速度渐变
- **危险点显示**：开启/关闭

### 5.4 数据管理
- **清除缓存**：清除临时数据
- **清空历史记录**：删除所有骑行记录（需确认）
- **导出所有数据**：备份功能

### 5.5 其他设置
- **自动暂停**：速度为0时自动暂停（开启/关闭）
- **屏幕常亮**：骑行时保持屏幕常亮（开启/关闭）
- **震动反馈**：是否启用震动（开启/关闭）

---

## 六、界面布局

### 6.1 主页面（骑行中）
```
┌─────────────────────────────┐
│        35.6 km/h            │ ← 超大号速度
│                             │
│  距离 12.3km  │  时长 1:23:45│
│  平均 28.5    │  最高 42.1   │
│  海拔 125m    │  爬升 234m   │
│                             │
│  ┌─────────────────────┐   │
│  │                     │   │
│  │   [实时地图轨迹]     │   │
│  │                     │   │
│  └─────────────────────┘   │
│                             │
│  [开始] [暂停] [结束]        │
└─────────────────────────────┘
```

### 6.2 数据分析页
```
┌─────────────────────────────┐
│      骑行报告                │
│  2025-10-02  14:32          │
│                             │
│  距离: 12.3km               │
│  时长: 1:23:45              │
│  平均: 28.5 km/h            │
│                             │
│  [速度曲线图]                │
│  [海拔曲线图]                │
│                             │
│  [轨迹地图]                  │
│                             │
│  [导出GPX] [分享]            │
└─────────────────────────────┘
```

### 6.3 历史记录页
```
┌─────────────────────────────┐
│      历史记录                │
│                             │
│  ┌──────────────────────┐  │
│  │ 2025-10-02           │  │
│  │ 12.3km  1:23:45      │  │
│  │ [缩略轨迹图]          │  │
│  └──────────────────────┘  │
│                             │
│  ┌──────────────────────┐  │
│  │ 2025-09-28           │  │
│  │ 8.5km   0:45:12      │  │
│  │ [缩略轨迹图]          │  │
│  └──────────────────────┘  │
│                             │
└─────────────────────────────┘
```

---

## 七、功能优先级

### P0（必须实现）
- ✅ 实时速度、距离、时长监测
- ✅ GPS轨迹记录
- ✅ 地图显示与轨迹绘制
- ✅ 骑行控制（开始/暂停/结束）
- ✅ 本地数据存储
- ✅ 历史记录查看

### P1（重要功能）
- ✅ 急刹车检测
- ✅ 摔倒检测
- ✅ 速度预警
- ✅ 数据图表（速度、海拔曲线）
- ✅ GPX导出

### P2（可选功能）
- ⭕ 轨迹回放
- ⭕ 危险路段标记
- ⭕ 紧急联系人求助
- ⭕ 统计图表
- ⭕ 骑行报告海报

---

## 八、性能要求

### 8.1 响应性能
- GPS定位延迟：< 3秒
- 界面更新频率：1秒/次
- 传感器响应：< 200ms
- 页面切换：< 500ms

### 8.2 电池消耗
- 骑行1小时耗电：< 20%
- GPS定位优化：使用gcj02坐标系
- 传感器优化：合理设置采样频率

### 8.3 存储要求
- 单次骑行数据：< 500KB
- 100次历史记录：< 50MB
- 图片缓存：< 100MB

### 8.4 兼容性要求
- 微信小程序基础库：>= 2.0.0
- Android系统：>= 6.0
- iOS系统：>= 10.0

# 硬件接口使用文档

## 概述

本项目充分利用微信小程序提供的硬件接口，实现骑行数据监测和安全检测功能。本文档详细说明各硬件接口的使用方法、参数配置和注意事项。

---

## 一、GPS定位接口

### 1.1 uni.getLocation()

#### 功能说明
获取当前的地理位置、速度和海拔。

#### API调用

```javascript
uni.getLocation({
  type: 'gcj02',        // 坐标系类型
  altitude: true,       // 返回海拔信息
  isHighAccuracy: true, // 开启高精度定位
  highAccuracyExpireTime: 3000, // 高精度定位超时时间
  success: (res) => {
    console.log('当前位置:', res);
    /*
    res = {
      latitude: 39.9042,      // 纬度
      longitude: 116.4074,    // 经度
      speed: 12.5,            // 速度（m/s）
      accuracy: 15,           // 精度（米）
      altitude: 50,           // 海拔（米）
      verticalAccuracy: 10,   // 垂直精度（米）
      horizontalAccuracy: 15  // 水平精度（米）
    }
    */
  },
  fail: (err) => {
    console.error('定位失败:', err);
    uni.showToast({
      title: '定位失败，请检查GPS',
      icon: 'none'
    });
  }
});
```

#### 参数说明

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| type | String | 否 | 坐标系类型：wgs84（GPS）、gcj02（国测局）<br>**推荐：gcj02** |
| altitude | Boolean | 否 | 是否返回海拔信息<br>**本项目：true** |
| isHighAccuracy | Boolean | 否 | 开启高精度定位<br>**本项目：true** |
| highAccuracyExpireTime | Number | 否 | 高精度定位超时时间（ms）<br>**本项目：3000** |

#### 返回值说明

| 字段 | 类型 | 说明 |
|------|------|------|
| latitude | Number | 纬度（-90 ~ 90） |
| longitude | Number | 经度（-180 ~ 180） |
| speed | Number | 速度（m/s） |
| accuracy | Number | 位置精度（米） |
| altitude | Number | 海拔（米） |

#### 使用场景
- 初始定位（开始骑行时）
- 获取当前位置信息
- 单次位置查询

#### 注意事项
1. ⚠️ 需要用户授权位置权限
2. ⚠️ iOS系统需要在manifest.json中配置权限描述
3. ⚠️ 室内定位精度较低（20-50米）
4. ⚠️ 首次定位可能需要3-10秒

---

### 1.2 uni.startLocationUpdate()

#### 功能说明
开启小程序实时定位，持续监听位置变化。

#### API调用

```javascript
// 1. 开启持续定位
uni.startLocationUpdate({
  type: 'gcj02',
  success: (res) => {
    console.log('持续定位已开启');

    // 2. 监听位置变化
    uni.onLocationChange((location) => {
      console.log('位置更新:', location);
      /*
      location = {
        latitude: 39.9042,
        longitude: 116.4074,
        speed: 12.5,      // m/s
        accuracy: 15,     // 米
        altitude: 50,     // 米
        verticalAccuracy: 10,
        horizontalAccuracy: 15
      }
      */

      // 处理位置数据
      handleLocationUpdate(location);
    });
  },
  fail: (err) => {
    console.error('持续定位开启失败:', err);
  }
});

// 3. 停止持续定位
function stopTracking() {
  uni.stopLocationUpdate({
    success: () => {
      console.log('持续定位已停止');

      // 移除监听
      uni.offLocationChange();
    }
  });
}
```

#### 参数说明

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| type | String | 否 | 坐标系类型：gcj02（推荐） |

#### 更新频率
- **Android**: 1秒/次
- **iOS**: 1秒/次（根据位置变化）

#### 使用场景
- 骑行中持续定位
- 实时轨迹记录
- 速度实时监测

#### 注意事项
1. ⚠️ 持续定位会持续消耗电量
2. ⚠️ 暂停时应停止定位以节省电量
3. ⚠️ 必须主动调用 `stopLocationUpdate` 停止定位
4. ⚠️ 回调频率由系统决定，建议做节流处理

#### 优化建议

```javascript
// 节流处理（避免过于频繁）
let lastUpdateTime = 0;
const UPDATE_INTERVAL = 3000; // 3秒更新一次

uni.onLocationChange((location) => {
  const now = Date.now();
  if (now - lastUpdateTime < UPDATE_INTERVAL) {
    return; // 跳过本次更新
  }

  lastUpdateTime = now;
  handleLocationUpdate(location);
});

// 精度过滤
function handleLocationUpdate(location) {
  // 过滤低精度数据
  if (location.accuracy > 50) {
    console.warn('定位精度过低，忽略此次数据');
    return;
  }

  // 处理有效数据
  processLocation(location);
}
```

---

## 二、加速度计接口

### 2.1 uni.startAccelerometer()

#### 功能说明
监听加速度数据，包含x、y、z三个轴的加速度分量。

#### API调用

```javascript
// 1. 开启加速度监听
uni.startAccelerometer({
  interval: 'game', // 采样频率
  success: () => {
    console.log('加速度计已开启');

    // 2. 监听加速度变化
    uni.onAccelerometerChange((res) => {
      console.log('加速度:', res);
      /*
      res = {
        x: 0.5,  // x轴加速度
        y: 0.2,  // y轴加速度
        z: 9.8   // z轴加速度（包含重力加速度）
      }
      */

      // 处理加速度数据
      handleAccelerometerData(res);
    });
  },
  fail: (err) => {
    console.error('加速度计开启失败:', err);
  }
});

// 3. 停止监听
function stopAccelerometer() {
  uni.stopAccelerometer({
    success: () => {
      console.log('加速度计已停止');
    }
  });
}
```

#### 参数说明

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| interval | String | 否 | 监听频率<br>- `game`: 20ms/次（适合游戏）<br>- `ui`: 60ms/次（适合UI）<br>- `normal`: 200ms/次（普通）<br>**本项目：game** |

#### 返回值说明

| 字段 | 类型 | 说明 |
|------|------|------|
| x | Number | x轴加速度（m/s²） |
| y | Number | y轴加速度（m/s²） |
| z | Number | z轴加速度（m/s²，包含重力） |

#### 坐标系说明

```
         z (竖直向上)
         │
         │
         │
         └────── x (设备右侧)
        /
       /
      y (设备前方)
```

- **x轴**：设备左右方向（右为正）
- **y轴**：设备前后方向（前为正）
- **z轴**：设备上下方向（上为正，包含重力9.8m/s²）

#### 使用场景
- 急刹车检测
- 摔倒检测（配合陀螺仪）
- 骑行姿态分析

#### 数据处理示例

```javascript
// 1. 计算总加速度
function calculateTotalAcceleration(x, y, z) {
  return Math.sqrt(x * x + y * y + z * z);
}

// 2. 移动平均滤波（平滑数据）
class AccelerometerFilter {
  constructor(windowSize = 5) {
    this.bufferX = [];
    this.bufferY = [];
    this.bufferZ = [];
    this.windowSize = windowSize;
  }

  filter(x, y, z) {
    this.bufferX.push(x);
    this.bufferY.push(y);
    this.bufferZ.push(z);

    if (this.bufferX.length > this.windowSize) {
      this.bufferX.shift();
      this.bufferY.shift();
      this.bufferZ.shift();
    }

    return {
      x: this.average(this.bufferX),
      y: this.average(this.bufferY),
      z: this.average(this.bufferZ)
    };
  }

  average(arr) {
    return arr.reduce((a, b) => a + b, 0) / arr.length;
  }
}

// 3. 急刹车检测
let lastAcceleration = null;

function detectHardBraking(acceleration) {
  if (!lastAcceleration) {
    lastAcceleration = acceleration;
    return false;
  }

  // 计算加速度变化
  const deltaAcc = Math.abs(
    calculateTotalAcceleration(acceleration.x, acceleration.y, acceleration.z) -
    calculateTotalAcceleration(lastAcceleration.x, lastAcceleration.y, lastAcceleration.z)
  );

  lastAcceleration = acceleration;

  // 阈值判断
  const HARD_BRAKING_THRESHOLD = 6; // m/s²
  return deltaAcc > HARD_BRAKING_THRESHOLD;
}

// 使用示例
const filter = new AccelerometerFilter(5);

uni.onAccelerometerChange((res) => {
  // 滤波
  const filtered = filter.filter(res.x, res.y, res.z);

  // 检测急刹车
  if (detectHardBraking(filtered)) {
    uni.showToast({
      title: '检测到急刹车',
      icon: 'none'
    });
    uni.vibrateShort();
  }
});
```

#### 注意事项
1. ⚠️ z轴包含重力加速度（约9.8m/s²）
2. ⚠️ 数据噪声较大，需要滤波处理
3. ⚠️ 不同设备灵敏度可能不同
4. ⚠️ 高频采样会增加电量消耗

---

## 三、陀螺仪接口

### 3.1 uni.startGyroscope()

#### 功能说明
监听陀螺仪数据，获取设备的角速度。

#### API调用

```javascript
// 1. 开启陀螺仪
uni.startGyroscope({
  interval: 'game',
  success: () => {
    console.log('陀螺仪已开启');

    // 2. 监听陀螺仪变化
    uni.onGyroscopeChange((res) => {
      console.log('陀螺仪:', res);
      /*
      res = {
        x: 0.5,  // x轴角速度（°/s）
        y: 0.2,  // y轴角速度（°/s）
        z: 0.1   // z轴角速度（°/s）
      }
      */

      handleGyroscopeData(res);
    });
  },
  fail: (err) => {
    console.error('陀螺仪开启失败:', err);
  }
});

// 3. 停止监听
function stopGyroscope() {
  uni.stopGyroscope({
    success: () => {
      console.log('陀螺仪已停止');
    }
  });
}
```

#### 参数说明

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| interval | String | 否 | 监听频率<br>- `game`: 20ms/次<br>- `ui`: 60ms/次<br>- `normal`: 200ms/次<br>**本项目：game** |

#### 返回值说明

| 字段 | 类型 | 说明 |
|------|------|------|
| x | Number | 绕x轴旋转的角速度（°/s） |
| y | Number | 绕y轴旋转的角速度（°/s） |
| z | Number | 绕z轴旋转的角速度（°/s） |

#### 使用场景
- 摔倒检测（检测剧烈翻转）
- 姿态变化监测
- 配合加速度计提高检测精度

#### 摔倒检测示例

```javascript
// 摔倒检测算法
class FallDetector {
  constructor() {
    this.accelerometerData = { x: 0, y: 0, z: 0 };
    this.gyroscopeData = { x: 0, y: 0, z: 0 };
  }

  updateAccelerometer(data) {
    this.accelerometerData = data;
  }

  updateGyroscope(data) {
    this.gyroscopeData = data;
  }

  detect() {
    // 1. 计算加速度总量
    const totalAcc = Math.sqrt(
      this.accelerometerData.x ** 2 +
      this.accelerometerData.y ** 2 +
      this.accelerometerData.z ** 2
    );

    // 2. 计算角速度总量
    const totalGyro = Math.sqrt(
      this.gyroscopeData.x ** 2 +
      this.gyroscopeData.y ** 2 +
      this.gyroscopeData.z ** 2
    );

    // 3. 阈值判断
    const ACC_THRESHOLD = 15;   // 加速度阈值（m/s²）
    const GYRO_THRESHOLD = 200; // 角速度阈值（°/s）

    const isFalling =
      totalAcc > ACC_THRESHOLD &&
      totalGyro > GYRO_THRESHOLD;

    if (isFalling) {
      this.onFallDetected();
    }

    return isFalling;
  }

  onFallDetected() {
    console.warn('检测到摔倒！');

    // 震动警告
    uni.vibrateLong();

    // 显示提示
    uni.showModal({
      title: '摔倒检测',
      content: '检测到摔倒，是否需要帮助？',
      success: (res) => {
        if (res.confirm) {
          // 发送求助
          this.sendHelpRequest();
        }
      }
    });
  }

  sendHelpRequest() {
    // 获取当前位置并分享
    uni.getLocation({
      success: (location) => {
        const message = `紧急求助！位置：${location.latitude}, ${location.longitude}`;
        console.log(message);

        // 复制到剪贴板
        uni.setClipboardData({
          data: message,
          success: () => {
            uni.showToast({
              title: '位置已复制，可发送给紧急联系人',
              icon: 'none',
              duration: 3000
            });
          }
        });
      }
    });
  }
}

// 使用示例
const fallDetector = new FallDetector();

uni.onAccelerometerChange((res) => {
  fallDetector.updateAccelerometer(res);
  fallDetector.detect();
});

uni.onGyroscopeChange((res) => {
  fallDetector.updateGyroscope(res);
  fallDetector.detect();
});
```

#### 注意事项
1. ⚠️ 必须与加速度计配合使用
2. ⚠️ 灵敏度需要根据实际测试调整
3. ⚠️ 避免误检测（如急转弯）

---

## 四、罗盘（指南针）接口

### 4.1 uni.startCompass()

#### 功能说明
监听罗盘数据，获取设备朝向。

#### API调用

```javascript
// 1. 开启罗盘
uni.startCompass({
  success: () => {
    console.log('罗盘已开启');

    // 2. 监听方向变化
    uni.onCompassChange((res) => {
      console.log('方向:', res);
      /*
      res = {
        direction: 120,  // 方向角（0-360°，0为正北）
        accuracy: 5      // 精度（iOS独有）
      }
      */

      handleCompassData(res);
    });
  },
  fail: (err) => {
    console.error('罗盘开启失败:', err);
  }
});

// 3. 停止监听
function stopCompass() {
  uni.stopCompass({
    success: () => {
      console.log('罗盘已停止');
    }
  });
}
```

#### 返回值说明

| 字段 | 类型 | 说明 |
|------|------|------|
| direction | Number | 方向角（0-360°）<br>0°=正北，90°=正东，180°=正南，270°=正西 |
| accuracy | Number | 精度（仅iOS，Android恒为0） |

#### 方向显示示例

```javascript
// 方向名称转换
function getDirectionName(degree) {
  const directions = [
    { name: '北', range: [0, 22.5] },
    { name: '东北', range: [22.5, 67.5] },
    { name: '东', range: [67.5, 112.5] },
    { name: '东南', range: [112.5, 157.5] },
    { name: '南', range: [157.5, 202.5] },
    { name: '西南', range: [202.5, 247.5] },
    { name: '西', range: [247.5, 292.5] },
    { name: '西北', range: [292.5, 337.5] },
    { name: '北', range: [337.5, 360] }
  ];

  for (const dir of directions) {
    if (degree >= dir.range[0] && degree < dir.range[1]) {
      return dir.name;
    }
  }

  return '北';
}

// 使用示例
uni.onCompassChange((res) => {
  const directionName = getDirectionName(res.direction);
  console.log(`当前朝向：${directionName} (${res.direction.toFixed(1)}°)`);

  // 更新UI
  updateDirectionUI(res.direction, directionName);
});

// 方向箭头旋转（UI）
function updateDirectionUI(degree, name) {
  // 旋转箭头
  const arrow = document.querySelector('.direction-arrow');
  if (arrow) {
    arrow.style.transform = `rotate(${degree}deg)`;
  }

  // 显示方向名
  const label = document.querySelector('.direction-label');
  if (label) {
    label.textContent = name;
  }
}
```

#### 使用场景
- 显示骑行方向
- 地图方向指示
- 轨迹方向标注

#### 注意事项
1. ⚠️ 需要设备支持磁力计（指南针）
2. ⚠️ 金属物体会影响精度
3. ⚠️ 室内精度较低
4. ⚠️ 需要定期校准

---

## 五、震动反馈接口

### 5.1 uni.vibrateLong() / uni.vibrateShort()

#### 功能说明
触发设备震动反馈。

#### API调用

```javascript
// 短震动（约15ms）
uni.vibrateShort({
  type: 'heavy', // 震动强度（仅iOS）
  success: () => {
    console.log('短震动已触发');
  }
});

// 长震动（约400ms）
uni.vibrateLong({
  success: () => {
    console.log('长震动已触发');
  }
});
```

#### 参数说明（vibrateShort）

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| type | String | 否 | 震动强度（仅iOS）<br>- `heavy`: 重<br>- `medium`: 中<br>- `light`: 轻 |

#### 使用场景

```javascript
// 1. 急刹车提醒
function onHardBraking() {
  uni.vibrateShort({ type: 'medium' });
  showToast('检测到急刹车');
}

// 2. 摔倒警告
function onFallDetected() {
  uni.vibrateLong(); // 长震动更明显
  showModal('检测到摔倒！');
}

// 3. 速度预警
function onSpeedWarning() {
  uni.vibrateShort({ type: 'light' });
  showToast('速度过快，注意安全');
}

// 4. 危险路段提醒
function onDangerZone() {
  // 连续震动两次
  uni.vibrateShort({ type: 'heavy' });
  setTimeout(() => {
    uni.vibrateShort({ type: 'heavy' });
  }, 200);
  showToast('前方危险路段');
}
```

#### 注意事项
1. ⚠️ 用户可能在设置中关闭震动
2. ⚠️ 不要过度使用，影响用户体验
3. ⚠️ Android不支持type参数

---

## 六、权限管理

### 6.1 位置权限

#### manifest.json配置

```json
{
  "mp-weixin": {
    "permission": {
      "scope.userLocation": {
        "desc": "用于记录骑行轨迹和提供实时位置服务"
      }
    },
    "requiredPrivateInfos": [
      "getLocation",
      "onLocationChange",
      "startLocationUpdate",
      "chooseLocation"
    ]
  }
}
```

#### 权限申请

```javascript
// 检查并申请位置权限
function requestLocationPermission() {
  return new Promise((resolve, reject) => {
    // 1. 检查权限状态
    uni.getSetting({
      success: (res) => {
        if (res.authSetting['scope.userLocation']) {
          // 已授权
          resolve(true);
        } else {
          // 2. 申请权限
          uni.authorize({
            scope: 'scope.userLocation',
            success: () => {
              resolve(true);
            },
            fail: () => {
              // 3. 引导用户打开设置
              uni.showModal({
                title: '需要位置权限',
                content: '请在设置中开启位置权限，以使用骑行功能',
                confirmText: '去设置',
                success: (modalRes) => {
                  if (modalRes.confirm) {
                    uni.openSetting({
                      success: (settingRes) => {
                        if (settingRes.authSetting['scope.userLocation']) {
                          resolve(true);
                        } else {
                          reject(new Error('用户拒绝授权'));
                        }
                      }
                    });
                  } else {
                    reject(new Error('用户拒绝授权'));
                  }
                }
              });
            }
          });
        }
      }
    });
  });
}

// 使用示例
async function startRiding() {
  try {
    await requestLocationPermission();
    // 开始骑行
    uni.startLocationUpdate();
  } catch (err) {
    uni.showToast({
      title: '需要位置权限才能使用',
      icon: 'none'
    });
  }
}
```

---

## 七、性能优化建议

### 7.1 节流与防抖

```javascript
// 节流函数
function throttle(fn, delay) {
  let lastTime = 0;
  return function(...args) {
    const now = Date.now();
    if (now - lastTime >= delay) {
      lastTime = now;
      fn.apply(this, args);
    }
  };
}

// 使用示例
const handleLocationUpdate = throttle((location) => {
  // 处理位置更新
  console.log('位置更新:', location);
}, 3000); // 3秒最多执行一次

uni.onLocationChange(handleLocationUpdate);
```

### 7.2 动态采样率

```javascript
// 根据速度调整GPS采样间隔
function adjustGPSSamplingRate(speed) {
  // 速度越快，采样越频繁
  if (speed < 10) {
    return 5000; // 慢速：5秒
  } else if (speed < 25) {
    return 3000; // 中速：3秒
  } else {
    return 1000; // 快速：1秒
  }
}
```

### 7.3 暂停时停止传感器

```javascript
function pauseRiding() {
  // 停止所有传感器
  uni.stopLocationUpdate();
  uni.stopAccelerometer();
  uni.stopGyroscope();
  uni.stopCompass();

  console.log('传感器已全部停止，节省电量');
}

function resumeRiding() {
  // 恢复传感器
  uni.startLocationUpdate();
  uni.startAccelerometer({ interval: 'game' });
  uni.startGyroscope({ interval: 'game' });
  uni.startCompass();

  console.log('传感器已全部恢复');
}
```

---

## 八、常见问题与解决方案

### 8.1 GPS定位失败

**原因**：
- GPS未开启
- 位置权限未授权
- 室内信号弱

**解决方案**：
```javascript
uni.getLocation({
  fail: (err) => {
    if (err.errMsg.includes('auth deny')) {
      // 权限被拒绝
      uni.showModal({
        title: '需要位置权限',
        content: '请在设置中开启位置权限'
      });
    } else if (err.errMsg.includes('timeout')) {
      // 定位超时
      uni.showToast({
        title: '定位超时，请到室外尝试',
        icon: 'none'
      });
    } else {
      // 其他错误
      console.error('定位失败:', err);
    }
  }
});
```

### 8.2 传感器数据异常

**原因**：
- 设备不支持
- 数据噪声大
- 坐标系理解错误

**解决方案**：
```javascript
// 检查设备支持
uni.startAccelerometer({
  fail: (err) => {
    if (err.errMsg.includes('not support')) {
      uni.showToast({
        title: '您的设备不支持加速度计',
        icon: 'none'
      });
    }
  }
});

// 数据滤波
const filter = new MovingAverageFilter(5);
uni.onAccelerometerChange((res) => {
  const filtered = filter.filter(res.x, res.y, res.z);
  // 使用滤波后的数据
});
```

---

## 九、测试建议

### 9.1 真机测试清单

- ✅ GPS定位精度测试（室外）
- ✅ 持续定位电量消耗测试
- ✅ 加速度计灵敏度测试
- ✅ 陀螺仪数据准确性测试
- ✅ 急刹车检测准确率测试
- ✅ 摔倒检测误报率测试
- ✅ 不同设备兼容性测试

### 9.2 测试工具

```javascript
// 传感器数据监控工具
class SensorMonitor {
  constructor() {
    this.logs = [];
  }

  log(type, data) {
    this.logs.push({
      type,
      data,
      timestamp: Date.now()
    });

    // 保持最近1000条记录
    if (this.logs.length > 1000) {
      this.logs.shift();
    }
  }

  export() {
    // 导出为JSON
    const json = JSON.stringify(this.logs, null, 2);
    console.log(json);
    return json;
  }
}

// 使用示例
const monitor = new SensorMonitor();

uni.onLocationChange((res) => {
  monitor.log('location', res);
});

uni.onAccelerometerChange((res) => {
  monitor.log('accelerometer', res);
});
```

---

## 十、参考资料

- [微信小程序官方文档 - 位置](https://developers.weixin.qq.com/miniprogram/dev/api/location/wx.getLocation.html)
- [微信小程序官方文档 - 设备](https://developers.weixin.qq.com/miniprogram/dev/api/device/accelerometer/wx.startAccelerometer.html)
- [uniapp官方文档 - 位置](https://uniapp.dcloud.net.cn/api/location/location.html)
- [uniapp官方文档 - 设备](https://uniapp.dcloud.net.cn/api/system/accelerometer.html)

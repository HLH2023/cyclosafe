# 摔倒检测功能说明

## 功能概述

本项目实现了基于加速度计和陀螺仪的摔倒检测功能，可在骑行过程中实时监测用户是否摔倒，并提供自动求助功能。

---

## 技术实现

### 算法类型
**基于阈值的检测算法**（Threshold-based Detection）

### 检测原理

摔倒检测通过以下三个关键特征进行综合判断：

1. **高加速度峰值**：摔倒时设备会产生剧烈的加速度变化
2. **高角速度**：摔倒时设备会发生快速翻转
3. **冲击特征**：检测加速度的突然峰值

### 核心参数

| 灵敏度 | 加速度阈值 | 角速度阈值 | 适用场景 |
|--------|-----------|-----------|---------|
| 低 | 25 m/s² (~2.5g) | 250°/s | 适合平稳路况，减少误报 |
| 中 | 18 m/s² (~1.8g) | 200°/s | **推荐设置**，平衡准确率和误报率 |
| 高 | 15 m/s² (~1.5g) | 150°/s | 适合需要高灵敏度的场景 |

---

## 使用说明

### 1. 启用摔倒检测

#### 方法一：设置页面配置（推荐）
1. 进入"设置"页面
2. 找到"安全设置"板块
3. 开启"摔倒检测"开关
4. 选择合适的灵敏度（默认：中灵敏度）

#### 方法二：代码配置
```javascript
// 在本地存储中设置
uni.setStorageSync('fallDetectionEnabled', 'true');
uni.setStorageSync('fallDetectionSensitivity', 'medium'); // low/medium/high
```

### 2. 摔倒检测流程

```
开始骑行
    ↓
启动传感器服务
    ↓
实时监测加速度和角速度
    ↓
检测到疑似摔倒
    ↓
震动警告 + 弹窗提示
    ↓
30秒倒计时
    ↓
┌─────────────┬─────────────┐
│  用户点击   │   超时无响应  │
│ "我没事"    │  自动发送求助 │
└─────────────┴─────────────┘
```

### 3. 摔倒警告弹窗

检测到摔倒后，会显示以下弹窗：

```
⚠️ 摔倒检测

检测到摔倒，是否需要帮助？
30秒后自动发送位置信息

[我没事]  [需要帮助]
```

- **点击"我没事"**：取消求助，继续骑行
- **点击"需要帮助"**：立即发送位置信息
- **无响应（30秒）**：自动发送位置信息

### 4. 紧急求助信息

自动发送的求助信息包含：
- 当前时间
- 精确位置（经纬度）
- 骑行数据（距离、速度、时长）

示例：
```
紧急求助！
时间：2025-10-02 14:32:15
位置：纬度 39.904200, 经度 116.407400
骑行信息：
- 距离：12.35 KM
- 速度：25.3 KM/H
- 时长：1:23:45

请尽快联系我！
```

位置信息会自动复制到剪贴板，方便发送给紧急联系人。

---

## 代码结构

### 文件说明

```
services/
  └── sensorService.js          # 传感器服务核心代码
      ├── MovingAverageFilter   # 移动平均滤波器（降噪）
      ├── FallDetector          # 摔倒检测器
      └── SensorService         # 传感器服务管理

pages/
  ├── riding/riding.vue         # 骑行页面（集成摔倒检测）
  └── settings/settings.vue     # 设置页面（配置灵敏度）
```

### 关键类

#### 1. MovingAverageFilter - 数据滤波器
```javascript
// 功能：平滑传感器数据，减少噪声
const filter = new MovingAverageFilter(5); // 窗口大小5
const smoothed = filter.filter(x, y, z);
```

#### 2. FallDetector - 摔倒检测器
```javascript
// 功能：检测摔倒事件
const detector = new FallDetector({
  sensitivity: 'medium',      // 灵敏度
  enabled: true,              // 是否启用
  onFallDetected: (data) => { // 回调函数
    console.log('检测到摔倒', data);
  }
});

// 更新传感器数据
detector.updateAccelerometer({ x, y, z });
detector.updateGyroscope({ x, y, z });

// 执行检测
detector.detect();
```

#### 3. SensorService - 传感器服务
```javascript
import sensorService from '@/services/sensorService.js';

// 启动服务
sensorService.start({
  fallDetectionEnabled: true,
  sensitivity: 'medium'
});

// 设置回调
sensorService.onFallDetected((data) => {
  handleFallDetected(data);
});

// 停止服务
sensorService.stop();
```

---

## 注意事项

### 1. 传感器权限
摔倒检测需要使用加速度计和陀螺仪，这些传感器在微信小程序中**无需用户授权**即可使用。

### 2. 电量消耗
- 传感器采样频率：20ms/次（game模式）
- 建议在暂停骑行时停止传感器服务以节省电量
- 预计电量消耗：每小时约 3-5%

### 3. 误报处理

#### 常见误报场景：
- ❌ 急转弯
- ❌ 过减速带
- ❌ 急刹车
- ❌ 将手机扔在座位上

#### 减少误报的方法：
1. 降低灵敏度（改为"低灵敏度"）
2. 手机固定在车把上（避免晃动）
3. 调整阈值参数（开发者可修改 `sensorService.js` 中的阈值）

### 4. 漏报处理

如果真实摔倒未被检测到：
1. 提高灵敏度（改为"高灵敏度"）
2. 检查手机是否固定牢固
3. 提交反馈以帮助改进算法

### 5. 冷却时间

检测到摔倒后，有 **5秒冷却时间**，期间不会重复检测。这是为了：
- 避免同一次摔倒触发多次警报
- 减少误报

---

## 测试建议

### 真机测试清单

- [ ] 正常骑行不触发（平稳路面）
- [ ] 急刹车不触发（或可接受的误报率）
- [ ] 急转弯不触发
- [ ] 模拟摔倒场景能够检测到
- [ ] 警告弹窗正常显示
- [ ] 倒计时功能正常
- [ ] 位置信息正确获取
- [ ] 不同灵敏度设置有效

### 测试场景

#### 1. 模拟摔倒测试
**方法**：将手机放在厚垫子上，从约1米高度自由落下（⚠️ 注意安全）

**预期**：应该触发摔倒检测

#### 2. 日常场景测试
- 走路/跑步时携带手机
- 骑车正常转弯
- 骑车经过减速带
- 骑车急刹车

**预期**：不应触发误报（或误报率 < 5%）

---

## 后续优化方向

### 短期优化（1-2周）
- [ ] 收集真实骑行数据
- [ ] 统计误报率和漏报率
- [ ] 根据数据调整阈值参数
- [ ] 添加数据记录功能（用于训练）

### 长期优化（1-2个月）
- [ ] 使用公开数据集训练机器学习模型
- [ ] 集成 TensorFlow.js 进行推理
- [ ] 提升准确率到 95%+
- [ ] 减少误报率到 < 1%

---

## API文档

### sensorService

#### `start(options)`
启动传感器服务

**参数：**
```javascript
{
  fallDetectionEnabled: true,  // 是否启用摔倒检测
  sensitivity: 'medium'        // 灵敏度：'low' | 'medium' | 'high'
}
```

#### `stop()`
停止传感器服务

#### `onFallDetected(callback)`
设置摔倒检测回调

**回调参数：**
```javascript
{
  acceleration: 18.5,          // 总加速度 (m/s²)
  gyroscope: 215.3,            // 总角速度 (°/s)
  timestamp: 1696230735000,    // 时间戳
  sensitivity: 'medium'        // 当前灵敏度
}
```

#### `setSensitivity(sensitivity)`
动态设置灵敏度

**参数：** `'low' | 'medium' | 'high'`

#### `setFallDetectionEnabled(enabled)`
启用/禁用摔倒检测

**参数：** `boolean`

#### `getStatus()`
获取当前状态

**返回：**
```javascript
{
  isRunning: true,             // 服务是否运行中
  fallDetectionEnabled: true,  // 摔倒检测是否启用
  sensitivity: 'medium'        // 当前灵敏度
}
```

---

## 常见问题 FAQ

### Q1: 摔倒检测可以在后台运行吗？
**A:** 微信小程序对后台运行有限制，建议保持屏幕常亮以确保检测正常工作。

### Q2: 可以自定义阈值吗？
**A:** 可以，修改 `services/sensorService.js` 中 `FallDetector` 类的 `updateThresholds()` 方法。

### Q3: 检测延迟是多少？
**A:** 传感器采样频率为 20ms/次，检测延迟小于 500ms。

### Q4: 支持哪些手机？
**A:** 支持所有带有加速度计和陀螺仪的智能手机（iOS 10+ / Android 6+）。

### Q5: 如何调试传感器数据？
**A:** 在 `sensorService.js` 中取消注释 `console.log` 语句，查看实时传感器数据。

---

## 参考文献

1. Bourke, A. K., & Lyons, G. M. (2008). *A threshold-based fall-detection algorithm using a bi-axial gyroscope sensor*. Medical Engineering & Physics.

2. Kangas, M., et al. (2012). *Comparison of real-world fall detection algorithms using accelerometer data*. Gait & Posture.

3. Huynh, Q. T., et al. (2015). *Optimization of an Accelerometer and Gyroscope-Based Fall Detection Algorithm*. Journal of Sensors.

4. [微信小程序官方文档 - 加速度计](https://developers.weixin.qq.com/miniprogram/dev/api/device/accelerometer/wx.startAccelerometer.html)

5. [微信小程序官方文档 - 陀螺仪](https://developers.weixin.qq.com/miniprogram/dev/api/device/gyroscope/wx.startGyroscope.html)

---

## 版本历史

### v1.0.0 (2025-10-02)
- ✅ 实现基于阈值的摔倒检测算法
- ✅ 支持三档灵敏度调节（低/中/高）
- ✅ 集成数据滤波器（移动平均）
- ✅ 实现摔倒警告弹窗
- ✅ 实现30秒倒计时自动求助
- ✅ 位置信息自动获取和分享
- ✅ 设置页面灵敏度配置
- ✅ 暂停时自动停止传感器（节省电量）

---

## 联系方式

如有问题或建议，请提交 Issue 或 Pull Request。
